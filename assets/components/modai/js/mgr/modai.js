!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.modAI=t():e.modAI=t()}(self,(()=>(()=>{"use strict";var e={d:(t,n)=>{for(var o in n)e.o(n,o)&&!e.o(t,o)&&Object.defineProperty(t,o,{enumerable:!0,get:n[o]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t),r:e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})}},t={};e.r(t),e.d(t,{chatHistory:()=>g,executor:()=>r,history:()=>d,ui:()=>Y,window:()=>ne});const n={buffered:{chatgpt:{content:e=>{const t=e?.choices?.[0]?.message?.content;if(!t)throw new Error(_("modai.cmp.failed_request"));return{id:e.id,content:t}},image:e=>{const t=e?.data?.[0]?.url;if(!t)throw new Error(_("modai.cmp.failed_request"));return{url:t}}},claude:{content:e=>{const t=e?.content?.[0]?.text;if(!t)throw new Error(_("modai.cmp.failed_request"));return{id:e.id,content:t}}},gemini:{content:e=>{const t=e?.candidates?.[0]?.content?.parts?.[0]?.text;if(!t)throw new Error(_("modai.cmp.failed_request"));return{id:`gemini-${Date.now()}-${Math.round(1e3*Math.random())}`,content:t}},image:e=>{const t=e?.predictions?.[0]?.bytesBase64Encoded;if(!t)throw new Error(_("modai.cmp.failed_request"));return{base64:`data:image/png;base64,${t}`}}}},stream:{chatgpt:{content:(e,t)=>{const n=t?.content??"",o=e.choices[0]?.delta?.content||"";return{...t,id:e.id,content:`${n}${o}`}}},claude:{content:(e,t)=>{const n=t?.content??"",o=e.delta?.text||"";return{...t,content:`${n}${o}`}}},gemini:{content:(e,t)=>{const n=t?.content??"",o=e.candidates[0]?.content?.parts[0]?.text||"";return{...t,content:`${n}${o}`}}}}},o=async e=>{if(!e.ok){const t=await e.json();if(t?.error)throw new Error(t.error.message);throw new Error(`${e.status} ${e.statusText}`)}},a=async(e,t,o,a,i)=>{if(!e.body)throw new Error("failed");const r=e.body.getReader(),s=new TextDecoder("utf-8");let d="",l={id:`${t}-${Date.now()}-${Math.round(1e3*Math.random())}`,content:""};for(;!i||!i.aborted;){const{done:e,value:i}=await r.read();if(e)break;const c=s.decode(i,{stream:!0});if("gemini"===t){const e=c.trim().split(",\r\n").map((e=>e.replace(/^\[|]$/g,""))).filter((e=>""!==e.trim()));for(const i of e)try{const e=JSON.parse(i);l=n.stream[t][o](e,l),a&&a(l)}catch{}}if("chatgpt"===t){d+=c;let e,i=0;for(;-1!==(e=d.indexOf("\n",i));){const r=d.slice(i,e).trim();if(i=e+1,r.startsWith("data: ")){const e=r.slice(6);if("[DONE]"===e)continue;try{const i=JSON.parse(e);l=n.stream[t][o](i,l),a&&a(l)}catch{}}}d=d.slice(i)}if("claude"===t){d+=c;let e,i=0;for(;-1!==(e=d.indexOf("\n",i));){const r=d.slice(i,e).trim();if(i=e+1,r.startsWith("data: ")){const e=r.slice(6);try{const i=JSON.parse(e);if("message_start"===i.type){l.id=i.message.id;continue}if("content_block_delta"!==i.type)continue;l=n.stream[t][o](i,l),a&&a(l)}catch{}}}d=d.slice(i)}}return l},i=async(e,t,i,r)=>{const s=(r=r||new AbortController).signal,d=await fetch(`${modAI.apiURL}?action=${e}`,{signal:s,method:"POST",body:JSON.stringify(t),headers:{"Content-Type":"application/json"}});if(!d.ok){const e=await d.json();if(e.error)throw new Error(e.error.message);throw new Error(e.detail)}const l=d.headers.get("x-modai-service")??"chatgpt",c=d.headers.get("x-modai-parser")??"content",p=1===parseInt(d.headers.get("x-modai-stream")??"0");if(1!==parseInt(d.headers.get("x-modai-proxy")??"0")){return(async(e,t,i)=>{if("object"!=typeof e||!e.forExecutor)return e;const r=e.forExecutor,s=(i=i||new AbortController).signal;if(!r.service||!r.parser)throw new Error(_("modai.cmp.service_required"));if(!n[r.stream?"stream":"buffered"]?.[r.service]?.[r.parser])throw new Error(_("modai.cmp.service_unsupported"));if(r.stream)return(async e=>{if("content"!==r.parser)throw new Error(_("modai.cmp.service_unsupported"));const n=await fetch(e.url,{signal:s,method:"POST",body:e.body,headers:e.headers});return await o(n),a(n,r.service,r.parser,t)})(r);const d=await(async e=>{const t=await fetch(e.url,{signal:s,method:"POST",body:e.body,headers:e.headers});await o(t);const n=await t.json();if(n.error)throw new Error(n.error.message);return n})(r);return n.buffered[r.service][r.parser](d)})(await d.json(),i,r)}if(!l||!c)throw r.abort(),new Error(_("modai.cmp.service_required"));if(!n[p?"stream":"buffered"]?.[l]?.[c])throw r.abort(),new Error(_("modai.cmp.service_unsupported"));if(!p){const e=await d.json();return n.buffered[l][c](e)}if("content"!==c)throw new Error(_("modai.cmp.service_unsupported"));return await a(d,l,c,i,s)},r={mgr:{download:{image:async e=>await(async(e,t)=>{const n=await fetch(`${modAI.apiURL}?action=Download\\Image`,{method:"POST",body:JSON.stringify(t),headers:{"Content-Type":"application/json"}});if(!n.ok){const e=await n.json();if(e.error)throw new Error(e.error.message);throw new Error(e.detail)}return n.json()})(0,e)},prompt:{freeText:async(e,t,n)=>i("Prompt\\FreeText",e,t,n),text:async(e,t,n)=>i("Prompt\\Text",e,t,n),vision:async(e,t,n)=>i("Prompt\\Vision",e,t,n),image:async(e,t)=>i("Prompt\\Image",e,void 0,t)}}},s={},d={_formatOutput(e,t){const n=s[e],o=n.visible>0,a=n.visible!==n.values.length-1;return{value:void 0!==t?t:n.values[n.visible]??null,nextStatus:a,prevStatus:o,current:n.visible+1,total:n.values.length,context:n.context}},insert(e,t,n=!1){const o=s[e];n||(o.visible=o.values.push(t)-1);const a=this._formatOutput(e,t);return"function"==typeof o.syncUI&&o.syncUI(a,n),a},next(e){const t=s[e];if(t.visible===t.values.length-1)return this._formatOutput(e);t.visible++;const n=this._formatOutput(e);return"function"==typeof t.syncUI&&t.syncUI(n),n},prev(e){const t=s[e];if(t.visible<=0)return this._formatOutput(e);t.visible--;const n=this._formatOutput(e);return"function"==typeof t.syncUI&&t.syncUI(n),n},init(e,t,n,o){return s[e]||(s[e]={visible:-1,values:[],context:o}),s[e].syncUI=t,n&&(s[e].values=[n],s[e].visible=0),{cachedItem:s[e],getData:()=>this._formatOutput(e),getAll:()=>s[e].values,syncUI:()=>{"function"==typeof s[e].syncUI&&s[e].syncUI(this._formatOutput(e),!1)},insert:(t,n=!1)=>this.insert(e,t,n),next:()=>this.next(e),prev:()=>this.prev(e)}}},l={},c="assistant",p=(e,t,n,o,a=!1)=>{const i=l[e];if(!i)return;const r={content:t,role:n,id:o,hidden:a};r.el=i.onAddMessage(r);const s=i.history.push(r)-1;o&&(i.idRef[o]=i.history[s])},g={init:(e,t,n)=>(l[e]||(l[e]={history:[],idRef:{},onAddMessage:t,onUpdateMessage:n}),l[e].onAddMessage=t,l[e].onUpdateMessage=n,{addUserMessage:(t,n)=>{p(e,t,"user",void 0,n)},addAssistantMessage:(t,n)=>{p(e,t,c,n)},updateAssistantMessage:(t,n)=>{((e,t,n)=>{const o=l[e];o&&(o.idRef[t]?(o.idRef[t].content=n,o.onUpdateMessage(o.idRef[t])):p(e,n,c,t))})(e,t,n)},getAssistantMessage:t=>((e,t)=>{const n=l[e];if(n)return n.idRef[t]})(e,t),getMessages:()=>l[e].history,getMessagesHistory:()=>l[e].history.map((e=>({role:e.role,content:e.content})))})},m={position:"fixed",top:"0",left:"0",width:"100%",height:"100%",backgroundColor:"rgba(0, 0, 0, 0.3)",display:"none",zIndex:"100"},h={position:"fixed",width:"1000px",minHeight:"170px",maxHeight:"600px",backgroundColor:"#fff",borderRadius:"10px",boxShadow:"0 5px 15px rgba(0, 0, 0, 0.3)",display:"none",flexDirection:"column",overflow:"hidden",zIndex:"101",top:"50%",left:"50%",transform:"translate(-50%, -50%)",transition:"height 0.3s ease-in-out"},u={backgroundColor:"#00B6DE",color:"white",padding:"15px",display:"flex",justifyContent:"space-between",alignItems:"center",cursor:"move"},f={fontWeight:"bold",fontSize:"16px"},x={display:"flex",gap:"10px"},b={background:"none",border:"none",color:"white",fontSize:"16px",cursor:"pointer"},y={flex:"1",padding:"15px",overflowY:"auto",backgroundColor:"#f9f9f9",width:"100%",boxSizing:"border-box",display:"none"},v={marginBottom:"20px",borderRadius:"8px",position:"relative",wordWrap:"break-word",width:"100%",boxSizing:"border-box"},w={width:"100%",backgroundColor:"#ffffff",border:"1px solid #e2e8f0",boxShadow:"0 2px 5px rgba(0, 0, 0, 0.05)"},E={width:"fit-content",padding:"10px 15px",backgroundColor:"#4299e1",color:"white",marginLeft:"auto",borderBottomRightRadius:"5px"},C={padding:"12px",width:"100%",maxWidth:"100%",overflow:"hidden",boxSizing:"border-box"},M={display:"flex",padding:"8px 12px",gap:"8px",backgroundColor:"#f7fafc",borderTop:"1px solid #e2e8f0",borderRadius:"0 0 8px 8px"},k={backgroundColor:"#edf2f7",border:"1px solid #cbd5e0",borderRadius:"4px",padding:"3px 8px",fontSize:"12px",cursor:"pointer",display:"flex",alignItems:"center",color:"#4a5568"},I={display:"flex",padding:"15px",borderTop:"1px solid #e2e8f0",backgroundColor:"white",position:"relative"},T={display:"flex",width:"100%",gap:"10px"},S={flex:"1",position:"relative",minHeight:"48px",maxHeight:"150px",display:"flex"},A={width:"100%",padding:"12px 15px",border:"1px solid #e2e8f0",borderRadius:"10px",outline:"none",fontSize:"14px",resize:"none",minHeight:"48px",maxHeight:"150px",overflowY:"auto",backgroundColor:"#fff",cursor:"inherit"},z={display:"flex",flexDirection:"column",gap:"4px",width:"100px"},L={backgroundColor:"#6CB24A",color:"white",border:"none",borderRadius:"12px",padding:"8px 16px",cursor:"pointer",fontWeight:"bold",height:"40px",minWidth:"100px",fontSize:"14px",display:"flex",alignItems:"center",justifyContent:"center",gap:"6px",opacity:"1"},H={display:"flex",gap:"4px",justifyContent:"space-between"},B={backgroundColor:"transparent",border:"1px solid #e2e8f0",borderRadius:"8px",width:"48px",height:"32px",padding:"0",cursor:"pointer",display:"flex",alignItems:"center",justifyContent:"center",transition:"background-color 0.2s",opacity:"1"},O={width:"16px",height:"16px",backgroundImage:"url(\"data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='white'%3E%3Cpath d='M2.01 21L23 12 2.01 3 2 10l15 2-15 2z'/%3E%3C/svg%3E\")",backgroundSize:"contain",backgroundRepeat:"no-repeat",backgroundPosition:"center"},R={width:"16px",height:"16px",backgroundImage:"url(\"data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23DC2626'%3E%3Cpath d='M0 0h24v24H0z' fill='none'/%3E%3Cpath d='M6 6h12v12H6z'/%3E%3C/svg%3E\")",backgroundSize:"contain",backgroundRepeat:"no-repeat",backgroundPosition:"center"},$={width:"16px",height:"16px",backgroundImage:"url(\"data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%234B5563'%3E%3Cpath d='M0 0h24v24H0z' fill='none'/%3E%3Cpath d='M17.65 6.35A7.958 7.958 0 0 0 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08A5.99 5.99 0 0 1 12 18c-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z'/%3E%3C/svg%3E\")",backgroundSize:"contain",backgroundRepeat:"no-repeat",backgroundPosition:"center"},D={display:"inline-block",width:"14px",height:"14px",marginRight:"5px",backgroundSize:"contain",backgroundRepeat:"no-repeat",backgroundPosition:"center"},j={opacity:"0.5",cursor:"not-allowed"},N={backgroundColor:"#f3f4f6",cursor:"not-allowed"},P={display:"none",position:"absolute",top:"0",left:"0",width:"100%",height:"100%",backgroundColor:"rgba(243, 244, 246, 0.9)",borderRadius:"10px",color:"#6B7280",fontSize:"14px",alignItems:"center",justifyContent:"center",gap:"4px",flexDirection:"row",zIndex:"10",backdropFilter:"blur(2px)",border:"1px solid #e2e8f0",pointerEvents:"none"},V={width:"fit-content",padding:"10px 15px",backgroundColor:"#DC2626",color:"white",marginLeft:"auto",borderBottomRightRadius:"5px",display:"flex",alignItems:"center",gap:"8px"},U={width:"16px",height:"16px",backgroundImage:"url(\"data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='white'%3E%3Cpath d='M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z'/%3E%3C/svg%3E\")",backgroundSize:"contain",backgroundRepeat:"no-repeat",backgroundPosition:"center"},q=(e,t)=>{Object.assign(e.style,t)},F=(e,t,n="")=>{const o=document.createElement(e);return t&&q(o,t),n&&(o.textContent=n),o},W=e=>/<[^>]*>/g.test(e)?e:e.replace(/\r\n|\n|\r/g,"<br>"),Y={freePrompt:e=>(e=>{if(!e.key)return void alert("key is required config property");const t=()=>{document.removeEventListener("mousemove",o),document.removeEventListener("mouseup",a),G.modalOverlay&&G.modalOverlay.remove(),G&&G.remove()},n=e=>{G.isDragging=!0;const t=G.getBoundingClientRect();G.offsetX=e.clientX-t.left,G.offsetY=e.clientY-t.top,document.body.style.userSelect="none"},o=e=>{if(!G.isDragging)return;const t=e.clientX-G.offsetX,n=e.clientY-G.offsetY;G.style.left=t+"px",G.style.top=n+"px",G.style.transform="none"},a=()=>{G.isDragging=!1,document.body.style.userSelect=""},i=()=>{G.isLoading&&G.abortController&&(G.abortController.abort(),G.abortController=void 0,Y(!1))},s=()=>{0!==X.getMessages().length&&J("Try again")},d=e=>{"none"===G.chatMessages.style.display&&(G.chatMessages.style.display="block");const t=F("div",{...v,...E});return t.innerHTML=W(e),G.chatMessages.appendChild(t),G.chatMessages.scrollTop=G.chatMessages.scrollHeight,t},l=e=>{"none"===G.chatMessages.style.display&&(G.chatMessages.style.display="block");const t=F("div",{...v,...V}),n=F("span",U);t.appendChild(n);const o=F("span");return o.textContent=e,t.appendChild(o),G.chatMessages.appendChild(t),G.chatMessages.scrollTop=G.chatMessages.scrollHeight,t},c=(n,o)=>{"none"===G.chatMessages.style.display&&(G.chatMessages.style.display="block");const a=F("div",{...v,...w}),i=o||"msg-"+Date.now();a.dataset.messageId=i;const r=F("div",C),s=((e,t,n=[])=>{const o=W(e),a=F("iframe",{width:"100%",border:"none",backgroundColor:"white",pointerEvents:"none",maxWidth:"100%",boxSizing:"border-box"});return a.srcdoc=`\n        <html>\n        <head>\n            <style>\n                html {\n                    width: 100%;\n                    max-width: 100%;\n                    padding: 0;\n                    margin: 0;\n                }\n                body {\n                    margin: 0;\n                    padding: 0;\n                    font-family: Arial, sans-serif;\n                    overflow-x: hidden;\n                    width: 100%;\n                    max-width: 100%;\n                    box-sizing: border-box;\n                }\n                * {\n                    box-sizing: border-box;\n                    max-width: 100%;\n                }\n                pre {\n                    white-space: pre-wrap;\n                    word-wrap: break-word;\n                    overflow-wrap: break-word;\n                    max-width: 100%;\n                    padding: 12px;\n                    margin: 0;\n                    background-color: #f5f7fa;\n                    border-radius: 5px;\n                    font-size: 14px;\n                }\n                img {\n                    max-width: 100%;\n                    height: auto;\n                    display: block;\n                }\n                code {\n                    white-space: pre-wrap;\n                    word-wrap: break-word;\n                    max-width: 100%;\n                    display: block;\n                    overflow-x: hidden;\n                    font-size: 14px;\n                }\n                table {\n                    width: 100%;\n                    max-width: 100%;\n                    overflow-x: hidden;\n                    display: block;\n                    border-collapse: collapse;\n                }\n                div {\n                    max-width: 100%;\n                    overflow-wrap: break-word;\n                    word-wrap: break-word;\n                    box-sizing: border-box;\n                }\n                p {\n                    margin: 0 0 0.5em 0;\n                    max-width: 100%;\n                }\n                h1, h2, h3, h4, h5, h6 {\n                    margin: 0 0 0.1em 0;\n                    max-width: 100%;\n                }\n            </style>\n            ${n.map((e=>`<link rel="stylesheet" type="text/css" href="${e}" />`)).join("")}\n        </head>\n        <body style="padding: 0; max-width: 100%; width: 100%; box-sizing: border-box;">${o}</body>\n        </html>\n    `,a.syncHeight=()=>{const e=a.contentWindow?.document.body;if(!e)return;const n=e.getElementsByTagName("*");let o=e.offsetHeight;for(let e=0;e<n.length;e++){const t=n[e],a=t.offsetTop+t.offsetHeight;o=Math.max(o,a)}a.style.height=o+5+"px",e.style.overflow="hidden",t.chatMessages.scrollTop=t.chatMessages.scrollHeight},a.onload=a.syncHeight,a})(n,G,e.customCSS??[]);r.appendChild(s);const d=F("div",M),l=F("button",k),c=F("span",{...D,backgroundImage:"url(\"data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='%234a5568' viewBox='0 0 16 16'%3E%3Cpath d='M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1v-1z'/%3E%3Cpath d='M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3zm-3-1A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3z'/%3E%3C/svg%3E\")"});l.append(c,document.createTextNode("Copy")),l.addEventListener("click",(()=>p(i,l))),d.append(l);const g=e.actions?.insert;if(g&&"function"==typeof g){const e=F("button",k),n=F("span",{...D,backgroundImage:"url(\"data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='%234a5568' viewBox='0 0 16 16'%3E%3Cpath d='M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z'/%3E%3Cpath d='M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z'/%3E%3C/svg%3E\")"});e.append(n,document.createTextNode("Insert")),e.addEventListener("click",(()=>g(X.getAssistantMessage(i),t))),d.append(e)}return a.append(r,d),G.chatMessages.appendChild(a),G.chatMessages.scrollTop=G.chatMessages.scrollHeight,a},p=(e,t)=>{const n=X.getAssistantMessage(e);if(!n)return;if(navigator.clipboard&&navigator.clipboard.writeText)navigator.clipboard.writeText(n.content).then((()=>{})).catch((()=>{l(_("modai.cmp.failed_copy"))}));else try{const e=F("textarea");e.value=n.content,document.body.appendChild(e),e.select(),document.execCommand("copy"),document.body.removeChild(e)}catch(e){l(_("modai.cmp.failed_copy"))}const o=t.innerHTML,a=F("span",{...D,backgroundImage:"url(\"data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='%234a5568' viewBox='0 0 16 16'%3E%3Cpath d='M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1v-1z'/%3E%3Cpath d='M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3zm-3-1A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3z'/%3E%3C/svg%3E\")"});t.innerHTML="",t.append(a,document.createTextNode("Copied!")),setTimeout((()=>{t.innerHTML=o}),2e3)},Y=e=>{G.isLoading=e,G.loadingIndicator.style.display=e?"flex":"none",G.messageInput.disabled=e,q(G.messageInput,e?{...A,...N}:A),G.sendBtn.disabled=e,q(G.sendBtn,e?{...L,...j}:L),G.stopBtn.disabled=!e,q(G.stopBtn,e?B:{...B,...j});const t=X.getMessages().length>0;G.tryAgainBtn.disabled=e||!t,q(G.tryAgainBtn,e||!t?{...B,...j}:B)},J=async(t,n)=>{const o=t?t.trim():G.messageInput.value.trim();if(!o||G.isLoading)return;Y(!0),G.messageInput.value="",G.abortController=new AbortController;const a=X.getMessagesHistory();X.addUserMessage(o,n);try{const t=await r.mgr.prompt.freeText({namespace:e.namespace,context:e.context,prompt:o,field:e.field||"",messages:a},(e=>{X.updateAssistantMessage(e.id,e.content)}),G.abortController);X.updateAssistantMessage(t.id,t.content),G.abortController=void 0}catch(e){if(e instanceof Error){if("AbortError"===e.name)return;return void l(e.message)}l("Unknown error")}Y(!1)},X=g.init(e.key,(e=>{if(!e.hidden)return"user"===e.role?d(e.content):c(e.content,e.id)}),(e=>{if(!e.el)return;if("user"===e.role)return void(e.el.textContent=e.content);const t=e.el?.firstChild?.firstChild;if(!t)return;const n=t.contentDocument;n&&(n.body.innerHTML=W(e.content),t.syncHeight())})),G=(()=>{const e=F("div",m),r=F("div",h),d=F("div",u),l=F("div",f,"modAI Assistant"),c=F("div",x),p=F("button",b,"✕");c.append(p),d.append(l,c);const g=F("div",y),v=F("div",I),w=F("div",T),E=F("div",S),C=F("textarea",A);C.placeholder="Type your message...";const M=F("div",z),k=F("button",L),_=F("span",O),D=document.createTextNode("Send");k.append(_,D);const N=F("div",H),V=F("button",{...B,...j}),U=F("span",R);V.appendChild(U),V.title="Stop Generation";const W=F("button",B),Y=F("span",$);W.appendChild(Y),W.title="Try Again",0===X.getMessages().length&&(W.disabled=!0,q(W,{...B,...j})),N.append(V,W),M.append(k,N),E.append(C),w.append(E,M);const G=F("div",P);return G.innerHTML='\n        <style>\n            @keyframes loadingDotPulse {\n                0%, 80%, 100% { transform: scale(0.6); opacity: 0.3; }\n                40% { transform: scale(1); opacity: 1; }\n            }\n            .loading-dots {\n                display: flex;\n                gap: 4px;\n                padding: 8px 16px;\n                background-color: rgba(255, 255, 255, 0.8);\n                border-radius: 16px;\n            }\n            .loading-dot {\n                width: 8px;\n                height: 8px;\n                background-color: #6B7280;\n                border-radius: 50%;\n                display: inline-block;\n                animation: loadingDotPulse 1.4s infinite ease-in-out both;\n            }\n            .loading-dot:nth-child(1) { animation-delay: -0.32s; }\n            .loading-dot:nth-child(2) { animation-delay: -0.16s; }\n            .loading-dot:nth-child(3) { animation-delay: 0s; }\n        </style>\n        <div class="loading-dots">\n            <div class="loading-dot"></div>\n            <div class="loading-dot"></div>\n            <div class="loading-dot"></div>\n        </div>\n    ',E.append(G),v.append(w),r.append(d,g,v),document.body.append(e,r),p.addEventListener("click",t),k.addEventListener("click",(()=>J())),V.addEventListener("click",i),W.addEventListener("click",s),C.addEventListener("keydown",(e=>{if("Enter"===e.key){if(e.shiftKey)return;e.preventDefault(),J()}})),d.addEventListener("mousedown",n),document.addEventListener("mousemove",o),document.addEventListener("mouseup",a),r.modalOverlay=e,r.chatHeader=d,r.closeBtn=p,r.chatMessages=g,r.messageInput=C,r.sendBtn=k,r.tryAgainBtn=W,r.stopBtn=V,r.loadingIndicator=G,r.isDragging=!1,r.isLoading=!1,r.abortController=void 0,r.offsetX=0,r.offsetY=0,r})();return G.api={sendMessage:J,closeModal:t},(()=>{G.chatMessages.innerHTML="",G.chatMessages.style.display="none",G.style.visibility="hidden",G.style.display="flex",G.modalOverlay.style.display="block";const e=X.getMessages().filter((e=>!e.hidden));e.length>0&&(G.chatMessages.style.display="block",e.forEach((e=>{"user"===e.role?d(e.content):c(e.content,e.id)}))),setTimeout((()=>{G.chatMessages.scrollTop=G.chatMessages.scrollHeight,G.style.visibility="visible"}),100)})(),G})(e)},J=(e,t)=>{e.context.els.forEach((({wrapper:n,field:o})=>{const a=o.getValue();o.setValue(e.value),o.fireEvent("change",o,e.value,a),t&&(o.el.dom.scrollTop=o.el.dom.scrollHeight),e.total>0&&n.historyNav.show(),n.historyNav.info.update(e.current,e.total),e.prevStatus?n.historyNav.prevButton.enable():n.historyNav.prevButton.disable(),e.nextStatus?n.historyNav.nextButton.enable():n.historyNav.nextButton.disable()}))},X=()=>{const e=document.createElement("button");return e.className="modai-generate",e.innerText="✦",e.type="button",e.title="Generate using AI",e},G=e=>{const t=document.createElement("button");t.type="button",t.title="Previous Version",t.className="modai-history_prev",t.disable=()=>{t.disabled=!0},t.enable=()=>{t.disabled=!1},t.innerHTML="prev",t.addEventListener("click",(()=>{e.prev()}));const n=document.createElement("button");n.type="button",n.title="Next Version",n.className="modai-history_next",n.disable=()=>{n.disabled=!0},n.enable=()=>{n.disabled=!1},n.innerHTML="next",n.addEventListener("click",(()=>{e.next()}));const o=document.createElement("span");o.update=(e,t)=>{o.innerText=`${e}/${t}`},o.innerText="";const a=document.createElement("span");return a.show=()=>{a.style.display="initial"},a.hide=()=>{a.style.display="none"},a.prevButton=t,a.nextButton=n,a.info=o,a.appendChild(t),a.appendChild(n),a.appendChild(o),a.hide(),t.disable(),n.disable(),a},K=e=>{const t=X();return t.addEventListener("click",(()=>{Y.freePrompt({key:e,field:e})})),t},Q=(e,t)=>{const n=document.createElement("span"),o=X();o.addEventListener("click",(async()=>{Ext.Msg.wait(_("modai.cmp.generate_ing"),_("modai.cmp.please_wait"));try{const e=await r.mgr.prompt.text({id:MODx.request.id,field:t});a.insert(e.content),Ext.Msg.hide()}catch(e){Ext.Msg.hide(),Ext.Msg.alert("Failed",_("modai.cmp.failed_try_again",{msg:e.message}))}})),n.appendChild(o);const a=d.init(t,J,e.getValue());a.cachedItem.context.els||(a.cachedItem.context.els=[]),a.cachedItem.context.els.push({field:e,wrapper:n});const i=G(a);return n.appendChild(i),n.historyNav=i,n},Z=(e,t,n,o)=>{const a=X();return a.addEventListener("click",(()=>{MODx.load({xtype:"modai-window-image_prompt",title:"Image",cacheKey:n,record:{resource:MODx.request.id,prompt:e,mediaSource:t,field:n},listeners:{success:{fn:o,scope:void 0}}}).show()})),a},ee=(e,t)=>{const n=Ext.getCmp(e);if(!n)return;const o=document.createElement("span"),a=X();a.addEventListener("click",(async()=>{Ext.Msg.wait(_("modai.cmp.generate_ing"),_("modai.cmp.please_wait"));try{const e=await r.mgr.prompt.text({id:MODx.request.id,field:t},(e=>{i.insert(e.content,!0)}));i.insert(e.content),Ext.Msg.hide()}catch(e){Ext.Msg.hide(),Ext.Msg.alert("Failed",_("modai.cmp.failed_try_again",{msg:e.message}))}})),o.appendChild(a);const i=d.init(t,J,n.getValue(),{});i.cachedItem.context.els||(i.cachedItem.context.els=[]),i.cachedItem.context.els.push({field:n,wrapper:o});const s=G(i);o.appendChild(s),o.historyNav=s,n.label.appendChild(o)},te=(e,t)=>{const n=Ext.getCmp(e.firstElementChild?.id),o=Z("",n.imageBrowser.source,t,(function(e){"url"in e&&(n.imageBrowser.setValue(e.url),n.onImageChange(e.url))})),a=X();a.style.marginTop="6px",a.addEventListener("click",(async()=>{const e=n.imagePreview.el.dom,o=document.createElement("canvas"),a=o.getContext("2d");if(!a)return;o.width=e.width,o.height=e.height,a.drawImage(e,0,0);const i=o.toDataURL("image/png");Ext.Msg.wait(_("modai.cmp.generate_ing"),_("modai.cmp.please_wait"));try{const e=await r.mgr.prompt.vision({image:i,field:t},(e=>{n.altTextField.items.items[0].setValue(e.content),n.altTextField.items.items[0].el.dom.scrollTop=n.altTextField.items.items[0].el.dom.scrollHeight,n.image.altTag=e.content,n.updateValue()}));n.altTextField.items.items[0].setValue(e.content),n.image.altTag=e.content,n.updateValue(),Ext.Msg.hide()}catch(e){Ext.Msg.hide(),Ext.Msg.alert("Failed",_("modai.cmp.failed_try_again",{msg:e.message}))}})),n.altTextField.el.dom.style.display="flex",n.altTextField.el.dom.style.justifyItems="center",n.altTextField.el.dom.style.alignItems="center",n.el.dom.parentElement.parentElement.parentElement.querySelector("label").appendChild(o),n.altTextField.el.dom.appendChild(a)};Ext.onReady((function(){Ext.defer((function(){(()=>{const e={pagetitle:["modx-resource-pagetitle"],longtitle:["modx-resource-longtitle","seosuite-longtitle"],introtext:["modx-resource-introtext"],description:["modx-resource-description","seosuite-description"],content:["modx-resource-content"]};for(const t of modAI?.resourceFields||[])e[t]&&("content"!==t?e[t].forEach((e=>{ee(e,`res.${t}`)})):Ext.getCmp("modx-resource-content").el.dom.querySelector("label").appendChild(K("res.content")))})(),(()=>{const e=Ext.getCmp("modx-panel-resource").getForm();for(const[t,n]of modAI?.tvs||[]){const o=Ext.get(`tv${t}-tr`);if(!o)continue;const a=e.findField(`tv${t}`),i=`tv.${n}`;if(a){if("textfield"===a.xtype||"textarea"===a.xtype){const e=MODx.config[`modai.tv.${n}.prompt`],t=o.dom.querySelector("label");if(!t)return;e?t.appendChild(Q(a,i)):t.appendChild(K(i))}if("modx-panel-tv-image"===a.xtype){const e=Z("",a.source,i,(function(e){if("url"in e){const t={relativeUrl:e.url,url:e.url};a.items.items[1].fireEvent("select",t),a.fireEvent("select",t)}})),t=o.dom.querySelector("label");if(!t)return;t.appendChild(e)}}else{const e=o.dom.querySelector(".imageplus-panel-input");e&&te(e,i)}}})()}),500)}));const ne={};return t})()));