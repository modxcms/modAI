"use strict";var ModAI=(()=>{var X=Object.defineProperty;var Pe=Object.getOwnPropertyDescriptor;var Oe=Object.getOwnPropertyNames;var Re=Object.prototype.hasOwnProperty;var _e=(e,t)=>{for(var o in t)X(e,o,{get:t[o],enumerable:!0})},Ue=(e,t,o,a)=>{if(t&&typeof t=="object"||typeof t=="function")for(let r of Oe(t))!Re.call(e,r)&&r!==o&&X(e,r,{get:()=>t[r],enumerable:!(a=Pe(t,r))||a.enumerable});return e};var $e=e=>Ue(X({},"__esModule",{value:!0}),e);var nt={};_e(nt,{init:()=>at});var w={},Y={user:"user",assistant:"assistant"},J=(e,t,o,a,r=!1,i="text")=>{let s=w[e];if(!s)return;let l={content:t,role:o,id:a,hidden:r,type:i,ctx:{}},c=s.history.push(l)-1;a&&(s.idRef[a]=s.history[c]),l.el=s.onAddMessage(l)},Fe=(e,t,o,a="text")=>{let r=w[e];if(!r)return;if(!r.idRef[t]){J(e,o,Y.assistant,t,!1,a);return}let i=r.idRef[t];i.content=o,i.el&&i.el.update&&i.el.update(i)},Ne=(e,t)=>{let o=w[e];if(o)return o.idRef[t]},k={init:(e,t)=>(w[e]||(w[e]={history:[],idRef:{},onAddMessage:t}),w[e].onAddMessage=t,{addUserMessage:(o,a,r="text")=>{let i="user-msg-"+Date.now()+Math.round(Math.random()*1e3);J(e,o,Y.user,i,a,r)},addAssistantMessage:(o,a,r="text")=>{J(e,o,Y.assistant,a,!1,r)},updateAssistantMessage:(o,a,r="text")=>{Fe(e,o,a,r)},getAssistantMessage:o=>Ne(e,o),getMessages:()=>w[e].history,getMessagesHistory:()=>w[e].history.map(o=>({role:o.role,content:o.content})),clearHistory:()=>{w[e].history.forEach(o=>{o.el?.remove()}),w[e].history=[]},clearHistoryFrom:o=>{let a=w[e].history.findIndex(r=>r.id===o);if(a!==-1){for(let r=a;r<w[e].history.length;r++)w[e].history[r].el?.remove();w[e].history.splice(a)}}})};var n={modalOpen:!1,alertOpen:!1,config:{},modal:{}},O=e=>{n.modal.isLoading=e,e?n.modal.loadingIndicator.style.display="flex":n.modal.loadingIndicator.style.display="none",n.modal.messageInput.disabled=e,e?(n.modal.sendBtn.disable(),n.modal.stopBtn.enable(),n.modal.closeModalBtn.disable()):(n.modal.sendBtn.disable(),n.modal.stopBtn.disable(),n.modal.closeModalBtn.enable()),n.modal.modeButtons.forEach(a=>{e?a.disable():a.enable()});let t=n.modal.history.getMessages().length>0;n.modal.actionButtons.forEach(a=>{e||!t?a.disable():a.enable()}),n.modal.chatMessages.querySelectorAll(".action-button").forEach(a=>{e?a.disable?.():a?.enable?.()})};var B={buffered:{chatgpt:{content:e=>{let t=e?.choices?.[0]?.message?.content;if(!t)throw new Error(_("modai.cmp.failed_request"));return{id:e.id,content:t}},image:e=>{let t=e?.data?.[0]?.url;if(!t){if(t=e?.data?.[0]?.b64_json,!t)throw new Error(_("modai.cmp.failed_request"));t=`data:image/png;base64,${t}`}return{id:`chatgpt-${Date.now()}-${Math.round(Math.random()*1e3)}`,url:t}}},claude:{content:e=>{let t=e?.content?.[0]?.text;if(!t)throw new Error(_("modai.cmp.failed_request"));return{id:e.id,content:t}}},gemini:{content:e=>{let t=e?.candidates?.[0]?.content?.parts?.[0]?.text;if(!t)throw new Error(_("modai.cmp.failed_request"));return{id:`gemini-${Date.now()}-${Math.round(Math.random()*1e3)}`,content:t}},image:e=>{let t=e?.predictions?.[0]?.bytesBase64Encoded;if(!t)throw new Error(_("modai.cmp.failed_request"));return{id:`gemini-${Date.now()}-${Math.round(Math.random()*1e3)}`,url:`data:image/png;base64,${t}`}}}},stream:{chatgpt:{content:(e,t)=>{let o=t?.content??"",a=e.choices?.[0]?.delta?.content||"";return{...t,id:e.id,content:`${o}${a}`}}},claude:{content:(e,t)=>{let o=t?.content??"",a=e.delta?.text||"";return{...t,content:`${o}${a}`}}},gemini:{content:(e,t)=>{let o=t?.content??"",a=e.candidates?.[0]?.content?.parts?.[0]?.text||"";return{...t,content:`${o}${a}`}}}}},ne=async e=>{if(!e.ok){let t=await e.json();throw t?.error?new Error(t.error.message):new Error(`${e.status} ${e.statusText}`)}},re=async(e,t,o,a,r)=>{if(!e.body)throw new Error("failed");let i=e.body.getReader(),s=new TextDecoder("utf-8"),l="",c={id:`${t}-${Date.now()}-${Math.round(Math.random()*1e3)}`,content:""};for(;!(r&&r.aborted);){let{done:m,value:p}=await i.read();if(m)break;let v=s.decode(p,{stream:!0});if(t==="gemini"){let y=v.trim().split(`,\r
`).map(h=>h.replace(/^\[|]$/g,"")).filter(h=>h.trim()!=="");for(let h of y)try{let D=JSON.parse(h);c=B.stream[t][o](D,c),a&&a(c)}catch{}}if(t==="chatgpt"){l+=v;let y=0,h;for(;(h=l.indexOf(`
`,y))!==-1;){let D=l.slice(y,h).trim();if(y=h+1,D.startsWith("data: ")){let u=D.slice(6);if(u==="[DONE]")continue;try{let b=JSON.parse(u);c=B.stream[t][o](b,c),a&&a(c)}catch{}}}l=l.slice(y)}if(t==="claude"){l+=v;let y=0,h;for(;(h=l.indexOf(`
`,y))!==-1;){let D=l.slice(y,h).trim();if(y=h+1,D.startsWith("data: ")){let u=D.slice(6);try{let b=JSON.parse(u);if(b.type==="message_start"){c.id=b.message.id;continue}if(b.type!=="content_block_delta")continue;c=B.stream[t][o](b,c),a&&a(c)}catch{}}}l=l.slice(y)}}return c},je=async(e,t,o)=>{if(typeof e!="object"||!e.forExecutor)return e;let a=e.forExecutor;o=o||new AbortController;let r=o.signal,i=async c=>{let m=await fetch(c.url,{signal:r,method:"POST",body:c.body,headers:c.headers});await ne(m);let p=await m.json();if(p.error)throw new Error(p.error.message);return p},s=async c=>{if(a.parser!=="content")throw new Error(_("modai.cmp.service_unsupported"));let m=await fetch(c.url,{signal:r,method:"POST",body:c.body,headers:c.headers});return await ne(m),re(m,a.service,a.parser,t)};if(!a.service||!a.parser)throw new Error(_("modai.cmp.service_required"));if(!B[a.stream?"stream":"buffered"]?.[a.service]?.[a.parser])throw new Error(_("modai.cmp.service_unsupported"));if(a.stream)return s(a);let l=await i(a);return B.buffered[a.service][a.parser](l)},Ve=async(e,t)=>{let o=await fetch(`${n.config.apiURL}?action=${e}`,{method:"POST",body:JSON.stringify(t),headers:{"Content-Type":"application/json"}});if(!o.ok){let a=await o.json();throw a.error?new Error(a.error.message):new Error(a.detail)}return await o.json()},q=async(e,t,o,a)=>{a=a||new AbortController;let r=a.signal,i=await fetch(`${n.config.apiURL}?action=${e}`,{signal:r,method:"POST",body:JSON.stringify(t),headers:{"Content-Type":"application/json"}});if(!i.ok){let p=await i.json();throw p.error?new Error(p.error.message):new Error(p.detail)}let s=i.headers.get("x-modai-service")??"chatgpt",l=i.headers.get("x-modai-parser")??"content",c=parseInt(i.headers.get("x-modai-stream")??"0")===1;if(!(parseInt(i.headers.get("x-modai-proxy")??"0")===1)){let p=await i.json();return je(p,o,a)}if(!s||!l)throw a.abort(),new Error(_("modai.cmp.service_required"));if(!B[c?"stream":"buffered"]?.[s]?.[l])throw a.abort(),new Error(_("modai.cmp.service_unsupported"));if(!c){let p=await i.json();return B.buffered[s][l](p)}if(l!=="content")throw new Error(_("modai.cmp.service_unsupported"));return await re(i,s,l,o,r)},T={mgr:{download:{image:async e=>await Ve("Download\\Image",e)},prompt:{freeText:async(e,t,o)=>q("Prompt\\FreeText",e,t,o),text:async(e,t,o)=>q("Prompt\\Text",e,t,o),vision:async(e,t,o)=>q("Prompt\\Vision",e,t,o),image:async(e,t)=>q("Prompt\\Image",e,void 0,t)}}};var C={},G={_formatOutput(e,t){let o=C[e],a=o.visible>0,r=o.visible!==o.values.length-1;return{value:t!==void 0?t:o.values[o.visible]??null,nextStatus:r,prevStatus:a,current:o.visible+1,total:o.values.length,context:o.context}},insert(e,t,o=!1){let a=C[e];o||(a.visible=a.values.push(t)-1);let r=this._formatOutput(e,t);return typeof a.syncUI=="function"&&a.syncUI(r,o),r},next(e){let t=C[e];if(t.visible===t.values.length-1)return this._formatOutput(e);t.visible++;let o=this._formatOutput(e);return typeof t.syncUI=="function"&&t.syncUI(o),o},prev(e){let t=C[e];if(t.visible<=0)return this._formatOutput(e);t.visible--;let o=this._formatOutput(e);return typeof t.syncUI=="function"&&t.syncUI(o),o},init(e,t,o,a){return C[e]||(C[e]={visible:-1,values:[],context:a}),C[e].syncUI=t,o&&(C[e].values=[o],C[e].visible=0),{cachedItem:C[e],getData:()=>this._formatOutput(e),getAll:()=>C[e].values,syncUI:()=>{typeof C[e].syncUI=="function"&&C[e].syncUI(this._formatOutput(e),!1)},insert:(r,i=!1)=>this.insert(e,r,i),next:()=>this.next(e),prev:()=>this.prev(e)}}};var g=(e,t)=>{e.className=t},d=(e,t,o,a)=>{let r=typeof o=="string"?o:"";o&&typeof o!="string"&&!Array.isArray(o)&&(o=[o]);let i=document.createElement(e);if(a&&Object.assign(i,a),t&&(i.className=t),r)i.textContent=r;else if(o&&Array.isArray(o)){for(let s of o)if(s){if(typeof s=="string"){i.append(document.createTextNode(s));continue}i.append(s)}}return i},I=e=>/<[^>]*>/g.test(e)?e:e.replace(/\r\n|\n|\r/g,"<br>");var f=(e,t,o,a)=>{let r=typeof e=="string"?e:"";typeof e!="string"&&!Array.isArray(e)&&(e=[e]);let i=d("button",o,r);return i.type="button",Array.isArray(e)&&e.forEach(s=>{typeof s=="string"?i.append(document.createTextNode(s)):i.append(s)}),i.addEventListener("click",t),i.enable=()=>{i.disabled=!1},i.disable=()=>{i.disabled=!0},a&&Object.assign(i,a),i};var R=e=>{e={showConfirm:!0,showCancel:!0,...e};let t=f(e.cancelText??"Cancel",()=>{i()},"cancelBtn",{tabIndex:0}),o=f(e.confirmText,()=>{r(),e.onConfirm()},"confirmBtn",{tabIndex:0}),a=d("div","modai--root overlay",[d("div","dialog",[d("h3","title",e.title),d("p","message",e.content),d("div","buttons",[e.showCancel&&t,e.showConfirm&&o])],{tabIndex:-1})],{ariaModal:"true",role:"dialog",ariaLabel:e.title}),r=()=>{document.removeEventListener("keydown",s),a.remove()},i=()=>{r(),e.onCancel?.()},s=l=>{if(l.key==="Escape"&&(l.stopImmediatePropagation(),l.preventDefault(),l.stopPropagation(),i()),l.key==="Tab"){let c=[t,o];e.showCancel&&c.push(t),e.showConfirm&&c.push(o);let m=document.activeElement,p=m?c.indexOf(m):-1;l.shiftKey?p=(p-1+c.length)%c.length:p=(p+1)%c.length,c.length>0&&c[p].focus(),l.preventDefault()}};document.addEventListener("keydown",s),document.body.append(a),e.showConfirm&&o.focus(),!e.showConfirm&&e.showCancel&&t.focus()};var U=(e,t={})=>{let o={indicatorType:t.indicatorType||"spinner",overlayColor:t.overlayColor||"rgba(255, 255, 255, 0.7)",indicatorColor:t.indicatorColor||"#3498db"},a=document.createElement("div"),r=document.createElement("div"),i=window.getComputedStyle(e),s=e.getBoundingClientRect();t.indicatorColor||(o.indicatorType=s.height<=50?"dots":"spinner"),a.style.position="absolute",a.style.top="0",a.style.left="0",a.style.width="100%",a.style.height="100%",a.style.backgroundColor=o.overlayColor,a.style.display="flex",a.style.justifyContent="center",a.style.alignItems="center",a.style.zIndex="10000",a.style.borderRadius=i.borderRadius;let l="";if(o.indicatorType==="spinner")r.style.border="4px solid #f3f3f3",r.style.borderTop=`4px solid ${o.indicatorColor}`,r.style.borderRadius="50%",r.style.width="30px",r.style.height="30px",r.style.animation="textareaOverlaySpin 1s linear infinite",l=`
      @keyframes textareaOverlaySpin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }
    `;else if(o.indicatorType==="dots"){r.style.display="flex",r.style.alignItems="center",r.style.justifyContent="center",r.style.height="20px";for(let y=0;y<3;y++){let h=document.createElement("div");h.style.width="8px",h.style.height="8px",h.style.borderRadius="50%",h.style.backgroundColor=o.indicatorColor,h.style.margin="0 4px",h.style.animation="textareaOverlayDotPulse 1.4s infinite ease-in-out",h.style.animationDelay=`${y*.2}s`,r.appendChild(h)}l=`
      @keyframes textareaOverlayDotPulse {
        0%, 80%, 100% { transform: scale(0); opacity: 0.5; }
        40% { transform: scale(1); opacity: 1; }
      }
    `}let c=document.createElement("style");c.textContent=l,document.head.appendChild(c),a.appendChild(r);let m=window.getComputedStyle(e.parentElement),p;["relative","absolute","fixed"].indexOf(m.position)===-1?(p=document.createElement("div"),p.style.position="relative",p.style.width=`${s.width}px`,p.style.height=`${s.height}px`,p.style.display="inline-block",e.parentNode?.insertBefore(p,e),p.appendChild(e)):p=e.parentElement,a.style.display="none",p.appendChild(a);let v=e.getBoundingClientRect();return p!==e.parentElement&&(p.style.width=`${v.width}px`,p.style.height=`${v.height}px`),a.style.display="flex",e.setAttribute("disabled","disabled"),()=>{a.style.display="none",e.removeAttribute("disabled"),a.remove(),c.remove(),p!==e.parentElement&&(p.parentNode?.insertBefore(e,p),p.remove())}};var Q=e=>d("span","modai--root generate",f("\u2726",e,"generate",{type:"button",title:"Generate using AI"})),We=e=>{let t=f("prev",()=>{e.prev()},"history_prev",{type:"button",title:"Previous Version"}),o=f("next",()=>{e.next()},"history_next",{type:"button",title:"Next Version"}),a=d("span");a.update=(i,s)=>{a.innerText=`${i}/${s}`};let r=d("span");return r.show=()=>{r.style.display="initial"},r.hide=()=>{r.style.display="none"},r.prevButton=t,r.nextButton=o,r.info=a,r.appendChild(t),r.appendChild(o),r.appendChild(a),r.hide(),t.disable(),o.disable(),r},qe=e=>Q(()=>{M.localChat(e)}),Ge=({input:e,onChange:t,initialValue:o,field:a,...r})=>{let i=Q(async()=>{let c=U(e);try{let m=await T.mgr.prompt.text({field:a,...r},p=>{s.insert(p.content,!0)});s.insert(m.content),c()}catch(m){c(),R({title:"Failed",content:_("modai.cmp.failed_try_again",{msg:m instanceof Error?m.message:""}),confirmText:"Close",showCancel:!1,onConfirm:()=>{}})}}),s=G.init(a,(c,m)=>{c.context.els.forEach(({wrapper:p,onFieldChange:v})=>{v(c,m),c.total>0&&p.historyNav.show(),p.historyNav.info.update(c.current,c.total),c.prevStatus?p.historyNav.prevButton.enable():p.historyNav.prevButton.disable(),c.nextStatus?p.historyNav.nextButton.enable():p.historyNav.nextButton.disable()})},o,{});s.cachedItem.context.els||(s.cachedItem.context.els=[]),s.cachedItem.context.els.push({onFieldChange:t,wrapper:i});let l=We(s);return i.appendChild(l),i.historyNav=l,i},Ke=e=>Q(async()=>{let t=document.createElement("canvas"),o=t.getContext("2d");if(!o)return;t.width=e.image.width,t.height=e.image.height,o.drawImage(e.image,0,0);let a=t.toDataURL("image/png"),r=U(e.input);try{let i=await T.mgr.prompt.vision({image:a,field:e.field,namespace:e.namespace},s=>{e.onUpdate(s)});e.onUpdate(i),r()}catch(i){r(),R({title:"Failed",content:_("modai.cmp.failed_try_again",{msg:i instanceof Error?i.message:""}),confirmText:"Close",showCancel:!1,onConfirm:()=>{}})}}),se={localChat:qe,forcedText:Ge,vision:Ke};var ie=e=>{n.modal.isDragging=!0;let o=n.modal.modal.getBoundingClientRect();n.modal.offsetX=e.clientX-o.left,n.modal.offsetY=e.clientY-o.top,document.body.style.userSelect="none"},$=e=>{if(!n.modal.isDragging)return;let t=n.modal.modal,o=e.clientX-n.modal.offsetX,a=e.clientY-n.modal.offsetY;t.style.left=o+"px",t.style.top=a+"px",t.style.transform="none"},F=()=>{n.modal.isDragging=!1,document.body.style.userSelect=""};var le='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-check"><path d="M20 6 9 17l-5-5"></path></svg>',de='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-chevron-down"><path d="m6 9 6 6 6-6"></path></svg>',Z='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-copy"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg>',ce='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-pencil"><path d="M21.174 6.812a1 1 0 0 0-3.986-3.987L3.842 16.174a2 2 0 0 0-.5.83l-1.321 4.352a.5.5 0 0 0 .623.622l4.353-1.32a2 2 0 0 0 .83-.497z"></path><path d="m15 5 4 4"></path></svg>',pe='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-image"><rect width="18" height="18" x="3" y="3" rx="2" ry="2"></rect><circle cx="9" cy="9" r="2"></circle><path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"></path></svg>',ee='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-circle-plus"><circle cx="12" cy="12" r="10"></circle><path d="M8 12h8"></path><path d="M12 8v8"></path></svg>',me='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-refresh-cw"><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"></path><path d="M21 3v5h-5"></path><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"></path><path d="M8 16H3v5"></path></svg>',ue='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-arrow-up"><path d="m5 12 7-7 7 7"></path><path d="M12 19V5"></path></svg>',he='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-square"><rect width="18" height="18" x="3" y="3" rx="2"></rect></svg>',ge='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-text"><path d="M17 6.1H3"></path><path d="M21 12.1H3"></path><path d="M15.1 18H3"></path></svg>',fe='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-trash"><path d="M3 6h18"></path><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"></path><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"></path></svg>',ye='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-triangle-alert"><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3"></path><path d="M12 9v4"></path><path d="M12 17h.01"></path></svg>',xe='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-x"><path d="M18 6 6 18"></path><path d="m6 6 12 12"></path></svg>';var ze={loadingText:"Loading...",completedText:"Completed!",completedTextDuration:2e3,disabled:!1,disableCompletedState:!1},P=e=>{e={...ze,...e};let t=async()=>{let i=r.innerHTML,s=e.onClick(e.message,n.modal);if(s instanceof Promise){let l=d("span","spinner",[d("span","dot top"),d("span","dot right"),d("span","dot bottom"),d("span","dot left")]);o.innerHTML="",o.appendChild(l),a.innerHTML=e.loadingText||"",await s}e.disableCompletedState||(o.innerHTML=le,a.innerHTML=e.completedText||"Completed!",await new Promise(l=>setTimeout(l,2e3))),r.innerHTML=i},o=e.icon;o.ariaHidden="true";let a=d("div",void 0,e.label),r=f([o,a],t,"action-button",{ariaLabel:e.label,tabIndex:0});return e.disabled&&r.disable(),r};var x=(e,t)=>{let o=d("div","icon");return o.style.width=`${e}px`,o.style.height=`${e}px`,o.innerHTML=t.trim(),o};var ve=()=>{let e=d("div","scrollToBottomContainer",[f([d("div",void 0,"Scroll to bottom"),x(14,de)],()=>{j(),N()})]);return n.modal.chatContainer.addEventListener("scroll",()=>{N()}),new MutationObserver(()=>{N()}).observe(n.modal.chatContainer,{childList:!0,subtree:!0}),n.modal.scrollWrapper=e,e},N=()=>{let t=n.modal.chatContainer.scrollHeight-n.modal.chatContainer.scrollTop-n.modal.chatContainer.clientHeight<10;n.modal.chatContainer.scrollHeight>n.modal.chatContainer.clientHeight&&!t?n.modal.scrollWrapper.style.display="flex":n.modal.scrollWrapper.style.display="none"};var Xe=`
    html {
        width: 100%;
        max-width: 100%;
        padding: 0;
        margin: 0;
    }
    body {
        background-color: #F1F1F2;
        margin: 0;
        padding: 0;
        font-family: Arial, sans-serif;
        overflow-x: hidden;
        width: 100%;
        max-width: 100%;
        box-sizing: border-box;
    }
    * {
        box-sizing: border-box;
        max-width: 100%;
    }
    pre {
        white-space: pre-wrap;
        word-wrap: break-word;
        overflow-wrap: break-word;
        max-width: 100%;
        padding: 12px;
        margin: 0;
        background-color: #f5f7fa;
        border-radius: 5px;
        font-size: 14px;
    }
    img {
        max-width: 100%;
        height: auto;
        display: block;
    }
    code {
        white-space: pre-wrap;
        word-wrap: break-word;
        max-width: 100%;
        display: block;
        overflow-x: hidden;
        font-size: 14px;
    }
    table {
        width: 100%;
        max-width: 100%;
        overflow-x: hidden;
        display: block;
        border-collapse: collapse;
    }
    div {
        max-width: 100%;
        overflow-wrap: break-word;
        word-wrap: break-word;
        box-sizing: border-box;
    }
    p {
        margin: 0 0 0.5em 0;
        max-width: 100%;
    }
    h1, h2, h3, h4, h5, h6 {
        margin: 0 0 0.1em 0;
        max-width: 100%;
    }
`,be=(e,t=[])=>{let o=d("div");o.updateContent=s=>{a.innerHTML=I(s),N()};let a=d("div");a.innerHTML=I(e);let r=o.attachShadow({mode:"open"}),i=d("style");return i.textContent=Xe,r.appendChild(i),t.forEach(s=>{r.appendChild(d("link",void 0,"",{rel:"stylesheet",type:"text/css",href:s}))}),r.append(a),o};var Ye=e=>{let t=d("div","message user"),o,a=null;if(Array.isArray(e.content)){let[s,...l]=e.content;o=s.value,a=l}else o=e.content;let r=d("div");if(r.innerHTML=I(o),t.appendChild(r),a){let s=d("div","imageRow");for(let l of a){let c=d("div"),m=d("img");m.src=l.value,c.appendChild(m),s.appendChild(c)}t.appendChild(s)}let i=d("div","actions");return i.appendChild(P({message:e,disabled:n.modal.isLoading,disableCompletedState:!0,icon:x(14,ce),label:"Edit",onClick:s=>{n.alertOpen=!0,R({title:"Confirm Edit",content:"Editing this message will delete all responses that came after it. Do you want to proceed?",confirmText:"Edit Message",onCancel:()=>{n.alertOpen=!1},onConfirm:()=>{if(n.alertOpen=!1,n.modal.messageInput.setValue(typeof s.content=="string"?s.content:s.content[0].value),typeof s.content!="string")for(let l of s.content)l.type!=="text"&&l.type==="image"&&n.modal.attachments.addImageAttachment(l.value);n.modal.history.clearHistoryFrom(s.id),n.modal.history.getMessages().length===0&&(n.modal.welcomeMessage.style.display="block")}})}})),t.appendChild(i),t.update=s=>{let l=Array.isArray(s.content)?s.content[0].value:s.content;r.innerHTML=I(l)},n.modal.chatMessages.appendChild(t),t},L=e=>{n.modal.welcomeMessage.style.display="none";let t=d("div","message error");t.appendChild(x(14,ye));let o=d("span");return o.textContent=e,t.appendChild(o),n.modal.chatMessages.appendChild(t),t},we=(e,t)=>{let o=d("div","message ai"),a=Array.isArray(e.content)?e.content[0].value:e.content;e.type==="image"&&(a=`<img src="${a}" />`);let r=be(a,t.customCSS??[]);o.appendChild(r);let i=d("div","actions");if(t.type==="text"&&(t.textActions?.copy!==!1&&i.appendChild(P({message:e,disabled:n.modal.isLoading,icon:x(14,Z),label:"Copy",completedText:"Copied!",onClick:typeof t.textActions?.copy=="function"?t.textActions.copy:Ce})),typeof t.textActions?.insert=="function"&&i.append(P({message:e,disabled:n.modal.isLoading,icon:x(14,ee),label:"Insert",completedText:"Inserted!",onClick:t.textActions.insert}))),t.type==="image"){t.imageActions?.copy!==!1&&i.append(P({message:e,disabled:n.modal.isLoading,icon:x(14,Z),label:"Copy",loadingText:"Downloading...",completedText:"Copied!",onClick:async(l,c)=>{let m=typeof t.textActions?.copy=="function"?t.textActions.copy:Ce;if(l.ctx.downloaded===!0){m(l,c);return}let p=await T.mgr.download.image({url:l.content,field:t.field,namespace:t.namespace,resource:t.resource,mediaSource:t.image?.mediaSource});l.content=p.fullUrl,l.ctx.downloaded=!0,l.ctx.url=p.url,l.ctx.fullUrl=p.fullUrl,m(l,c)}}));let s=t.imageActions?.insert;typeof s=="function"&&i.append(P({message:e,disabled:n.modal.isLoading,icon:x(14,ee),label:"Insert",completedText:"Inserted!",loadingText:"Downloading...",onClick:async(l,c)=>{if(l.ctx.downloaded===!0){s(l,c);return}let m=await T.mgr.download.image({url:l.content,field:t.field,namespace:t.namespace,resource:t.resource,mediaSource:t.image?.mediaSource});l.content=m.fullUrl,l.ctx.downloaded=!0,l.ctx.url=m.url,l.ctx.fullUrl=m.fullUrl,s(l,c)}}))}return o.appendChild(i),n.modal.chatMessages.appendChild(o),o.update=s=>{let l=Array.isArray(s.content)?s.content[0].value:s.content,c=s.type==="image"?`<img src="${l}" />`:I(l);r.updateContent(c)},o},K=(e,t)=>{if(!e.hidden){if(e.role==="user"){let o=Ye(e);return o.scrollIntoView({behavior:"smooth",block:"start"}),o}return e.type==="image",we(e,t)}},Ce=async e=>{let t=Array.isArray(e.content)?e.content[0].value:e.content;if(navigator.clipboard&&navigator.clipboard.writeText)try{await navigator.clipboard.writeText(t)}catch{L(_("modai.cmp.failed_copy"))}else try{let o=d("textarea");o.value=t,document.body.appendChild(o),o.select(),document.execCommand("copy"),document.body.removeChild(o)}catch{L(_("modai.cmp.failed_copy"))}};var V=()=>{n.modal.isLoading||(document.removeEventListener("mousemove",e=>$(e)),document.removeEventListener("mouseup",()=>F()),n.modal&&n.modal.remove(),n.modalOpen=!1)},A=async(e,t,o)=>{let a=t?t.trim():n.modal.messageInput.value.trim();if(!a||n.modal.isLoading)return;O(!0),n.modal.messageInput.value="",n.modal.messageInput.style.height="auto",n.modal.abortController=new AbortController,n.modal.welcomeMessage.style.display="none";let r=a;n.modal.attachments.attachments.length>0&&e.type==="text"&&(r=[{type:"text",value:a},...n.modal.attachments.attachments.map(s=>({type:s.type,value:s.value}))]),n.modal.attachments.removeAttachments();let i=n.modal.history.getMessagesHistory();n.modal.history.addUserMessage(r,o);try{if(e.type==="text"){let s=await T.mgr.prompt.freeText({namespace:e.namespace,context:e.context,prompt:r,field:e.field||"",messages:i},l=>{n.modal.history.updateAssistantMessage(l.id,l.content)},n.modal.abortController);n.modal.history.updateAssistantMessage(s.id,s.content)}if(e.type==="image"){let s=await T.mgr.prompt.image({prompt:r},n.modal.abortController);n.modal.history.addAssistantMessage(s.url,s.id,"image")}n.modal.abortController=void 0}catch(s){if(s instanceof Error){if(s.name==="AbortError")return;O(!1),L(s.message);return}L("Unknown error")}O(!1),n.modal.messageInput.focus()},Me=()=>{!n.modal.isLoading||!n.modal.abortController||(n.modal.abortController.abort(),n.modal.abortController=void 0,O(!1))},Te=e=>{if(n.modal.history.getMessages().length!==0){if(e.type==="text"){A(e,"Try again");return}if(e.type==="image"){let t=n.modal.history.getMessages().reverse().find(o=>o.role==="user");t&&A(e,t.content)}}},te=(e,t)=>{for(t.type=e,n.modal.history=k.init(`${t.key}/${t.type}`,a=>K(a,t));n.modal.chatMessages.firstChild;)n.modal.chatMessages.removeChild(n.modal.chatMessages.firstChild);let o=n.modal.history.getMessages().filter(a=>!a.hidden);o.length>0?(n.modal.welcomeMessage.style.display="none",o.forEach(a=>{a.el&&n.modal.chatMessages.appendChild(a.el)}),n.modal.actionButtons.forEach(a=>{a.enable()})):(n.modal.welcomeMessage.style.display="block",n.modal.actionButtons.forEach(a=>{a.disable()})),j()},Ee=()=>{n.modal.history.clearHistory(),n.modal.chatMessages.innerHTML="",n.modal.welcomeMessage.style.display="block",n.modal.actionButtons.forEach(e=>{e.disable()})},W=async(e,t=!1)=>{if(!t&&e instanceof File&&!e.type.startsWith("image/")){L("Only image files are allowed");return}if(t){n.modal.attachments.addImageAttachment(e);return}let o=await new Promise((a,r)=>{let i=new FileReader;i.onload=function(s){a(s.target?.result)},i.onerror=function(s){r(s)},i.readAsDataURL(e)});n.modal.attachments.addImageAttachment(o)},j=()=>{n.modal.chatContainer.scrollTop=n.modal.chatContainer.scrollHeight};var De=()=>{let e=d("div","chatContainer","",{ariaLive:"polite"}),t=d("div","welcome",[d("p","greeting",n.config.name?`Welcome, ${n.config.name}.`:"Welcome!"),d("p","msg","How can I help you today? \u2728")]);e.append(t);let o=d("div","history","",{ariaLabel:"Conversation history"});return e.append(o),n.modal.welcomeMessage=t,n.modal.chatMessages=o,n.modal.chatContainer=e,e};var Le=()=>{let e=f(x(24,xe),()=>{V()},"closeBtn",{ariaLabel:"Close dialog"}),t=d("header","header",[d("h1","","modAI Assistant"),e]);return t.addEventListener("mousedown",o=>{ie(o),document.addEventListener("mousemove",$),document.addEventListener("mouseup",()=>{F(),document.removeEventListener("mousemove",$),document.removeEventListener("mouseup",F)})}),document.addEventListener("keydown",o=>{n.alertOpen||o.key==="Escape"&&(o.preventDefault(),V())}),n.modal.closeModalBtn=e,t};var Se=()=>{let e=d("div","attachmentsWrapper");return e.visible=!1,e.attachments=[],e.show=()=>{e.visible||(e.visible=!0,g(e,"attachmentsWrapper visible"))},e.hide=()=>{e.visible&&(e.visible=!1,g(e,"attachmentsWrapper"))},e.addImageAttachment=t=>{Je(t)},e.removeAttachments=()=>{n.modal.attachments.attachments.forEach(t=>{n.modal.attachments.removeAttachment(t)})},e.addAttachment=t=>{e.show(),e.appendChild(t),e.attachments.push(t)},e.removeAttachment=t=>{let o=e.attachments.indexOf(t);o!==-1&&(t.remove(),e.attachments.splice(o,1),e.attachments.length===0&&e.hide())},n.modal.attachments=e,e},Je=e=>{n.modal.attachments.attachments.length>0&&n.modal.attachments.removeAttachments();let t=d("div","imagePreview");t.type="image",t.value=e;let o=d("img",void 0,"",{src:e}),a=d("button",void 0,"\xD7");a.addEventListener("click",r=>{r.stopPropagation(),n.modal.attachments.removeAttachment(t)}),t.append(o,a),n.modal.attachments.addAttachment(t)};var Be=e=>{let t=d("div","inputContainer"),o=d("div","inputSection"),a=d("div","inputWrapper"),r=d("textarea","","",{placeholder:"Ask me anything\u2026",rows:1,ariaLabel:"Type your message"});r.setValue=u=>{r.value=u,r.focus(),u.trim()!==""?(s.disabled=!1,g(s,"active")):(s.disabled=!0,g(s,""))};let i=d("div","loadingDots",[d("div","loadingDot"),d("div","loadingDot"),d("div","loadingDot")],{ariaLabel:"AI is thinking"}),s=f(x(20,ue),()=>A(e),"",{ariaLabel:"Send message"});s.disable(),s.enable=()=>{s.disabled=!1,g(s,"active")},s.disable=()=>{s.disabled=!0,g(s,"")};let l=f(x(20,he),()=>Me(),"",{ariaLabel:"Stop generating message"});l.disable(),l.enable=()=>{l.disabled=!1,g(l,"active sending")},l.disable=()=>{l.disabled=!0,g(l,"")},a.append(r,i,s,l),o.append(Se(),a);let c=[],m=f([x(24,ge),d("span","tooltip","Text Mode")],()=>{e.type!=="text"&&(te("text",e),c.forEach(u=>{g(u,"")}),g(m,"active"))},"",{ariaLabel:"Text mode"});e.type==="text"&&g(m,"active");let p=f([x(24,pe),d("span","tooltip","Image Mode")],()=>{e.type!=="image"&&(te("image",e),c.forEach(u=>{g(u,"")}),g(p,"active"))},"",{ariaLabel:"Image mode"});e.type==="image"&&g(p,"active"),c.push(m),c.push(p);let v=f([x(24,me),d("span","tooltip","Retry Last Message")],()=>{Te(e)},"",{ariaLabel:"Retry last message"});v.disable();let y=f([x(24,fe),d("span","tooltip","Clear Chat")],()=>{Ee()},"",{ariaLabel:"Clear chat"});y.disable();let h=d("div","options",[m,p,v,y],{ariaLabel:"Chat options",role:"toolbar"}),D=ve();return t.append(D),t.append(o,h),r.addEventListener("keydown",u=>{if(u.key==="Enter"){if(u.shiftKey)return;u.preventDefault(),A(e)}}),r.addEventListener("input",function(){this.style.height="auto",this.style.height=this.scrollHeight+"px",this.value.trim()!==""?(s.disabled=!1,g(s,"active")):(s.disabled=!0,g(s,""))}),o.addEventListener("dragover",u=>{u.preventDefault(),u.stopPropagation(),g(o,"inputSection dragOver")}),o.addEventListener("dragleave",u=>{u.preventDefault(),u.stopPropagation(),g(o,"inputSection")}),o.addEventListener("drop",async u=>{u.preventDefault(),u.stopPropagation(),g(o,"inputSection");let b=null,E=null,H=u.dataTransfer;if(!H)return;let oe=H.files;if(oe?.length>0){let S=oe[0];S.type.startsWith("image/")&&(b=S)}if(!b){let S=H.getData("text/uri-list");S&&(E=S)}if(b){await W(b);return}if(E){let S=new URL(window.location.href);if(!E.startsWith(S.origin)){await W(E,!0);return}try{let ae=await fetch(E);if(ae.ok){let z=await ae.blob();if(z.type.startsWith("image/")){let ke=new File([z],"image.png",{type:z.type});await W(ke)}}}catch{L("Failed to fetch an image")}return}L("Only image files are allowed")}),r.addEventListener("paste",async u=>{let b=u.clipboardData?.items;if(b){for(let E=0;E<b.length;E++)if(b[E].type.indexOf("image")!==-1){let H=b[E].getAsFile();if(H){u.preventDefault(),await W(H);break}}}}),n.modal.loadingIndicator=i,n.modal.messageInput=r,n.modal.sendBtn=s,n.modal.stopBtn=l,n.modal.modeButtons=c,n.modal.actionButtons=[v,y],t};var Ie=e=>{let t=d("div"),o=d("div","modai--root chat-modal","",{ariaLabel:"modAI Assistant chat dialog"});t.modal=o,n.modal=t,t.history=k.init(`${e.key}/${e.type}`,i=>K(i,e)),o.append(Le()),o.append(De()),o.append(Be(e));let a=d("div","disclaimer","AI can make mistakes. Please double-check responses.");o.append(a),t.appendChild(o),document.body.append(t),t.isDragging=!1,t.isLoading=!1,t.abortController=void 0,t.offsetX=0,t.offsetY=0;let r=t.history.getMessages().filter(i=>!i.hidden);return r.length>0&&(t.welcomeMessage.style.display="none",t.actionButtons.forEach(i=>{i.enable()}),r.forEach(i=>{i.el&&t.chatMessages.appendChild(i.el)})),setTimeout(()=>{j(),o.style.visibility="visible",t.messageInput.focus()},100),t};var Qe=["text","image"],Ae=e=>{if(n.modalOpen)return;if(!e.key){alert("key is required config property");return}e.type||(e.type="text"),e.availableTypes||(e.availableTypes=[e.type]),e.availableTypes=e.availableTypes.filter(o=>Qe.includes(o)),e.availableTypes.length>0&&!e.availableTypes.includes(e.type)&&e.availableTypes.unshift(e.type);let t=Ie(e);return window.x=t,t.api={sendMessage:async(o,a)=>{await A(e,o,a)},closeModal:()=>{V()}},n.modalOpen=!0,t};var M={createLoadingOverlay:U,localChat:Ae,generateButton:se};var Ze=(e,t)=>{let o=Ext.getCmp(e.firstElementChild?.id),a=M.generateButton.localChat({key:t,field:t,type:"image",resource:MODx.request.id,image:{mediaSource:o.imageBrowser.source},imageActions:{insert:(i,s)=>{o.imageBrowser.setValue(i.ctx.url),o.onImageChange(i.ctx.url),s.api.closeModal()}}}),r=M.generateButton.vision({input:o.altTextField.items.items[0].el.dom,field:t,image:o.imagePreview.el.dom,onUpdate:i=>{o.altTextField.items.items[0].setValue(i.content),o.image.altTag=i.content,o.updateValue()}});r.style.marginTop="6px",o.altTextField.el.dom.style.display="flex",o.altTextField.el.dom.style.justifyItems="center",o.altTextField.el.dom.style.alignItems="center",o.el.dom.parentElement?.parentElement?.parentElement?.querySelector("label")?.appendChild(a),o.altTextField.el.dom.appendChild(r)},et=()=>{Ext.getCmp("modx-resource-content").el.dom.querySelector("label")?.appendChild(M.generateButton.localChat({key:"res.content",field:"res.content",type:"text",availableTypes:["text","image"],resource:MODx.request.id}))},tt=e=>{let t=Ext.getCmp("modx-panel-resource").getForm();for(let[o,a]of e.tvs||[]){let r=Ext.get(`tv${o}-tr`);if(!r)continue;let i=t.findField(`tv${o}`),s=`tv.${a}`;if(!i){let l=r.dom.querySelector(".imageplus-panel-input");l&&Ze(l,s);continue}if(i.xtype==="textfield"||i.xtype==="textarea"){let l=MODx.config[`modai.tv.${a}.text.prompt`],c=r.dom.querySelector("label");if(!c)return;l?c.appendChild(M.generateButton.forcedText({input:i.el.dom,resourceId:MODx.request.id,field:s,initialValue:i.getValue(),onChange:(m,p)=>{let v=i.getValue();i.setValue(m.value),i.fireEvent("change",i,m.value,v),p&&(i.el.dom.scrollTop=i.el.dom.scrollHeight)}})):c.appendChild(M.generateButton.localChat({key:s,field:s,type:"text",availableTypes:["text","image"],resource:MODx.request.id}))}if(i.xtype==="modx-panel-tv-image"){let l=M.generateButton.localChat({key:s,field:s,type:"image",resource:MODx.request.id,image:{mediaSource:i.source},imageActions:{insert:(m,p)=>{let v={relativeUrl:m.ctx.url,url:m.ctx.url};i.items.items[1].fireEvent("select",v),i.fireEvent("select",v),p.api.closeModal()}}}),c=r.dom.querySelector("label");if(!c)return;c.appendChild(l)}}},ot=e=>{let t={pagetitle:["modx-resource-pagetitle"],longtitle:["modx-resource-longtitle","seosuite-longtitle"],introtext:["modx-resource-introtext"],description:["modx-resource-description","seosuite-description"],content:["modx-resource-content"]};for(let o of e.resourceFields||[])if(t[o]){if(o==="content"){et();continue}t[o].forEach(a=>{let r=Ext.getCmp(a);r&&r.label.appendChild(M.generateButton.forcedText({resourceId:MODx.request.id,field:`res.${o}`,input:r.el.dom,initialValue:r.getValue(),onChange:(i,s)=>{let l=r.getValue();r.setValue(i.value),r.fireEvent("change",r,i.value,l),s&&(r.el.dom.scrollTop=r.el.dom.scrollHeight)}}))})}},He=e=>{ot(e),tt(e)};var at=e=>(n.config=e,{chatHistory:k,history:G,executor:T,ui:M,initOnResource:He});return $e(nt);})();
