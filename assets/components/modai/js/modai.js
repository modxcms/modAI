"use strict";var ModAI=(()=>{var Q=Object.defineProperty;var Fe=Object.getOwnPropertyDescriptor;var je=Object.getOwnPropertyNames;var $e=Object.prototype.hasOwnProperty;var Ve=(e,t)=>{for(var o in t)Q(e,o,{get:t[o],enumerable:!0})},We=(e,t,o,a)=>{if(t&&typeof t=="object"||typeof t=="function")for(let n of je(t))!$e.call(e,n)&&n!==o&&Q(e,n,{get:()=>t[n],enumerable:!(a=Fe(t,n))||a.enumerable});return e};var qe=e=>We(Q({},"__esModule",{value:!0}),e);var ut={};Ve(ut,{init:()=>mt});var b={},Ge=(e,t,o,a=!1)=>{let n=b[e];if(!n)return;let r=typeof o=="string",i={__type:"UserMessage",content:r?o:o.content,contexts:r?void 0:o.contexts,attachments:r?void 0:o.attachments,role:"user",id:t,hidden:a,ctx:{}},l=n.history.push(i)-1;t&&(n.idRef[t]=n.history[l]),i.el=n.onAddMessage(i)},Je=(e,t,o,a=!1)=>{let n=b[e];if(!n)return;let r={__type:"ToolResponseMessage",content:o,role:"tool",id:t,hidden:a,ctx:{}},i=n.history.push(r)-1;t&&(n.idRef[t]=n.history[i]),r.el=n.onAddMessage(r)},re=(e,t,o,a,n,r=!1)=>{let i=b[e];if(!i)return;let l={__type:"AssistantMessage",content:o,toolCalls:a,contentType:n,role:"assistant",id:t,hidden:r,ctx:{}},p=i.history.push(l)-1;t&&(i.idRef[t]=i.history[p]),l.el=i.onAddMessage(l)},Ke=(e,t,o)=>{let a=b[e];if(!a)return;if(!a.idRef[t]){re(e,t,o,void 0,"text",!1);return}let n=a.idRef[t];n.content=o,n.__type==="AssistantMessage"&&n.el&&n.el.update&&n.el.update(n)},ze=(e,t)=>{let o=b[e];if(o)return o.idRef[t]},I={init:(e,t)=>(b[e]||(b[e]={history:[],idRef:{},onAddMessage:t}),b[e].onAddMessage=t,{addUserMessage:(o,a=!1)=>{let n="user-msg-"+Date.now()+Math.round(Math.random()*1e3);Ge(e,n,o,a)},addAssistantMessage:(o,a,n,r,i=!1)=>{re(e,o,a,n,r,i)},addToolResponseMessage:(o,a,n=!1)=>{Je(e,o,a,n)},updateAssistantMessage:(o,a)=>{Ke(e,o,a)},getAssistantMessage:o=>ze(e,o),getMessages:()=>b[e].history,getMessagesHistory:()=>b[e].history.map(o=>({role:o.role,content:o.content,toolCalls:o.toolCalls,contexts:o.contexts,attachments:o.attachments})),clearHistory:()=>{b[e].history.forEach(o=>{o.el?.remove()}),b[e].history=[]},clearHistoryFrom:o=>{let a=b[e].history.findIndex(n=>n.id===o);if(a!==-1){for(let n=a;n<b[e].history.length;n++)b[e].history[n].el?.remove();b[e].history.splice(a)}}})};var s={modalOpen:!1,alertOpen:!1,config:{},modal:{}};var d=(e,t)=>(s.config.translateFn||_)(e,t);var G=(e,t,o)=>{if(!e||!t)throw new Error(d("modai.error.service_required"));let a=o?"stream":"buffered",n=e,r=t;if(!k[a]?.[n]?.[r])throw new Error(d("modai.error.service_unsupported"));return{service:n,parser:r,mode:a}},k={buffered:{chatgpt:{content:e=>{let t=e?.choices?.[0]?.message?.content,o=e?.choices?.[0]?.message?.tool_calls;if(!t&&!o)throw new Error(d("modai.error.failed_request"));let a=e.id;return o?t?{__type:"TextDataMaybeTools",id:a,content:t,toolCalls:o.map(n=>({id:n.id,name:n.function.name,arguments:n.function.arguments})),usage:{completionTokens:e?.usage.completion_tokens,promptTokens:e?.usage.prompt_tokens}}:{__type:"ToolsData",id:a,toolCalls:o.map(n=>({id:n.id,name:n.function.name,arguments:n.function.arguments})),usage:{completionTokens:e?.usage.completion_tokens,promptTokens:e?.usage.prompt_tokens}}:{__type:"TextDataNoTools",id:a,content:t,usage:{completionTokens:e?.usage.completion_tokens,promptTokens:e?.usage.prompt_tokens}}},image:e=>{let t=e?.data?.[0]?.url;if(!t){if(t=e?.data?.[0]?.b64_json,!t)throw new Error(d("modai.error.failed_request"));t=`data:image/png;base64,${t}`}return{__type:"ImageData",id:crypto.randomUUID(),url:t}}},claude:{content:e=>{let t,o=[];if(e?.content?.map(n=>{n.type==="text"&&(t=n.text),n.type==="tool_use"&&o.push({id:n.id,name:n.name,arguments:JSON.stringify(n.input)})}),!t&&o.length===0)throw new Error(d("modai.error.failed_request"));let a=e.id;return o.length===0?{__type:"TextDataNoTools",id:a,content:t,usage:{completionTokens:e?.usage.output_tokens,promptTokens:e?.usage.input_tokens}}:t?{__type:"TextDataMaybeTools",id:a,toolCalls:o,content:t,usage:{completionTokens:e?.usage.output_tokens,promptTokens:e?.usage.input_tokens}}:{__type:"ToolsData",id:a,toolCalls:o,usage:{completionTokens:e?.usage.output_tokens,promptTokens:e?.usage.input_tokens}}}},gemini:{content:e=>{let t="",o;if(!e?.candidates?.[0]?.content?.parts)throw new Error(d("modai.error.failed_request"));for(let a of e.candidates[0].content.parts){if(a.text){t+=a.text;continue}a.functionCall&&(o||(o=[]),o.push({id:crypto.randomUUID(),name:a.functionCall.name,arguments:JSON.stringify(a.functionCall.args)}))}if(!t&&!o)throw new Error(d("modai.error.failed_request"));return o?t?{__type:"TextDataMaybeTools",id:crypto.randomUUID(),content:t,toolCalls:o,usage:{completionTokens:e?.usageMetadata.candidatesTokenCount,promptTokens:e?.usageMetadata.promptTokenCount}}:{__type:"ToolsData",id:crypto.randomUUID(),toolCalls:o,usage:{completionTokens:e?.usageMetadata.candidatesTokenCount,promptTokens:e?.usageMetadata.promptTokenCount}}:{__type:"TextDataNoTools",id:crypto.randomUUID(),content:t,usage:{completionTokens:e?.usageMetadata.candidatesTokenCount,promptTokens:e?.usageMetadata.promptTokenCount}}},image:e=>{let t=e?.predictions?.[0]?.bytesBase64Encoded;if(!t)throw new Error(d("modai.error.failed_request"));return{__type:"ImageData",id:crypto.randomUUID(),url:`data:image/png;base64,${t}`}}}},stream:{chatgpt:{content:(e,t)=>{if(e?.usage&&(t.usage={completionTokens:e?.usage?.completion_tokens||0,promptTokens:e?.usage?.prompt_tokens||0}),!e?.choices?.[0]?.delta?.tool_calls&&!e?.choices?.[0]?.delta?.content)return t;let o="",a=t.toolCalls||void 0;if(e?.choices?.[0]?.delta?.tool_calls?.[0]){a||(a=[]);let n=e.choices[0].delta.tool_calls[0];a[n.index]||(a[n.index]={id:"",name:"",arguments:""}),n.id&&(a[n.index].id=n.id),n.function.name&&(a[n.index].name=n.function.name),n.function.arguments&&(a[n.index].arguments+=n.function.arguments)}return e?.choices?.[0]?.delta?.content&&(o=e?.choices?.[0]?.delta?.content),{__type:"TextDataMaybeTools",id:t.id,content:(t.content??"")+o,toolCalls:a,usage:{completionTokens:t.usage.completionTokens??0,promptTokens:t.usage.promptTokens??0}}}},claude:{content:(e,t)=>{let o="",a=t.toolCalls||void 0;return e.type==="content_block_start"&&e.content_block.type==="tool_use"&&(a||(a=[]),a[e.index]={id:e.content_block.id,name:e.content_block.name,arguments:""}),e.type==="content_block_delta"&&e.delta.type==="text_delta"&&(o=e.delta.text||""),e.type==="content_block_delta"&&e.delta.type==="input_json_delta"&&(a||(a=[]),a[e.index].arguments=a[e.index].arguments+e.delta.partial_json),{__type:"TextDataMaybeTools",id:t.id,content:(t.content??"")+o,toolCalls:a,usage:{completionTokens:t.usage.completionTokens||0,promptTokens:t.usage.promptTokens||0}}}},gemini:{content:(e,t)=>{let o="",a=t.toolCalls||void 0;if(e?.candidates?.[0]?.content?.parts)for(let n of e.candidates[0].content.parts){if(n.text){o+=n.text;continue}n.functionCall&&(a||(a=[]),a.push({id:crypto.randomUUID(),name:n.functionCall.name,arguments:JSON.stringify(n.functionCall.args)}))}return{__type:"TextDataMaybeTools",id:t.id,content:(t.content||"")+o,toolCalls:a,usage:{completionTokens:e?.usageMetadata.candidatesTokenCount,promptTokens:e?.usageMetadata.promptTokenCount}}}}}};var Xe={gemini:(e,t,o,a)=>{let n=e.trim().split(`,\r
`).map(r=>r.replace(/^\[|]$/g,"")).filter(r=>r.trim()!=="");for(let r of n)try{let i=JSON.parse(r);o=k.stream.gemini.content(i,o),a&&o.content&&a(o)}catch{}return{buffer:t,currentData:o}},chatgpt:(e,t,o,a)=>{t+=e;let n=0,r;for(;(r=t.indexOf(`
`,n))!==-1;){let i=t.slice(n,r).trim();if(n=r+1,i.startsWith("data: ")){let l=i.slice(6);if(l==="[DONE]")continue;try{let p=JSON.parse(l);o=k.stream.chatgpt.content(p,o),a&&o?.content&&a(o)}catch{}}}return{buffer:t.slice(n),currentData:o}},claude:(e,t,o,a)=>{t+=e;let n=0,r;for(;(r=t.indexOf(`
`,n))!==-1;){let i=t.slice(n,r).trim();if(n=r+1,i.startsWith("data: ")){let l=i.slice(6);try{let p=JSON.parse(l);if(p.type==="message_start"){o.id=p.message.id,o.usage={promptTokens:p.message.usage.input_tokens,completionTokens:0};continue}if(p.type==="message_delta"){o.usage.completionTokens=p.usage.output_tokens;continue}if(p.type!=="content_block_delta"&&p.type!=="content_block_start")continue;o=k.stream.claude.content(p,o),a&&o.content&&a(o)}catch{}}}return{buffer:t.slice(n),currentData:o}}},J=async(e,t,o,a)=>{if(!e.body)throw new Error("Response body is empty");let n=e.body.getReader(),r=new TextDecoder("utf-8"),i="",l={id:`${t}-${Date.now()}-${Math.round(Math.random()*1e3)}`,usage:{completionTokens:0,promptTokens:0}},p=Xe[t];if(!p)throw new Error(d("modai.error.service_unsupported"));for(;!a?.aborted;){let{done:h,value:m}=await n.read();if(h)break;let f=r.decode(m,{stream:!0}),g=p(f,i,l,o);i=g.buffer,l=g.currentData}return l.toolCalls&&(l.toolCalls=l.toolCalls.filter(Boolean)),l};var ie=async e=>{if(!e.ok){let t=await e.json();throw t?.error?new Error(t.error.message):new Error(`${e.status} ${e.statusText}`)}},le=async(e,t,o)=>{o=o||new AbortController;let a=o.signal;if(typeof e=="string")return e;let{forExecutor:n}=e,r=async f=>{let g=await fetch(f.url,{signal:a,method:"POST",body:f.body,headers:f.headers});await ie(g);let u=await g.json();if(u.error)throw new Error(u.error.message);return u},i=async f=>{if(n.parser!=="content")throw new Error(d("modai.error.service_unsupported"));let g=await fetch(f.url,{signal:a,method:"POST",body:f.body,headers:f.headers});return await ie(g),J(g,n.service,t,a)},{service:l,parser:p,mode:h}=G(n.service,n.parser,n.stream);if(h==="stream")return await i(n);let m=await r(n);return k[h][l][p](m)};var Z=async(e,t,o)=>{o=o||new AbortController;let a=o.signal,n=await fetch(`${s.config.apiURL}?action=${e}`,{signal:a,method:"POST",body:JSON.stringify(t),headers:{"Content-Type":"application/json"}});if(!n.ok){let r=await n.json();throw r.error?new Error(r.error.message):new Error(r.detail)}return await n.json()},U=async(e,t,o,a)=>{a=a||new AbortController;let n=a.signal,r=await fetch(`${s.config.apiURL}?action=${e}`,{signal:n,method:"POST",body:JSON.stringify(t),headers:{"Content-Type":"application/json"}});if(!r.ok){let m=await r.json();throw m.error?new Error(m.error.message):new Error(m.detail)}let i=parseInt(r.headers.get("x-modai-stream")??"0")===1;if(!(parseInt(r.headers.get("x-modai-proxy")??"0")===1)){let m=await r.json();return le(m,o,a)}let p=r.headers.get("x-modai-service")??"chatgpt",h=r.headers.get("x-modai-parser")??"content";try{let{service:m,parser:f,mode:g}=G(p,h,i);if(g==="stream"){if(f!=="content")throw new Error(d("modai.error.service_unsupported"));return await J(r,m,o,n)}let u=await r.json();return k.buffered[m][f](u)}catch(m){throw a.abort(),m}};var w={mgr:{download:{image:async e=>await Z("Download\\Image",e)},tools:{run:async(e,t)=>await Z("Tools\\Run",{toolCalls:e},t)},prompt:{freeText:async(e,t,o)=>U("Prompt\\Chat",e,t,o),chat:async(e,t,o)=>U("Prompt\\Chat",e,t,o),text:async(e,t,o)=>U("Prompt\\Text",e,t,o),vision:async(e,t,o)=>U("Prompt\\Vision",e,t,o),image:async(e,t)=>U("Prompt\\Image",e,void 0,t)}}};var T={},K={_formatOutput(e,t){let o=T[e],a=o.visible>0,n=o.visible!==o.values.length-1;return{value:t!==void 0?t:o.values[o.visible]??null,nextStatus:n,prevStatus:a,current:o.visible+1,total:o.values.length,context:o.context}},insert(e,t,o=!1){let a=T[e];o||(a.visible=a.values.push(t)-1);let n=this._formatOutput(e,t);return typeof a.syncUI=="function"&&a.syncUI(n,o),n},next(e){let t=T[e];if(t.visible===t.values.length-1)return this._formatOutput(e);t.visible++;let o=this._formatOutput(e);return typeof t.syncUI=="function"&&t.syncUI(o),o},prev(e){let t=T[e];if(t.visible<=0)return this._formatOutput(e);t.visible--;let o=this._formatOutput(e);return typeof t.syncUI=="function"&&t.syncUI(o),o},init(e,t,o,a){return T[e]||(T[e]={visible:-1,values:[],context:a}),T[e].syncUI=t,o&&(T[e].values=[o],T[e].visible=0),{cachedItem:T[e],getData:()=>this._formatOutput(e),getAll:()=>T[e].values,syncUI:()=>{typeof T[e].syncUI=="function"&&T[e].syncUI(this._formatOutput(e),!1)},insert:(n,r=!1)=>this.insert(e,n,r),next:()=>this.next(e),prev:()=>this.prev(e)}}};var y=(e,t)=>{e.className=t},c=(e,t,o,a)=>{let n=typeof o=="string"?o:"";o&&typeof o!="string"&&!Array.isArray(o)&&(o=[o]);let r=document.createElement(e);if(a&&Object.assign(r,a),t&&(r.className=t),n)r.textContent=n;else if(o&&Array.isArray(o)){for(let i of o)if(i){if(typeof i=="string"){r.append(document.createTextNode(i));continue}r.append(i)}}return r},A=e=>/<[^>]*>/g.test(e)?e:e.replace(/\r\n|\n|\r/g,"<br>");var v=(e,t,o,a)=>{let n=typeof e=="string"?e:"";typeof e!="string"&&!Array.isArray(e)&&(e=[e]);let r=c("button",o,n);return r.type="button",Array.isArray(e)&&e.forEach(i=>{typeof i=="string"?r.append(document.createTextNode(i)):r.append(i)}),r.addEventListener("click",t),r.enable=()=>{r.disabled=!1},r.disable=()=>{r.disabled=!0},a&&Object.assign(r,a),r};var R=(e,t)=>{let o=c("div"),a=o.attachShadow({mode:"open"});o.style.display="none";let n=c("link",void 0,"",{rel:"stylesheet",type:"text/css",href:s.config.cssURL});return a.appendChild(n),n.onload=()=>{e?o.style.display="inline-block":o.style.display="",t&&t()},{shadow:o,shadowRoot:a}};var O=e=>{e={showConfirm:!0,showCancel:!0,...e};let{shadow:t,shadowRoot:o}=R(!1,()=>{e.showConfirm&&n.focus(),!e.showConfirm&&e.showCancel&&a.focus()}),a=v(e.cancelText??d("modai.ui.cancel"),()=>{l()},"cancelBtn",{tabIndex:-1}),n=v(e.confirmText,()=>{i(),e.onConfirm()},"confirmBtn",{tabIndex:-1}),r=c("div","modai--root overlay",[c("div","dialog",[c("h3","title",e.title),c("p","message",e.content),c("div","buttons",[e.showCancel&&a,e.showConfirm&&n])],{tabIndex:-1})],{ariaModal:"true",role:"dialog",ariaLabel:e.title}),i=()=>{document.removeEventListener("keydown",h),r.remove(),t.remove()},l=()=>{i(),e.onCancel?.()},p=[];e.showCancel&&p.push(a),e.showConfirm&&p.push(n);let h=m=>{if(m.key==="Escape"&&(m.stopImmediatePropagation(),m.preventDefault(),m.stopPropagation(),l()),m.key==="Tab"){let f=o.activeElement,g=f?p.indexOf(f):-1;m.shiftKey?g=(g-1+p.length)%p.length:g=(g+1)%p.length,p.length>0&&p[g].focus(),m.preventDefault()}};document.addEventListener("keydown",h),o.appendChild(r),document.body.append(t)};var x=(e,t)=>{let o=c("div","icon");return o.style.width=`${e}px`,o.style.height=`${e}px`,o.innerHTML=t.trim(),o};var de='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-check"><path d="M20 6 9 17l-5-5"></path></svg>',ce='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-chevron-down"><path d="m6 9 6 6 6-6"></path></svg>',z='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-copy"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg>',pe='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-pencil"><path d="M21.174 6.812a1 1 0 0 0-3.986-3.987L3.842 16.174a2 2 0 0 0-.5.83l-1.321 4.352a.5.5 0 0 0 .623.622l4.353-1.32a2 2 0 0 0 .83-.497z"></path><path d="m15 5 4 4"></path></svg>',me='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-image"><rect width="18" height="18" x="3" y="3" rx="2" ry="2"></rect><circle cx="9" cy="9" r="2"></circle><path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"></path></svg>',ee='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-circle-plus"><circle cx="12" cy="12" r="10"></circle><path d="M8 12h8"></path><path d="M12 8v8"></path></svg>',ue='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-refresh-cw"><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"></path><path d="M21 3v5h-5"></path><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"></path><path d="M8 16H3v5"></path></svg>',ge='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-arrow-up"><path d="m5 12 7-7 7 7"></path><path d="M12 19V5"></path></svg>',he='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-square"><rect width="18" height="18" x="3" y="3" rx="2"></rect></svg>',fe='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-text"><path d="M17 6.1H3"></path><path d="M21 12.1H3"></path><path d="M15.1 18H3"></path></svg>',ye='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-trash"><path d="M3 6h18"></path><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"></path><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"></path></svg>',xe='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-triangle-alert"><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3"></path><path d="M12 9v4"></path><path d="M12 17h.01"></path></svg>',ve='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-x"><path d="M18 6 6 18"></path><path d="m6 6 12 12"></path></svg>',Ce='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-sparkle"><path d="M9.937 15.5A2 2 0 0 0 8.5 14.063l-6.135-1.582a.5.5 0 0 1 0-.962L8.5 9.936A2 2 0 0 0 9.937 8.5l1.582-6.135a.5.5 0 0 1 .963 0L14.063 8.5A2 2 0 0 0 15.5 9.937l6.135 1.581a.5.5 0 0 1 0 .964L15.5 14.063a2 2 0 0 0-1.437 1.437l-1.582 6.135a.5.5 0 0 1-.963 0z"></path></svg>',be='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="4" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-arrow-left"><path d="m12 19-7-7 7-7"></path><path d="M19 12H5"></path></svg>',we='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="4" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-arrow-right"><path d="M5 12h14"></path><path d="m12 5 7 7-7 7"></path></svg>';var P=(e,t={})=>{let o={indicatorType:t.indicatorType||"spinner",overlayColor:t.overlayColor||"rgba(255, 255, 255, 0.7)",indicatorColor:t.indicatorColor||"#3498db"},a=document.createElement("div"),n=document.createElement("div"),r=window.getComputedStyle(e),i=e.getBoundingClientRect();t.indicatorColor||(o.indicatorType=i.height<=50?"dots":"spinner"),a.style.position="absolute",a.style.top="0",a.style.left="0",a.style.width="100%",a.style.height="100%",a.style.backgroundColor=o.overlayColor,a.style.display="flex",a.style.justifyContent="center",a.style.alignItems="center",a.style.zIndex="10000",a.style.borderRadius=r.borderRadius;let l="";if(o.indicatorType==="spinner")n.style.border="4px solid #f3f3f3",n.style.borderTop=`4px solid ${o.indicatorColor}`,n.style.borderRadius="50%",n.style.width="30px",n.style.height="30px",n.style.animation="modai--loading-overlay_spin 1s linear infinite",l=`
      @keyframes modai--loading-overlay_spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }
    `;else if(o.indicatorType==="dots"){n.style.display="flex",n.style.alignItems="center",n.style.justifyContent="center",n.style.height="20px";for(let g=0;g<3;g++){let u=document.createElement("div");u.style.width="8px",u.style.height="8px",u.style.borderRadius="50%",u.style.backgroundColor=o.indicatorColor,u.style.margin="0 4px",u.style.animation="modai--loading-overlay_dot-pulse 1.4s infinite ease-in-out",u.style.animationDelay=`${g*.2}s`,n.appendChild(u)}l=`
      @keyframes modai--loading-overlay_dot-pulse {
        0%, 80%, 100% { transform: scale(0); opacity: 0.5; }
        40% { transform: scale(1); opacity: 1; }
      }
    `}let p=document.createElement("style");p.textContent=l,document.head.appendChild(p),a.appendChild(n);let h=window.getComputedStyle(e.parentElement),m;["relative","absolute","fixed"].indexOf(h.position)===-1?(m=document.createElement("div"),m.style.position="relative",m.style.width=`${i.width}px`,m.style.height=`${i.height}px`,m.style.display="inline-block",e.parentNode?.insertBefore(m,e),m.appendChild(e)):m=e.parentElement,a.style.display="none",m.appendChild(a);let f=e.getBoundingClientRect();return m!==e.parentElement&&(m.style.width=`${f.width}px`,m.style.height=`${f.height}px`),a.style.display="flex",e.setAttribute("disabled","disabled"),()=>{a.style.display="none",e.removeAttribute("disabled"),a.remove(),p.remove(),m!==e.parentElement&&(m.parentNode?.insertBefore(e,m),m.remove())}};var te=e=>{let{shadow:t,shadowRoot:o}=R(!0),a=c("div","modai--root generate",v(x(14,Ce),e,"btn",{type:"button",title:d("modai.ui.generate_using_ai")}));return o.appendChild(a),{shadow:t,shadowRoot:o,generate:a}},Ye=e=>{let t=v(x(14,be),()=>{e.prev()},"history--prev",{type:"button",title:d("modai.ui.previous_version"),role:"navigation"}),o=v(x(14,we),()=>{e.next()},"history--next",{type:"button",title:d("modai.ui.next_version"),role:"navigation"}),a=c("div");a.update=(r,i)=>{a.innerText=`${r}/${i}`};let n=c("div","history--wrapper");return n.show=()=>{n.style.display="inline-flex"},n.hide=()=>{n.style.display="none"},n.prevButton=t,n.nextButton=o,n.info=a,n.appendChild(t),n.appendChild(o),n.appendChild(a),n.hide(),t.disable(),o.disable(),n},Qe=e=>{let{shadow:t}=te(()=>{E.localChat(e)});return e.targetEl.appendChild(t),t},Ze=({targetEl:e,input:t,onChange:o,initialValue:a,field:n,...r})=>{let{shadow:i,generate:l}=te(async()=>{let m=P(t);try{let f=await w.mgr.prompt.text({field:n,...r},g=>{p.insert(g.content,!0)});p.insert(f.content),m()}catch(f){m(),O({title:"Failed",content:d("modai.error.failed_try_again",{msg:f instanceof Error?f.message:""}),confirmText:"Close",showCancel:!1,onConfirm:()=>{}})}}),p=K.init(n,(m,f)=>{m.context.els.forEach(({wrapper:g,onFieldChange:u})=>{u(m,f),m.total>0&&g.historyNav.show(),g.historyNav.info.update(m.current,m.total);let C=g.shadowRoot||g.ownerDocument,M=!m.prevStatus&&C.activeElement===g.historyNav.prevButton,L=!m.nextStatus&&C.activeElement===g.historyNav.nextButton;m.prevStatus?g.historyNav.prevButton.enable():g.historyNav.prevButton.disable(),m.nextStatus?g.historyNav.nextButton.enable():g.historyNav.nextButton.disable(),M&&g.historyNav.nextButton.focus(),L&&g.historyNav.prevButton.focus()})},a,{});p.cachedItem.context.els||(p.cachedItem.context.els=[]),p.cachedItem.context.els.push({onFieldChange:o,wrapper:i});let h=Ye(p);return l.appendChild(h),i.historyNav=h,e.appendChild(i),i},et=e=>{let{shadow:t}=te(async()=>{let o=document.createElement("canvas"),a=o.getContext("2d");if(!a)return;o.width=e.image.width,o.height=e.image.height,a.drawImage(e.image,0,0);let n=o.toDataURL("image/png"),r=P(e.input);try{let i=await w.mgr.prompt.vision({image:n,field:e.field,namespace:e.namespace},l=>{e.onUpdate(l)});e.onUpdate(i),r()}catch(i){r(),O({title:d("modai.error.failed"),content:d("modai.error.failed_try_again",{msg:i instanceof Error?i.message:""}),confirmText:d("modai.ui.close"),showCancel:!1,onConfirm:()=>{}})}});return e.targetEl.appendChild(t),t},Te={localChat:Qe,forcedText:Ze,vision:et};var Me=e=>{s.modal.isDragging=!0;let o=s.modal.modal.getBoundingClientRect();s.modal.offsetX=e.clientX-o.left,s.modal.offsetY=e.clientY-o.top,document.body.style.userSelect="none"},N=e=>{if(!s.modal.isDragging)return;let t=s.modal.modal,o=e.clientX-s.modal.offsetX,a=e.clientY-s.modal.offsetY;t.style.left=o+"px",t.style.top=a+"px",t.style.transform="none"},F=()=>{s.modal.isDragging=!1,document.body.style.userSelect=""};var tt={loadingText:"Loading...",completedText:"Completed!",completedTextDuration:2e3,disabled:!1,disableCompletedState:!1},B=e=>{e={...tt,...e};let t=async()=>{let r=n.innerHTML,i=e.onClick(e.message,s.modal);if(i instanceof Promise){let l=c("span","spinner",[c("span","dot top"),c("span","dot right"),c("span","dot bottom"),c("span","dot left")]);o.innerHTML="",o.appendChild(l),a.innerHTML=e.loadingText||"",await i}e.disableCompletedState||(o.innerHTML=de,a.innerHTML=e.completedText||d("modai.ui.completed"),await new Promise(l=>setTimeout(l,2e3))),n.innerHTML=r},o=e.icon;o.ariaHidden="true";let a=c("div",void 0,e.label),n=v([o,a],t,"action-button",{ariaLabel:e.label,tabIndex:0});return e.disabled&&n.disable(),n};var _e=()=>{let e=c("div","scrollToBottomContainer",[v([c("div",void 0,d("modai.ui.scroll_to_bottom")),x(14,ce)],()=>{$(),j()})]);return s.modal.chatContainer.addEventListener("scroll",()=>{j()}),new MutationObserver(()=>{j()}).observe(s.modal.chatContainer,{childList:!0,subtree:!0}),s.modal.scrollWrapper=e,e},j=()=>{let t=s.modal.chatContainer.scrollHeight-s.modal.chatContainer.scrollTop-s.modal.chatContainer.clientHeight<10;s.modal.chatContainer.scrollHeight>s.modal.chatContainer.clientHeight&&!t?s.modal.scrollWrapper.style.display="flex":s.modal.scrollWrapper.style.display="none"};var ot=`
    html {
        width: 100%;
        max-width: 100%;
        padding: 0;
        margin: 0;
    }
    body {
        background-color: #F1F1F2;
        margin: 0;
        padding: 0;
        font-family: Arial, sans-serif;
        overflow-x: hidden;
        width: 100%;
        max-width: 100%;
        box-sizing: border-box;
    }
    * {
        box-sizing: border-box;
        max-width: 100%;
    }
    pre {
        white-space: pre-wrap;
        word-wrap: break-word;
        overflow-wrap: break-word;
        max-width: 100%;
        padding: 12px;
        margin: 0;
        background-color: #f5f7fa;
        border-radius: 5px;
        font-size: 14px;
    }
    img {
        max-width: 100%;
        height: auto;
        display: block;
    }
    code {
        white-space: pre-wrap;
        word-wrap: break-word;
        max-width: 100%;
        display: block;
        overflow-x: hidden;
        font-size: 14px;
    }
    table {
        width: 100%;
        max-width: 100%;
        overflow-x: hidden;
        display: block;
        border-collapse: collapse;
    }
    div {
        max-width: 100%;
        overflow-wrap: break-word;
        word-wrap: break-word;
        box-sizing: border-box;
    }
    p {
        margin: 0 0 0.5em 0;
        max-width: 100%;
    }
    h1, h2, h3, h4, h5, h6 {
        margin: 0 0 0.1em 0;
        max-width: 100%;
    }
`,Ee=(e,t=[])=>{let o=c("div");o.updateContent=i=>{a.innerHTML=A(i),j()};let a=c("div");a.innerHTML=A(e);let n=o.attachShadow({mode:"open"}),r=c("style");return r.textContent=ot,n.appendChild(r),t.forEach(i=>{n.appendChild(c("link",void 0,"",{rel:"stylesheet",type:"text/css",href:i}))}),n.append(a),o};var at=e=>{let t=c("div","message user"),o=e.content,a=[];for(let i of e.attachments??[])i.__type==="image"&&a.push(i.value);let n=c("div");if(n.innerHTML=A(o),t.appendChild(n),a){let i=c("div","imageRow");for(let l of a){let p=c("div"),h=c("img");h.src=l,p.appendChild(h),i.appendChild(p)}t.appendChild(i)}let r=c("div","actions");return r.appendChild(B({message:e,disabled:s.modal.isLoading,icon:x(14,z),label:d("modai.ui.copy"),completedText:d("modai.ui.copied"),onClick:oe})),r.appendChild(B({message:e,disabled:s.modal.isLoading,disableCompletedState:!0,icon:x(14,pe),label:d("modai.ui.edit"),onClick:i=>{s.alertOpen=!0,O({title:d("modai.ui.confirm_edit"),content:d("modai.ui.confirm_edit_content"),confirmText:d("modai.ui.edit_message"),onCancel:()=>{s.alertOpen=!1},onConfirm:()=>{s.alertOpen=!1,s.modal.messageInput.setValue(i.content),i.contexts&&i.contexts.forEach(l=>{s.modal.context.addContext(l)}),i.attachments&&i.attachments.forEach(l=>{l.__type==="image"&&s.modal.attachments.addImageAttachment(l.value)}),s.modal.history.clearHistoryFrom(i.id),s.modal.history.getMessages().length===0&&(s.modal.welcomeMessage.style.display="block")}})}})),t.appendChild(r),t.update=i=>{let l=Array.isArray(i.content)?i.content[0].value:i.content;n.innerHTML=A(l)},s.modal.chatMessages.appendChild(t),t},D=e=>{s.modal.welcomeMessage.style.display="none";let t=c("div","message error");t.appendChild(x(14,xe));let o=c("span");return o.textContent=e,t.appendChild(o),s.modal.chatMessages.appendChild(t),t},nt=(e,t)=>{let o=c("div","message ai");o.dataset.id=e.id;let a=Array.isArray(e.content)?e.content[0].value:e.content;e.contentType==="image"&&(a=`<img src="${a}" />`);let n=Ee(a,t.customCSS??[]);o.appendChild(n);let r=c("div","actions");if(t.type==="text"&&(t.textActions?.copy!==!1&&r.appendChild(B({message:e,disabled:s.modal.isLoading,icon:x(14,z),label:d("modai.ui.copy"),completedText:d("modai.ui.copied"),onClick:typeof t.textActions?.copy=="function"?t.textActions.copy:oe})),typeof t.textActions?.insert=="function"&&r.append(B({message:e,disabled:s.modal.isLoading,icon:x(14,ee),label:d("modai.ui.insert"),completedText:d("modai.ui.inserted"),onClick:t.textActions.insert}))),t.type==="image"){t.imageActions?.copy!==!1&&r.append(B({message:e,disabled:s.modal.isLoading,icon:x(14,z),label:d("modai.ui.copy"),loadingText:d("modai.ui.downloading"),completedText:d("modai.ui.copied"),onClick:async(l,p)=>{let h=typeof t.textActions?.copy=="function"?t.textActions.copy:oe;if(l.ctx.downloaded===!0){h(l,p);return}let m=await w.mgr.download.image({url:l.content,field:t.field,namespace:t.namespace,resource:t.resource,mediaSource:t.image?.mediaSource});l.content=m.fullUrl,l.ctx.downloaded=!0,l.ctx.url=m.url,l.ctx.fullUrl=m.fullUrl,h(l,p)}}));let i=t.imageActions?.insert;typeof i=="function"&&r.append(B({message:e,disabled:s.modal.isLoading,icon:x(14,ee),label:d("modai.ui.insert"),completedText:d("modai.ui.inserted"),loadingText:d("modai.ui.downloading"),onClick:async(l,p)=>{if(l.ctx.downloaded===!0){i(l,p);return}let h=await w.mgr.download.image({url:l.content,field:t.field,namespace:t.namespace,resource:t.resource,mediaSource:t.image?.mediaSource});l.content=h.fullUrl,l.ctx.downloaded=!0,l.ctx.url=h.url,l.ctx.fullUrl=h.fullUrl,i(l,p)}}))}return o.appendChild(r),s.modal.chatMessages.appendChild(o),o.update=i=>{let l=Array.isArray(i.content)?i.content[0].value:i.content,p=i.contentType==="image"?`<img src="${l}" />`:A(l);n.updateContent(p)},o},X=(e,t)=>{if(!e.hidden){if(e.__type==="UserMessage"){let o=at(e);return o.scrollIntoView({behavior:"smooth",block:"start"}),o}if(e.__type==="AssistantMessage")return nt(e,t)}},oe=async e=>{if(e.content)if(navigator.clipboard&&navigator.clipboard.writeText)try{await navigator.clipboard.writeText(e.content)}catch{D(d("modai.error.failed_copy"))}else try{let t=c("textarea");t.value=e.content,document.body.appendChild(t),t.select(),document.execCommand("copy"),document.body.removeChild(t)}catch{D(d("modai.error.failed_copy"))}};var V=e=>{s.modal.isLoading=e,e?s.modal.loadingIndicator.style.display="flex":s.modal.loadingIndicator.style.display="none",s.modal.messageInput.disabled=e,e?(s.modal.sendBtn.disable(),s.modal.stopBtn.enable(),s.modal.closeModalBtn.disable()):(s.modal.sendBtn.disable(),s.modal.stopBtn.disable(),s.modal.closeModalBtn.enable()),s.modal.modeButtons.forEach(a=>{e?a.disable():a.enable()});let t=s.modal.history.getMessages().length>0;s.modal.actionButtons.forEach(a=>{e||!t?a.disable():a.enable()}),s.modal.chatMessages.querySelectorAll(".action-button").forEach(a=>{e?a.disable?.():a?.enable?.()})};var W=()=>{s.modal.isLoading||(document.removeEventListener("mousemove",e=>N(e)),document.removeEventListener("mouseup",()=>F()),s.modal&&s.modal.remove(),s.modalOpen=!1)},ke=async(e,t,o)=>{s.modal.history.addAssistantMessage(crypto.randomUUID(),void 0,t,"text",!0);let a=await w.mgr.tools.run(t,o);s.modal.history.addToolResponseMessage(a.id,a.content,!0);let n=await w.mgr.prompt.chat({namespace:e.namespace,field:e.field||"",prompt:"",messages:s.modal.history.getMessagesHistory()},r=>{(r.__type==="TextDataNoTools"||r.__type==="TextDataMaybeTools")&&s.modal.history.updateAssistantMessage(r.id,r.content)},o);n.content&&s.modal.history.updateAssistantMessage(n.id,n.content),n.toolCalls&&await ke(e,n.toolCalls,s.modal.abortController)},H=async(e,t,o)=>{let a=t?t.trim():s.modal.messageInput.value.trim();if(!a||s.modal.isLoading)return;V(!0),s.modal.messageInput.value="",s.modal.messageInput.style.height="auto",s.modal.abortController=new AbortController,s.modal.welcomeMessage.style.display="none";let n=s.modal.attachments.attachments.length>0?s.modal.attachments.attachments.map(l=>({__type:l.__type,value:l.value})):void 0,r=s.modal.context.contexts.length>0?s.modal.context.contexts.map(l=>({__type:l.__type,name:l.name,renderer:l.renderer,value:l.value})):void 0;s.modal.attachments.removeAttachments(),s.modal.context.removeContexts();let i=s.modal.history.getMessagesHistory();s.modal.history.addUserMessage({content:a,attachments:n,contexts:r},o);try{if(e.type==="text"){let l=await w.mgr.prompt.chat({namespace:e.namespace,contexts:r,attachments:n,prompt:a,field:e.field||"",messages:i},p=>{p.content&&s.modal.history.updateAssistantMessage(p.id,p.content)},s.modal.abortController);l.content&&s.modal.history.updateAssistantMessage(l.id,l.content),l.toolCalls&&await ke(e,l.toolCalls,s.modal.abortController)}if(e.type==="image"){let l=await w.mgr.prompt.image({prompt:a},s.modal.abortController);s.modal.history.addAssistantMessage(l.id,l.url,void 0,"image")}s.modal.abortController=void 0}catch(l){if(l instanceof Error){if(l.name==="AbortError")return;V(!1),D(l.message);return}D(d("modai.error.unknown_error"))}V(!1),s.modal.messageInput.focus()},De=()=>{!s.modal.isLoading||!s.modal.abortController||(s.modal.abortController.abort(),s.modal.abortController=void 0,V(!1))},Le=e=>{if(s.modal.history.getMessages().length!==0){if(e.type==="text"){H(e,"Try again");return}if(e.type==="image"){let t=s.modal.history.getMessages().reverse().find(o=>o.role==="user");t&&H(e,t.content)}}},ae=(e,t)=>{for(t.type=e,s.modal.history=I.init(`${t.key}/${t.type}`,a=>X(a,t));s.modal.chatMessages.firstChild;)s.modal.chatMessages.removeChild(s.modal.chatMessages.firstChild);let o=s.modal.history.getMessages().filter(a=>!a.hidden);o.length>0?(s.modal.welcomeMessage.style.display="none",o.forEach(a=>{a.el&&s.modal.chatMessages.appendChild(a.el)}),s.modal.actionButtons.forEach(a=>{a.enable()})):(s.modal.welcomeMessage.style.display="block",s.modal.actionButtons.forEach(a=>{a.disable()})),$()},Se=()=>{s.modal.history.clearHistory(),s.modal.chatMessages.innerHTML="",s.modal.welcomeMessage.style.display="block",s.modal.actionButtons.forEach(e=>{e.disable()})},q=async(e,t=!1)=>{if(!t&&e instanceof File&&!e.type.startsWith("image/")){D(d("modai.error.only_image_files_are_allowed"));return}if(t){s.modal.attachments.addImageAttachment(e);return}let o=await new Promise((a,n)=>{let r=new FileReader;r.onload=function(i){a(i.target?.result)},r.onerror=function(i){n(i)},r.readAsDataURL(e)});s.modal.attachments.addImageAttachment(o)},$=()=>{s.modal.chatContainer.scrollTop=s.modal.chatContainer.scrollHeight};var Ae=()=>{let e=c("div","chatContainer","",{ariaLive:"polite"}),t=c("div","welcome",[c("p","greeting",s.config.name?d("modai.ui.greeting_with_name",{name:s.config.name}):d("modai.ui.greeting")),c("p","msg",d("modai.ui.welcome_msg"))]);e.append(t);let o=c("div","history","",{ariaLabel:d("modai.ui.conversation_history")});return e.append(o),s.modal.welcomeMessage=t,s.modal.chatMessages=o,s.modal.chatContainer=e,e};var Be=()=>{let e=v(x(24,ve),()=>{W()},"closeBtn",{ariaLabel:d("modai.ui.close_dialog")}),t=c("header","header",[c("h1","",d("modai.ui.modai_assistant")),e]);return t.addEventListener("mousedown",o=>{Me(o),document.addEventListener("mousemove",N),document.addEventListener("mouseup",()=>{F(),document.removeEventListener("mousemove",N),document.removeEventListener("mouseup",F)})}),document.addEventListener("keydown",o=>{s.alertOpen||o.key==="Escape"&&(o.preventDefault(),W())}),s.modal.closeModalBtn=e,t};var He=()=>{let e=c("div","attachmentsWrapper");return e.visible=!1,e.attachments=[],e.show=()=>{e.visible||(e.visible=!0,y(e,"attachmentsWrapper visible"))},e.hide=()=>{e.visible&&(e.visible=!1,y(e,"attachmentsWrapper"))},e.addImageAttachment=t=>{st(t)},e.removeAttachments=()=>{s.modal.attachments.attachments.forEach(t=>{s.modal.attachments.removeAttachment(t)})},e.addAttachment=t=>{e.show(),e.appendChild(t),e.attachments.push(t)},e.removeAttachment=t=>{let o=e.attachments.indexOf(t);o!==-1&&(t.remove(),e.attachments.splice(o,1),e.attachments.length===0&&e.hide())},s.modal.attachments=e,e},st=e=>{s.modal.attachments.attachments.length>0&&s.modal.attachments.removeAttachments();let t=c("div","imagePreview");t.__type="image",t.value=e;let o=c("img",void 0,"",{src:e}),a=c("button",void 0,"\xD7");a.addEventListener("click",n=>{n.stopPropagation(),s.modal.attachments.removeAttachment(t)}),t.append(o,a),s.modal.attachments.addAttachment(t)};var rt={selection:void 0},Ie=()=>{let e=c("div","contextsWrapper");return e.visible=!1,e.contexts=[],e.show=()=>{e.visible||(e.visible=!0,y(e,"contextsWrapper visible"))},e.hide=()=>{e.visible&&(e.visible=!1,y(e,"contextsWrapper"))},e.removeContexts=()=>{s.modal.context.contexts.forEach(t=>{s.modal.context.removeContext(t)})},e.addContexts=t=>{t.forEach(o=>{s.modal.context.addContext(o)})},e.addContext=t=>{let o=e.contexts.push(t),a=rt[t?.renderer||""];if(a){e.show();let n=a();e.contexts[o].el=n,e.appendChild(n)}},e.removeContext=t=>{let o=e.contexts.indexOf(t);o!==-1&&(t.el?.remove(),e.contexts.splice(o,1),(e.contexts.length===0||e.contexts.every(a=>a.el===void 0))&&e.hide())},s.modal.context=e,e};var Ue=e=>{let t=c("div","inputContainer"),o=c("div","inputSection"),a=c("div","inputWrapper"),n=c("textarea","","",{placeholder:d("modai.ui.prompt_placeholder"),rows:1,ariaLabel:d("modai.ui.prompt_label")});n.setValue=u=>{n.value=u,n.focus(),u.trim()!==""?(i.disabled=!1,y(i,"active")):(i.disabled=!0,y(i,""))};let r=c("div","loadingDots",[c("div","loadingDot"),c("div","loadingDot"),c("div","loadingDot")],{ariaLabel:d("modai.ui.loading_response")}),i=v(x(20,ge),()=>H(e),"",{ariaLabel:d("modai.ui.send_message")});i.disable(),i.enable=()=>{i.disabled=!1,y(i,"active")},i.disable=()=>{i.disabled=!0,y(i,"")};let l=v(x(20,he),()=>De(),"",{ariaLabel:d("modai.ui.stop_generating_response")});l.disable(),l.enable=()=>{l.disabled=!1,y(l,"active sending")},l.disable=()=>{l.disabled=!0,y(l,"")},a.append(n,r,i,l),o.append(He(),a),o.append(Ie(),a);let p=[];if(e.availableTypes?.includes("text")){let u=v([x(24,fe),c("span","tooltip",d("modai.ui.text_mode"))],()=>{e.type!=="text"&&(ae("text",e),p.forEach(C=>{y(C,"")}),y(u,"active"))},"",{ariaLabel:d("modai.ui.text_mode")});e.type==="text"&&y(u,"active"),p.push(u)}if(e.availableTypes?.includes("image")){let u=v([x(24,me),c("span","tooltip",d("modai.ui.image_mode"))],()=>{e.type!=="image"&&(ae("image",e),p.forEach(C=>{y(C,"")}),y(u,"active"))},"",{ariaLabel:d("modai.ui.image_mode")});e.type==="image"&&y(u,"active"),p.push(u)}let h=v([x(24,ue),c("span","tooltip",d("modai.ui.retry_last_message"))],()=>{Le(e)},"",{ariaLabel:d("modai.ui.retry_last_message")});h.disable();let m=v([x(24,ye),c("span","tooltip",d("modai.ui.clear_chat"))],()=>{Se()},"",{ariaLabel:d("modai.ui.clear_chat")});m.disable();let f=c("div","options",[...p,h,m],{ariaLabel:d("modai.ui.clear_options"),role:"toolbar"}),g=_e();return t.append(g),t.append(o,f),n.addEventListener("keydown",u=>{if(u.key==="Enter"){if(u.shiftKey)return;u.preventDefault(),H(e)}}),n.addEventListener("input",function(){this.style.height="auto",this.style.height=this.scrollHeight+"px",this.value.trim()!==""?(i.disabled=!1,y(i,"active")):(i.disabled=!0,y(i,""))}),o.addEventListener("dragover",u=>{u.preventDefault(),u.stopPropagation(),y(o,"inputSection dragOver")}),o.addEventListener("dragleave",u=>{u.preventDefault(),u.stopPropagation(),y(o,"inputSection")}),o.addEventListener("drop",async u=>{u.preventDefault(),u.stopPropagation(),y(o,"inputSection");let C=null,M=null,L=u.dataTransfer;if(!L)return;let ne=L.files;if(ne?.length>0){let S=ne[0];S.type.startsWith("image/")&&(C=S)}if(!C){let S=L.getData("text/uri-list");S&&(M=S)}if(C){await q(C);return}if(M){let S=new URL(window.location.href);if(!M.startsWith(S.origin)){await q(M,!0);return}try{let se=await fetch(M);if(se.ok){let Y=await se.blob();if(Y.type.startsWith("image/")){let Ne=new File([Y],"image.png",{type:Y.type});await q(Ne)}}}catch{D(d("modai.error.failed_to_fetch_image"))}return}D(d("modai.error.only_image_files_are_allowed"))}),n.addEventListener("paste",async u=>{let C=u.clipboardData?.items;if(C){for(let M=0;M<C.length;M++)if(C[M].type.indexOf("image")!==-1){let L=C[M].getAsFile();if(L){u.preventDefault(),await q(L);break}}}}),s.modal.loadingIndicator=r,s.modal.messageInput=n,s.modal.sendBtn=i,s.modal.stopBtn=l,s.modal.modeButtons=p,s.modal.actionButtons=[h,m],t};var Re=e=>{let{shadow:t,shadowRoot:o}=R(!0,()=>{$(),t.messageInput.focus()}),a=c("div","modai--root chat-modal","",{ariaLabel:d("modai.ui.modai_assistant_chat_dialog")});t.modal=a,s.modal=t,t.history=I.init(`${e.key}/${e.type}`,i=>X(i,e)),a.append(Be()),a.append(Ae()),a.append(Ue(e));let n=c("div","disclaimer",d("modai.ui.disclaimer"));a.append(n),o.appendChild(a),document.body.append(t),t.isDragging=!1,t.isLoading=!1,t.abortController=void 0,t.offsetX=0,t.offsetY=0;let r=t.history.getMessages().filter(i=>!i.hidden);return r.length>0&&(t.welcomeMessage.style.display="none",t.actionButtons.forEach(i=>{i.enable()}),r.forEach(i=>{i.el&&t.chatMessages.appendChild(i.el)})),t};var it=["text","image"],Oe=e=>{if(s.modalOpen)return;if(e.context&&(e.withContexts||(e.withContexts=[]),e.withContexts.push({__type:"selection",name:"Selection",renderer:"selection",value:e.context}),e.context=void 0),!e.key){alert(d("modai.error.key_required"));return}e.type||(e.type="text"),e.availableTypes||(e.availableTypes=[e.type]),e.availableTypes=e.availableTypes.filter(o=>it.includes(o)),e.availableTypes.length>0&&!e.availableTypes.includes(e.type)&&e.availableTypes.unshift(e.type);let t=Re(e);return t.api={sendMessage:async(o,a)=>{await H(e,o,a)},closeModal:()=>{W()}},e.withContexts&&s.modal.context.addContexts(e.withContexts),s.modalOpen=!0,t};var E={createLoadingOverlay:P,localChat:Oe,generateButton:Te};var lt=(e,t)=>{let o=Ext.getCmp(e.firstElementChild?.id),a=o.el.dom.parentElement?.parentElement?.parentElement?.querySelector("label");if(!a)return;E.generateButton.localChat({targetEl:a,key:t,field:t,type:"image",resource:MODx.request.id,image:{mediaSource:o.imageBrowser.source},imageActions:{insert:(r,i)=>{o.imageBrowser.setValue(r.ctx.url),o.onImageChange(r.ctx.url),i.api.closeModal()}}});let n=E.generateButton.vision({targetEl:o.altTextField.el.dom,input:o.altTextField.items.items[0].el.dom,field:t,image:o.imagePreview.el.dom,onUpdate:r=>{o.altTextField.items.items[0].setValue(r.content),o.image.altTag=r.content,o.updateValue()}});n.style.marginTop="6px",o.altTextField.el.dom.style.display="flex",o.altTextField.el.dom.style.justifyItems="center",o.altTextField.el.dom.style.alignItems="center"},dt=()=>{let t=Ext.getCmp("modx-resource-content").el.dom.querySelector("label");t&&E.generateButton.localChat({targetEl:t,key:"res.content",field:"res.content",type:"text",availableTypes:["text","image"],resource:MODx.request.id})},ct=e=>{let t=Ext.getCmp("modx-panel-resource").getForm();for(let[o,a]of e.tvs||[]){let n=Ext.get(`tv${o}-tr`);if(!n)continue;let r=t.findField(`tv${o}`),i=`tv.${a}`;if(!r){let l=n.dom.querySelector(".imageplus-panel-input");l&&lt(l,i);continue}if(r.xtype==="textfield"||r.xtype==="textarea"){let l=MODx.config[`modai.tv.${a}.text.prompt`],p=n.dom.querySelector("label");if(!p)return;l?E.generateButton.forcedText({targetEl:p,input:r.el.dom,resourceId:MODx.request.id,field:i,initialValue:r.getValue(),onChange:(h,m)=>{let f=r.getValue();r.setValue(h.value),r.fireEvent("change",r,h.value,f),m&&(r.el.dom.scrollTop=r.el.dom.scrollHeight)}}):E.generateButton.localChat({targetEl:p,key:i,field:i,type:"text",availableTypes:["text","image"],resource:MODx.request.id})}if(r.xtype==="modx-panel-tv-image"){let l=n.dom.querySelector("label");if(!l)return;E.generateButton.localChat({targetEl:l,key:i,field:i,type:"image",resource:MODx.request.id,image:{mediaSource:r.source},imageActions:{insert:(p,h)=>{let m={relativeUrl:p.ctx.url,url:p.ctx.url};r.items.items[1].fireEvent("select",m),r.fireEvent("select",m),h.api.closeModal()}}})}}},pt=e=>{let t={pagetitle:["modx-resource-pagetitle"],longtitle:["modx-resource-longtitle","seosuite-longtitle"],introtext:["modx-resource-introtext"],description:["modx-resource-description","seosuite-description"],content:["modx-resource-content"]};for(let o of e.resourceFields||[])if(t[o]){if(o==="content"){dt();continue}t[o].forEach(a=>{let n=Ext.getCmp(a);n&&E.generateButton.forcedText({targetEl:n.label,resourceId:MODx.request.id,field:`res.${o}`,input:n.el.dom,initialValue:n.getValue(),onChange:(r,i)=>{let l=n.getValue();n.setValue(r.value),n.fireEvent("change",n,r.value,l),i&&(n.el.dom.scrollTop=n.el.dom.scrollHeight)}})})}},Pe=e=>{pt(e),ct(e)};var mt=e=>(s.config=e,{chatHistory:I,history:K,executor:w,ui:E,lng:d,initOnResource:Pe});return qe(ut);})();
