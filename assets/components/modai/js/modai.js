var ModAI;(()=>{"use strict";var e={d:(t,n)=>{for(var o in n)e.o(n,o)&&!e.o(t,o)&&Object.defineProperty(t,o,{enumerable:!0,get:n[o]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t)},t={};e.d(t,{default:()=>G});const n={},o="assistant",a=(e,t,o,a,i=!1,s="text")=>{const r=n[e];if(!r)return;const l={content:t,role:o,id:a,hidden:i,type:s,ctx:{}},d=r.history.push(l)-1;a&&(r.idRef[a]=r.history[d]),l.el=r.onAddMessage(l)},i={init:(e,t)=>(n[e]||(n[e]={history:[],idRef:{},onAddMessage:t}),n[e].onAddMessage=t,{addUserMessage:(t,n,o="text")=>{const i="user-msg-"+Date.now()+Math.round(1e3*Math.random());a(e,t,"user",i,n,o)},addAssistantMessage:(t,n,i="text")=>{a(e,t,o,n,!1,i)},updateAssistantMessage:(t,i,s="text")=>{((e,t,i,s="text")=>{const r=n[e];if(!r)return;if(!r.idRef[t])return void a(e,i,o,t,!1,s);const l=r.idRef[t];l.content=i,l.el&&l.el.update&&l.el.update(l)})(e,t,i,s)},getAssistantMessage:t=>((e,t)=>{const o=n[e];if(o)return o.idRef[t]})(e,t),getMessages:()=>n[e].history,getMessagesHistory:()=>n[e].history.map((e=>({role:e.role,content:e.content}))),clearHistory:()=>{n[e].history.forEach((e=>{e.el?.remove()})),n[e].history=[]},clearHistoryFrom:t=>{const o=n[e].history.findIndex((e=>e.id===t));if(-1!==o){for(let t=o;t<n[e].history.length;t++){const o=n[e].history[t];o.el?.remove()}n[e].history.splice(o)}}})},s={modalOpen:!1,alertOpen:!1,config:{},modal:{}},r=e=>{s.modal.isLoading=e,s.modal.loadingIndicator.style.display=e?"flex":"none",s.modal.messageInput.disabled=e,e?(s.modal.sendBtn.disable(),s.modal.stopBtn.enable()):(s.modal.sendBtn.disable(),s.modal.stopBtn.disable()),s.modal.modeButtons.forEach((t=>{e?t.disable():t.enable()}));const t=s.modal.history.getMessages().length>0;s.modal.actionButtons.forEach((n=>{e||!t?n.disable():n.enable()})),s.modal.chatMessages.querySelectorAll(".action-button").forEach((t=>{e?t.disable?.():t?.enable?.()}))},l={buffered:{chatgpt:{content:e=>{const t=e?.choices?.[0]?.message?.content;if(!t)throw new Error(_("modai.cmp.failed_request"));return{id:e.id,content:t}},image:e=>{let t=e?.data?.[0]?.url;if(!t){if(t=e?.data?.[0]?.b64_json,!t)throw new Error(_("modai.cmp.failed_request"));t=`data:image/png;base64,${t}`}return{id:`chatgpt-${Date.now()}-${Math.round(1e3*Math.random())}`,url:t}}},claude:{content:e=>{const t=e?.content?.[0]?.text;if(!t)throw new Error(_("modai.cmp.failed_request"));return{id:e.id,content:t}}},gemini:{content:e=>{const t=e?.candidates?.[0]?.content?.parts?.[0]?.text;if(!t)throw new Error(_("modai.cmp.failed_request"));return{id:`gemini-${Date.now()}-${Math.round(1e3*Math.random())}`,content:t}},image:e=>{const t=e?.predictions?.[0]?.bytesBase64Encoded;if(!t)throw new Error(_("modai.cmp.failed_request"));return{id:`gemini-${Date.now()}-${Math.round(1e3*Math.random())}`,url:`data:image/png;base64,${t}`}}}},stream:{chatgpt:{content:(e,t)=>{const n=t?.content??"",o=e.choices?.[0]?.delta?.content||"";return{...t,id:e.id,content:`${n}${o}`}}},claude:{content:(e,t)=>{const n=t?.content??"",o=e.delta?.text||"";return{...t,content:`${n}${o}`}}},gemini:{content:(e,t)=>{const n=t?.content??"",o=e.candidates?.[0]?.content?.parts?.[0]?.text||"";return{...t,content:`${n}${o}`}}}}},d=async e=>{if(!e.ok){const t=await e.json();if(t?.error)throw new Error(t.error.message);throw new Error(`${e.status} ${e.statusText}`)}},c=async(e,t,n,o,a)=>{if(!e.body)throw new Error("failed");const i=e.body.getReader(),s=new TextDecoder("utf-8");let r="",d={id:`${t}-${Date.now()}-${Math.round(1e3*Math.random())}`,content:""};for(;!a||!a.aborted;){const{done:e,value:a}=await i.read();if(e)break;const c=s.decode(a,{stream:!0});if("gemini"===t){const e=c.trim().split(",\r\n").map((e=>e.replace(/^\[|]$/g,""))).filter((e=>""!==e.trim()));for(const a of e)try{const e=JSON.parse(a);d=l.stream[t][n](e,d),o&&o(d)}catch{}}if("chatgpt"===t){r+=c;let e,a=0;for(;-1!==(e=r.indexOf("\n",a));){const i=r.slice(a,e).trim();if(a=e+1,i.startsWith("data: ")){const e=i.slice(6);if("[DONE]"===e)continue;try{const a=JSON.parse(e);d=l.stream[t][n](a,d),o&&o(d)}catch{}}}r=r.slice(a)}if("claude"===t){r+=c;let e,a=0;for(;-1!==(e=r.indexOf("\n",a));){const i=r.slice(a,e).trim();if(a=e+1,i.startsWith("data: ")){const e=i.slice(6);try{const a=JSON.parse(e);if("message_start"===a.type){d.id=a.message.id;continue}if("content_block_delta"!==a.type)continue;d=l.stream[t][n](a,d),o&&o(d)}catch{}}}r=r.slice(a)}}return d},p=async(e,t,n,o)=>{const a=(o=o||new AbortController).signal,i=await fetch(`${s.config.apiURL}?action=${e}`,{signal:a,method:"POST",body:JSON.stringify(t),headers:{"Content-Type":"application/json"}});if(!i.ok){const e=await i.json();if(e.error)throw new Error(e.error.message);throw new Error(e.detail)}const r=i.headers.get("x-modai-service")??"chatgpt",p=i.headers.get("x-modai-parser")??"content",m=1===parseInt(i.headers.get("x-modai-stream")??"0");if(1!==parseInt(i.headers.get("x-modai-proxy")??"0")){return(async(e,t,n)=>{if("object"!=typeof e||!e.forExecutor)return e;const o=e.forExecutor,a=(n=n||new AbortController).signal;if(!o.service||!o.parser)throw new Error(_("modai.cmp.service_required"));if(!l[o.stream?"stream":"buffered"]?.[o.service]?.[o.parser])throw new Error(_("modai.cmp.service_unsupported"));if(o.stream)return(async e=>{if("content"!==o.parser)throw new Error(_("modai.cmp.service_unsupported"));const n=await fetch(e.url,{signal:a,method:"POST",body:e.body,headers:e.headers});return await d(n),c(n,o.service,o.parser,t)})(o);const i=await(async e=>{const t=await fetch(e.url,{signal:a,method:"POST",body:e.body,headers:e.headers});await d(t);const n=await t.json();if(n.error)throw new Error(n.error.message);return n})(o);return l.buffered[o.service][o.parser](i)})(await i.json(),n,o)}if(!r||!p)throw o.abort(),new Error(_("modai.cmp.service_required"));if(!l[m?"stream":"buffered"]?.[r]?.[p])throw o.abort(),new Error(_("modai.cmp.service_unsupported"));if(!m){const e=await i.json();return l.buffered[r][p](e)}if("content"!==p)throw new Error(_("modai.cmp.service_unsupported"));return await c(i,r,p,n,a)},m={mgr:{download:{image:async e=>await(async(e,t)=>{const n=await fetch(`${s.config.apiURL}?action=Download\\Image`,{method:"POST",body:JSON.stringify(t),headers:{"Content-Type":"application/json"}});if(!n.ok){const e=await n.json();if(e.error)throw new Error(e.error.message);throw new Error(e.detail)}return await n.json()})(0,e)},prompt:{freeText:async(e,t,n)=>p("Prompt\\FreeText",e,t,n),text:async(e,t,n)=>p("Prompt\\Text",e,t,n),vision:async(e,t,n)=>p("Prompt\\Vision",e,t,n),image:async(e,t)=>p("Prompt\\Image",e,void 0,t)}}},h={},u={_formatOutput(e,t){const n=h[e],o=n.visible>0,a=n.visible!==n.values.length-1;return{value:void 0!==t?t:n.values[n.visible]??null,nextStatus:a,prevStatus:o,current:n.visible+1,total:n.values.length,context:n.context}},insert(e,t,n=!1){const o=h[e];n||(o.visible=o.values.push(t)-1);const a=this._formatOutput(e,t);return"function"==typeof o.syncUI&&o.syncUI(a,n),a},next(e){const t=h[e];if(t.visible===t.values.length-1)return this._formatOutput(e);t.visible++;const n=this._formatOutput(e);return"function"==typeof t.syncUI&&t.syncUI(n),n},prev(e){const t=h[e];if(t.visible<=0)return this._formatOutput(e);t.visible--;const n=this._formatOutput(e);return"function"==typeof t.syncUI&&t.syncUI(n),n},init(e,t,n,o){return h[e]||(h[e]={visible:-1,values:[],context:o}),h[e].syncUI=t,n&&(h[e].values=[n],h[e].visible=0),{cachedItem:h[e],getData:()=>this._formatOutput(e),getAll:()=>h[e].values,syncUI:()=>{"function"==typeof h[e].syncUI&&h[e].syncUI(this._formatOutput(e),!1)},insert:(t,n=!1)=>this.insert(e,t,n),next:()=>this.next(e),prev:()=>this.prev(e)}}},g=e=>{if(!s.modal.isDragging)return;const t=s.modal.modal,n=e.clientX-s.modal.offsetX,o=e.clientY-s.modal.offsetY;t.style.left=n+"px",t.style.top=o+"px",t.style.transform="none"},y=()=>{s.modal.isDragging=!1,document.body.style.userSelect=""},f=(e,t)=>{e.className=t},v=(e,t,n,o)=>{const a="string"==typeof n?n:"";n&&"string"!=typeof n&&!Array.isArray(n)&&(n=[n]);const i=document.createElement(e);return o&&Object.assign(i,o),t&&(i.className=t),a?i.textContent=a:n&&Array.isArray(n)&&n.forEach((e=>{"string"==typeof e?i.append(document.createTextNode(e)):i.append(e)})),i},w=e=>/<[^>]*>/g.test(e)?e:e.replace(/\r\n|\n|\r/g,"<br>"),x=(e,t,n,o)=>{const a="string"==typeof e?e:"";"string"==typeof e||Array.isArray(e)||(e=[e]);const i=v("button",n,a);return i.type="button",Array.isArray(e)&&e.forEach((e=>{"string"==typeof e?i.append(document.createTextNode(e)):i.append(e)})),i.addEventListener("click",t),i.enable=()=>{i.disabled=!1},i.disable=()=>{i.disabled=!0},o&&Object.assign(i,o),i},b='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-copy"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg>',C='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-circle-plus"><circle cx="12" cy="12" r="10"></circle><path d="M8 12h8"></path><path d="M12 8v8"></path></svg>',k={loadingText:"Loading...",completedText:"Completed!",completedTextDuration:2e3,disabled:!1,disableCompletedState:!1},E=e=>{const t=(e={...k,...e}).icon;t.ariaHidden="true";const n=v("div",void 0,e.label),o=x([t,n],(async()=>{const a=o.innerHTML,i=e.onClick(e.message,s.modal);if(i instanceof Promise){const o=v("span","spinner",[v("span","dot top"),v("span","dot right"),v("span","dot bottom"),v("span","dot left")]);t.innerHTML="",t.appendChild(o),n.innerHTML=e.loadingText||"",await i}e.disableCompletedState||(t.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-check"><path d="M20 6 9 17l-5-5"></path></svg>',n.innerHTML=e.completedText||"Completed!",await new Promise((e=>setTimeout(e,2e3)))),o.innerHTML=a}),"action-button",{ariaLabel:e.label,tabIndex:0});return e.disabled&&o.disable(),o},M=(e,t)=>{const n=v("div","icon");return n.style.width=`${e}px`,n.style.height=`${e}px`,n.innerHTML=t.trim(),n},T=()=>{const e=s.modal.chatContainer.scrollHeight-s.modal.chatContainer.scrollTop-s.modal.chatContainer.clientHeight<10;s.modal.chatContainer.scrollHeight>s.modal.chatContainer.clientHeight&&!e?s.modal.scrollWrapper.style.display="flex":s.modal.scrollWrapper.style.display="none"},L=e=>{s.modal.welcomeMessage.style.display="none";const t=v("div","message error");t.appendChild(M(14,'<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-triangle-alert"><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3"></path><path d="M12 9v4"></path><path d="M12 17h.01"></path></svg>'));const n=v("span");return n.textContent=e,t.appendChild(n),s.modal.chatMessages.appendChild(t),t},A=(e,t)=>{if(!e.hidden){if("user"===e.role){const t=(e=>{const t=v("div","message user");let n,o=null;if(Array.isArray(e.content)){const[t,...a]=e.content;n=t.value,o=a}else n=e.content;const a=v("div");if(a.innerHTML=w(n),t.appendChild(a),o){const e=v("div","imageRow");for(const t of o){const n=v("div"),o=v("img");o.src=t.value,n.appendChild(o),e.appendChild(n)}t.appendChild(e)}const i=v("div","actions");return i.appendChild(E({message:e,disabled:s.modal.isLoading,disableCompletedState:!0,icon:M(14,'<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path></svg>'),label:"Edit",onClick:e=>{s.alertOpen=!0,(e=>{const t=x("Cancel",(()=>{i()}),"cancelBtn",{tabIndex:0}),n=x(e.confirmText,(()=>{a(),e.onConfirm()}),"confirmBtn",{tabIndex:0}),o=v("div","modai--root overlay",[v("div","dialog",[v("h3","title",e.title),v("p","message",e.content),v("div","buttons",[t,n])],{tabIndex:-1})],{ariaModal:"true",role:"dialog",ariaLabel:e.title}),a=()=>{document.removeEventListener("keydown",s),o.remove()},i=()=>{a(),e.onCancel?.()},s=e=>{if("Escape"===e.key&&(e.stopImmediatePropagation(),e.preventDefault(),e.stopPropagation(),i()),"Tab"===e.key){const o=[t,n],a=document.activeElement,i=a?o.indexOf(a):0;e.shiftKey?0===i||-1===i?n.focus():t.focus():1===i||-1===i?t.focus():n.focus(),e.preventDefault()}};document.addEventListener("keydown",s),document.body.append(o),n.focus()})({title:"Confirm Edit",content:"Editing this message will delete all responses that came after it. Do you want to proceed?",confirmText:"Edit Message",onCancel:()=>{s.alertOpen=!1},onConfirm:()=>{if(s.alertOpen=!1,s.modal.messageInput.setValue("string"==typeof e.content?e.content:e.content[0].value),"string"!=typeof e.content)for(const t of e.content)"text"!==t.type&&"image"===t.type&&s.modal.attachments.addImageAttachment(t.value);s.modal.history.clearHistoryFrom(e.id),0===s.modal.history.getMessages().length&&(s.modal.welcomeMessage.style.display="block")}})}})),t.appendChild(i),t.update=e=>{const t=Array.isArray(e.content)?e.content[0].value:e.content;a.innerHTML=w(t)},s.modal.chatMessages.appendChild(t),t})(e);return t.scrollIntoView({behavior:"smooth",block:"start"}),t}return e.type,((e,t)=>{const n=v("div","message ai");let o=Array.isArray(e.content)?e.content[0].value:e.content;"image"===e.type&&(o=`<img src="${o}" />`);const a=((e,t=[])=>{const n=v("div");n.updateContent=e=>{o.innerHTML=w(e),T()};const o=v("div");o.innerHTML=w(e);const a=n.attachShadow({mode:"open"}),i=v("style");return i.textContent="\n    html {\n        width: 100%;\n        max-width: 100%;\n        padding: 0;\n        margin: 0;\n    }\n    body {\n        background-color: #F1F1F2;\n        margin: 0;\n        padding: 0;\n        font-family: Arial, sans-serif;\n        overflow-x: hidden;\n        width: 100%;\n        max-width: 100%;\n        box-sizing: border-box;\n    }\n    * {\n        box-sizing: border-box;\n        max-width: 100%;\n    }\n    pre {\n        white-space: pre-wrap;\n        word-wrap: break-word;\n        overflow-wrap: break-word;\n        max-width: 100%;\n        padding: 12px;\n        margin: 0;\n        background-color: #f5f7fa;\n        border-radius: 5px;\n        font-size: 14px;\n    }\n    img {\n        max-width: 100%;\n        height: auto;\n        display: block;\n    }\n    code {\n        white-space: pre-wrap;\n        word-wrap: break-word;\n        max-width: 100%;\n        display: block;\n        overflow-x: hidden;\n        font-size: 14px;\n    }\n    table {\n        width: 100%;\n        max-width: 100%;\n        overflow-x: hidden;\n        display: block;\n        border-collapse: collapse;\n    }\n    div {\n        max-width: 100%;\n        overflow-wrap: break-word;\n        word-wrap: break-word;\n        box-sizing: border-box;\n    }\n    p {\n        margin: 0 0 0.5em 0;\n        max-width: 100%;\n    }\n    h1, h2, h3, h4, h5, h6 {\n        margin: 0 0 0.1em 0;\n        max-width: 100%;\n    }\n",a.appendChild(i),t.forEach((e=>{a.appendChild(v("link",void 0,"",{rel:"stylesheet",type:"text/css",href:e}))})),a.append(o),n})(o,t.customCSS??[]);n.appendChild(a);const i=v("div","actions");if("text"===t.type&&(!1!==t.textActions?.copy&&i.appendChild(E({message:e,disabled:s.modal.isLoading,icon:M(14,b),label:"Copy",completedText:"Copied!",onClick:"function"==typeof t.textActions?.copy?t.textActions.copy:I})),"function"==typeof t.textActions?.insert&&i.append(E({message:e,disabled:s.modal.isLoading,icon:M(14,C),label:"Insert",completedText:"Inserted!",onClick:t.textActions.insert}))),"image"===t.type){!1!==t.imageActions?.copy&&i.append(E({message:e,disabled:s.modal.isLoading,icon:M(14,b),label:"Copy",loadingText:"Downloading...",completedText:"Copied!",onClick:async(e,n)=>{const o="function"==typeof t.textActions?.copy?t.textActions.copy:I;if(!0===e.ctx.downloaded)return void o(e,n);const a=await m.mgr.download.image({url:e.content,field:t.field,namespace:t.namespace,resource:t.resource,mediaSource:t.image?.mediaSource});e.content=a.fullUrl,e.ctx.downloaded=!0,e.ctx.url=a.url,e.ctx.fullUrl=a.fullUrl,o(e,n)}}));const n=t.imageActions?.insert;"function"==typeof n&&i.append(E({message:e,disabled:s.modal.isLoading,icon:M(14,C),label:"Insert",completedText:"Inserted!",loadingText:"Downloading...",onClick:async(e,o)=>{if(!0===e.ctx.downloaded)return void n(e,o);const a=await m.mgr.download.image({url:e.content,field:t.field,namespace:t.namespace,resource:t.resource,mediaSource:t.image?.mediaSource});e.content=a.fullUrl,e.ctx.downloaded=!0,e.ctx.url=a.url,e.ctx.fullUrl=a.fullUrl,n(e,o)}}))}return n.appendChild(i),s.modal.chatMessages.appendChild(n),n.update=e=>{const t=Array.isArray(e.content)?e.content[0].value:e.content,n="image"===e.type?`<img src="${t}" />`:w(t);a.updateContent(n)},n})(e,t)}},I=async e=>{const t=Array.isArray(e.content)?e.content[0].value:e.content;if(navigator.clipboard&&navigator.clipboard.writeText)try{await navigator.clipboard.writeText(t)}catch{L(_("modai.cmp.failed_copy"))}else try{const e=v("textarea");e.value=t,document.body.appendChild(e),e.select(),document.execCommand("copy"),document.body.removeChild(e)}catch{L(_("modai.cmp.failed_copy"))}},O=()=>{document.removeEventListener("mousemove",(e=>g(e))),document.removeEventListener("mouseup",(()=>y())),s.modal&&s.modal.remove(),s.modalOpen=!1},B=async(e,t,n)=>{const o=t?t.trim():s.modal.messageInput.value.trim();if(!o||s.modal.isLoading)return;r(!0),s.modal.messageInput.value="",s.modal.messageInput.style.height="auto",s.modal.abortController=new AbortController,s.modal.welcomeMessage.style.display="none";let a=o;s.modal.attachments.attachments.length>0&&"text"===e.type&&(a=[{type:"text",value:o},...s.modal.attachments.attachments.map((e=>({type:e.type,value:e.value})))]),s.modal.attachments.removeAttachments();const i=s.modal.history.getMessagesHistory();s.modal.history.addUserMessage(a,n);try{if("text"===e.type){const t=await m.mgr.prompt.freeText({namespace:e.namespace,context:e.context,prompt:a,field:e.field||"",messages:i},(e=>{s.modal.history.updateAssistantMessage(e.id,e.content)}),s.modal.abortController);s.modal.history.updateAssistantMessage(t.id,t.content)}if("image"===e.type){const e=await m.mgr.prompt.image({prompt:a},s.modal.abortController);s.modal.history.addAssistantMessage(e.url,e.id,"image")}s.modal.abortController=void 0}catch(e){if(e instanceof Error){if("AbortError"===e.name)return;return r(!1),void L(e.message)}L("Unknown error")}r(!1),s.modal.messageInput.focus()},$=(e,t)=>{for(t.type=e,s.modal.history=i.init(`${t.key}/${t.type}`,(e=>A(e,t)));s.modal.chatMessages.firstChild;)s.modal.chatMessages.removeChild(s.modal.chatMessages.firstChild);const n=s.modal.history.getMessages().filter((e=>!e.hidden));n.length>0?(s.modal.welcomeMessage.style.display="none",n.forEach((e=>{e.el&&s.modal.chatMessages.appendChild(e.el)})),s.modal.actionButtons.forEach((e=>{e.enable()}))):(s.modal.welcomeMessage.style.display="block",s.modal.actionButtons.forEach((e=>{e.disable()}))),D()},S=async(e,t=!1)=>{if(!t&&e instanceof File&&!e.type.startsWith("image/"))return void L("Only image files are allowed");if(t)return void s.modal.attachments.addImageAttachment(e);const n=await new Promise(((t,n)=>{const o=new FileReader;o.onload=function(e){t(e.target?.result)},o.onerror=function(e){n(e)},o.readAsDataURL(e)}));s.modal.attachments.addImageAttachment(n)},D=()=>{s.modal.chatContainer.scrollTop=s.modal.chatContainer.scrollHeight},H=e=>{const t=v("div","inputContainer"),n=v("div","inputSection"),o=v("div","inputWrapper"),a=v("textarea","","",{placeholder:"Ask me anything…",rows:1,ariaLabel:"Type your message"});a.setValue=e=>{a.value=e,a.focus(),""!==e.trim()?(l.disabled=!1,f(l,"active")):(l.disabled=!0,f(l,""))};const i=v("div","loadingDots",[v("div","loadingDot"),v("div","loadingDot"),v("div","loadingDot")],{ariaLabel:"AI is thinking"}),l=x(M(20,'<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-arrow-up"><path d="m5 12 7-7 7 7"></path><path d="M12 19V5"></path></svg>'),(()=>B(e)),"",{ariaLabel:"Send message"});l.disable(),l.enable=()=>{l.disabled=!1,f(l,"active")},l.disable=()=>{l.disabled=!0,f(l,"")};const d=x(M(20,'<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-square"><rect width="18" height="18" x="3" y="3" rx="2"></rect></svg>'),(()=>{s.modal.isLoading&&s.modal.abortController&&(s.modal.abortController.abort(),s.modal.abortController=void 0,r(!1))}),"",{ariaLabel:"Stop generating message"});d.disable(),d.enable=()=>{d.disabled=!1,f(d,"active sending")},d.disable=()=>{d.disabled=!0,f(d,"")},o.append(a,i,l,d),n.append((()=>{const e=v("div","attachmentsWrapper");return e.visible=!1,e.attachments=[],e.show=()=>{e.visible||(e.visible=!0,f(e,"attachmentsWrapper visible"))},e.hide=()=>{e.visible&&(e.visible=!1,f(e,"attachmentsWrapper"))},e.addImageAttachment=e=>{(e=>{s.modal.attachments.attachments.length>0&&s.modal.attachments.removeAttachments();const t=v("div","imagePreview");t.type="image",t.value=e;const n=v("img",void 0,"",{src:e}),o=v("button",void 0,"×");o.addEventListener("click",(e=>{e.stopPropagation(),s.modal.attachments.removeAttachment(t)})),t.append(n,o),s.modal.attachments.addAttachment(t)})(e)},e.removeAttachments=()=>{s.modal.attachments.attachments.forEach((e=>{s.modal.attachments.removeAttachment(e)}))},e.addAttachment=t=>{e.show(),e.appendChild(t),e.attachments.push(t)},e.removeAttachment=t=>{const n=e.attachments.indexOf(t);-1!==n&&(t.remove(),e.attachments.splice(n,1),0===e.attachments.length&&e.hide())},s.modal.attachments=e,e})(),o);const c=[],p=x([M(24,'<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-text"><path d="M17 6.1H3"></path><path d="M21 12.1H3"></path><path d="M15.1 18H3"></path></svg>'),v("span","tooltip","Text Mode")],(()=>{"text"!==e.type&&($("text",e),c.forEach((e=>{f(e,"")})),f(p,"active"))}),"",{ariaLabel:"Text mode"});"text"===e.type&&f(p,"active");const m=x([M(24,'<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-image"><rect width="18" height="18" x="3" y="3" rx="2" ry="2"></rect><circle cx="9" cy="9" r="2"></circle><path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"></path></svg>'),v("span","tooltip","Image Mode")],(()=>{"image"!==e.type&&($("image",e),c.forEach((e=>{f(e,"")})),f(m,"active"))}),"",{ariaLabel:"Image mode"});"image"===e.type&&f(m,"active"),c.push(p),c.push(m);const h=x([M(24,'<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-refresh-cw"><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"></path><path d="M21 3v5h-5"></path><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"></path><path d="M8 16H3v5"></path></svg>'),v("span","tooltip","Retry Last Message")],(()=>{(e=>{if(0!==s.modal.history.getMessages().length)if("text"!==e.type){if("image"===e.type){const t=s.modal.history.getMessages().reverse().find((e=>"user"===e.role));t&&B(e,t.content)}}else B(e,"Try again")})(e)}),"",{ariaLabel:"Retry last message"});h.disable();const u=x([M(24,'<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-trash"><path d="M3 6h18"></path><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"></path><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"></path></svg>'),v("span","tooltip","Clear Chat")],(()=>{s.modal.history.clearHistory(),s.modal.chatMessages.innerHTML="",s.modal.welcomeMessage.style.display="block",s.modal.actionButtons.forEach((e=>{e.disable()}))}),"",{ariaLabel:"Clear chat"});u.disable();const g=v("div","options",[p,m,h,u],{ariaLabel:"Chat options",role:"toolbar"}),y=(()=>{const e=v("div","scrollToBottomContainer",[x([v("div",void 0,"Scroll to bottom"),M(14,'<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-chevron-down"><path d="m6 9 6 6 6-6"></path></svg>')],(()=>{D(),T()}))]);return s.modal.chatContainer.addEventListener("scroll",(()=>{T()})),new MutationObserver((()=>{T()})).observe(s.modal.chatContainer,{childList:!0,subtree:!0}),s.modal.scrollWrapper=e,e})();return t.append(y),t.append(n,g),a.addEventListener("keydown",(t=>{if("Enter"===t.key){if(t.shiftKey)return;t.preventDefault(),B(e)}})),a.addEventListener("input",(function(){this.style.height="auto",this.style.height=this.scrollHeight+"px",""!==this.value.trim()?(l.disabled=!1,f(l,"active")):(l.disabled=!0,f(l,""))})),n.addEventListener("dragover",(e=>{e.preventDefault(),e.stopPropagation(),f(n,"inputSection dragOver")})),n.addEventListener("dragleave",(e=>{e.preventDefault(),e.stopPropagation(),f(n,"inputSection")})),n.addEventListener("drop",(async e=>{e.preventDefault(),e.stopPropagation(),f(n,"inputSection");let t=null,o=null;const a=e.dataTransfer;if(!a)return;const i=a.files;if(i?.length>0){const e=i[0];e.type.startsWith("image/")&&(t=e)}if(!t){const e=a.getData("text/uri-list");e&&(o=e)}if(t)await S(t);else if(o){const e=new URL(window.location.href);if(!o.startsWith(e.origin))return void await S(o,!0);try{const e=await fetch(o);if(e.ok){const t=await e.blob();if(t.type.startsWith("image/")){const e=new File([t],"image.png",{type:t.type});await S(e)}}}catch{L("Failed to fetch an image")}}else L("Only image files are allowed")})),a.addEventListener("paste",(async e=>{const t=e.clipboardData?.items;if(t)for(let n=0;n<t.length;n++)if(-1!==t[n].type.indexOf("image")){const o=t[n].getAsFile();if(o){e.preventDefault(),await S(o);break}}})),s.modal.loadingIndicator=i,s.modal.messageInput=a,s.modal.sendBtn=l,s.modal.stopBtn=d,s.modal.modeButtons=c,s.modal.actionButtons=[h,u],t},j=e=>{const t=v("div"),n=v("div","modai--root chat-modal","",{ariaLabel:"modAI Assistant chat dialog"});t.modal=n,s.modal=t,t.history=i.init(`${e.key}/${e.type}`,(t=>A(t,e))),n.append((()=>{const e=v("header","header",[v("h1","","modAI Assistant"),x(M(24,'<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-x"><path d="M18 6 6 18"></path><path d="m6 6 12 12"></path></svg>'),(()=>{O()}),"closeBtn",{ariaLabel:"Close dialog"})]);return e.addEventListener("mousedown",(e=>{(e=>{s.modal.isDragging=!0;const t=s.modal.modal.getBoundingClientRect();s.modal.offsetX=e.clientX-t.left,s.modal.offsetY=e.clientY-t.top,document.body.style.userSelect="none"})(e),document.addEventListener("mousemove",g),document.addEventListener("mouseup",(()=>{y(),document.removeEventListener("mousemove",g),document.removeEventListener("mouseup",y)}))})),document.addEventListener("keydown",(e=>{s.alertOpen||"Escape"===e.key&&(e.preventDefault(),O())})),e})()),n.append((()=>{const e=v("div","chatContainer","",{ariaLive:"polite"}),t=v("div","welcome",[v("p","greeting",s.config.name?`Welcome, ${s.config.name}.`:"Welcome!"),v("p","msg","How can I help you today? ✨")]);e.append(t);const n=v("div","history","",{ariaLabel:"Conversation history"});return e.append(n),s.modal.welcomeMessage=t,s.modal.chatMessages=n,s.modal.chatContainer=e,e})()),n.append(H(e));const o=v("div","disclaimer","AI can make mistakes. Please double-check responses.");n.append(o),t.appendChild(n),document.body.append(t),t.isDragging=!1,t.isLoading=!1,t.abortController=void 0,t.offsetX=0,t.offsetY=0;const a=t.history.getMessages().filter((e=>!e.hidden));return a.length>0&&(t.welcomeMessage.style.display="none",t.actionButtons.forEach((e=>{e.enable()})),a.forEach((e=>{e.el&&t.chatMessages.appendChild(e.el)}))),setTimeout((()=>{D(),n.style.visibility="visible",t.messageInput.focus()}),100),t},F=["text","image"],P=(e,t={})=>{const n={indicatorType:t.indicatorType||"spinner",overlayColor:t.overlayColor||"rgba(255, 255, 255, 0.7)",indicatorColor:t.indicatorColor||"#3498db"},o=document.createElement("div"),a=document.createElement("div"),i=window.getComputedStyle(e),s=e.getBoundingClientRect();t.indicatorColor||(n.indicatorType=s.height<=50?"dots":"spinner"),o.style.position="absolute",o.style.top="0",o.style.left="0",o.style.width="100%",o.style.height="100%",o.style.backgroundColor=n.overlayColor,o.style.display="flex",o.style.justifyContent="center",o.style.alignItems="center",o.style.zIndex="10000",o.style.borderRadius=i.borderRadius;let r="";if("spinner"===n.indicatorType)a.style.border="4px solid #f3f3f3",a.style.borderTop=`4px solid ${n.indicatorColor}`,a.style.borderRadius="50%",a.style.width="30px",a.style.height="30px",a.style.animation="textareaOverlaySpin 1s linear infinite",r="\n      @keyframes textareaOverlaySpin {\n        0% { transform: rotate(0deg); }\n        100% { transform: rotate(360deg); }\n      }\n    ";else if("dots"===n.indicatorType){a.style.display="flex",a.style.alignItems="center",a.style.justifyContent="center",a.style.height="20px";for(let e=0;e<3;e++){const t=document.createElement("div");t.style.width="8px",t.style.height="8px",t.style.borderRadius="50%",t.style.backgroundColor=n.indicatorColor,t.style.margin="0 4px",t.style.animation="textareaOverlayDotPulse 1.4s infinite ease-in-out",t.style.animationDelay=.2*e+"s",a.appendChild(t)}r="\n      @keyframes textareaOverlayDotPulse {\n        0%, 80%, 100% { transform: scale(0); opacity: 0.5; }\n        40% { transform: scale(1); opacity: 1; }\n      }\n    "}const l=document.createElement("style");l.textContent=r,document.head.appendChild(l),o.appendChild(a);const d=window.getComputedStyle(e.parentElement);let c;-1===["relative","absolute","fixed"].indexOf(d.position)?(c=document.createElement("div"),c.style.position="relative",c.style.width=`${s.width}px`,c.style.height=`${s.height}px`,c.style.display="inline-block",e.parentNode?.insertBefore(c,e),c.appendChild(e)):c=e.parentElement,o.style.display="none",c.appendChild(o);const p=e.getBoundingClientRect();return c!==e.parentElement&&(c.style.width=`${p.width}px`,c.style.height=`${p.height}px`),o.style.display="flex",e.setAttribute("disabled","disabled"),()=>{o.style.display="none",e.removeAttribute("disabled"),o.remove(),l.remove(),c!==e.parentElement&&(c.parentNode?.insertBefore(e,c),c.remove())}},U={createLoadingOverlay:P,localChat:e=>(e=>{if(s.modalOpen)return;if(!e.key)return void alert("key is required config property");e.type||(e.type="text"),e.availableTypes||(e.availableTypes=[e.type]),e.availableTypes=e.availableTypes.filter((e=>F.includes(e))),e.availableTypes.length>0&&!e.availableTypes.includes(e.type)&&e.availableTypes.unshift(e.type);const t=j(e);return window.x=t,t.api={sendMessage:async(t,n)=>{await B(e,t,n)},closeModal:()=>{O()}},s.modalOpen=!0,t})(e)},N=(e,t)=>{e.context.els.forEach((({wrapper:n,field:o})=>{const a=o.getValue();o.setValue(e.value),o.fireEvent("change",o,e.value,a),t&&(o.el.dom.scrollTop=o.el.dom.scrollHeight),e.total>0&&n.historyNav.show(),n.historyNav.info.update(e.current,e.total),e.prevStatus?n.historyNav.prevButton.enable():n.historyNav.prevButton.disable(),e.nextStatus?n.historyNav.nextButton.enable():n.historyNav.nextButton.disable()}))},R=()=>{const e=document.createElement("button");return e.className="modai-generate",e.innerText="✦",e.type="button",e.title="Generate using AI",e},q=e=>{const t=document.createElement("button");t.type="button",t.title="Previous Version",t.className="modai-history_prev",t.disable=()=>{t.disabled=!0},t.enable=()=>{t.disabled=!1},t.innerHTML="prev",t.addEventListener("click",(()=>{e.prev()}));const n=document.createElement("button");n.type="button",n.title="Next Version",n.className="modai-history_next",n.disable=()=>{n.disabled=!0},n.enable=()=>{n.disabled=!1},n.innerHTML="next",n.addEventListener("click",(()=>{e.next()}));const o=document.createElement("span");o.update=(e,t)=>{o.innerText=`${e}/${t}`},o.innerText="";const a=document.createElement("span");return a.show=()=>{a.style.display="initial"},a.hide=()=>{a.style.display="none"},a.prevButton=t,a.nextButton=n,a.info=o,a.appendChild(t),a.appendChild(n),a.appendChild(o),a.hide(),t.disable(),n.disable(),a},V=e=>{const t=R();return t.addEventListener("click",(()=>{U.localChat({key:e,field:e,type:"text",availableTypes:["text","image"],resource:MODx.request.id})})),t},W=(e,t)=>{const n=document.createElement("span"),o=R();o.addEventListener("click",(async()=>{const n=P(e.el.dom);try{const e=await m.mgr.prompt.text({id:MODx.request.id,field:t});a.insert(e.content),n()}catch(e){n(),Ext.Msg.alert("Failed",_("modai.cmp.failed_try_again",{msg:e instanceof Error?e.message:""}))}})),n.appendChild(o);const a=u.init(t,N,e.getValue(),{});a.cachedItem.context.els||(a.cachedItem.context.els=[]),a.cachedItem.context.els.push({field:e,wrapper:n});const i=q(a);return n.appendChild(i),n.historyNav=i,n},z=(e,t,n)=>{const o=R();return o.addEventListener("click",(()=>{U.localChat({key:t,field:t,type:"image",resource:MODx.request.id,image:{mediaSource:parseInt(e)||void 0},imageActions:{copy:!1,insert:(e,t)=>{n(e),t.api.closeModal()}}})})),o},J=(e,t)=>{const n=Ext.getCmp(e);if(!n)return;const o=document.createElement("span"),a=R();a.addEventListener("click",(async()=>{const e=P(n.el.dom);try{const n=await m.mgr.prompt.text({id:MODx.request.id,field:t},(e=>{i.insert(e.content,!0)}));i.insert(n.content),e()}catch(t){e(),Ext.Msg.alert("Failed",_("modai.cmp.failed_try_again",{msg:t instanceof Error?t.message:""}))}})),o.appendChild(a);const i=u.init(t,N,n.getValue(),{});i.cachedItem.context.els||(i.cachedItem.context.els=[]),i.cachedItem.context.els.push({field:n,wrapper:o});const s=q(i);o.appendChild(s),o.historyNav=s,n.label.appendChild(o)},X=(e,t)=>{const n=Ext.getCmp(e.firstElementChild?.id),o=z(n.imageBrowser.source,t,(function(e){n.imageBrowser.setValue(e.ctx.url),n.onImageChange(e.ctx.url)})),a=R();a.style.marginTop="6px",a.addEventListener("click",(async()=>{const e=n.imagePreview.el.dom,o=document.createElement("canvas"),a=o.getContext("2d");if(!a)return;o.width=e.width,o.height=e.height,a.drawImage(e,0,0);const i=o.toDataURL("image/png"),s=P(n.altTextField.items.items[0].el.dom);try{const e=await m.mgr.prompt.vision({image:i,field:t},(e=>{n.altTextField.items.items[0].setValue(e.content),n.altTextField.items.items[0].el.dom.scrollTop=n.altTextField.items.items[0].el.dom.scrollHeight,n.image.altTag=e.content,n.updateValue()}));n.altTextField.items.items[0].setValue(e.content),n.image.altTag=e.content,n.updateValue(),s()}catch(e){s(),Ext.Msg.alert("Failed",_("modai.cmp.failed_try_again",{msg:e instanceof Error?e.message:""}))}})),n.altTextField.el.dom.style.display="flex",n.altTextField.el.dom.style.justifyItems="center",n.altTextField.el.dom.style.alignItems="center",n.el.dom.parentElement?.parentElement?.parentElement?.querySelector("label")?.appendChild(o),n.altTextField.el.dom.appendChild(a)},Y=()=>{const e=Ext.getCmp("modx-resource-content").el.dom.querySelector("label");e?.appendChild(V("res.content"))},K=e=>{(e=>{const t={pagetitle:["modx-resource-pagetitle"],longtitle:["modx-resource-longtitle","seosuite-longtitle"],introtext:["modx-resource-introtext"],description:["modx-resource-description","seosuite-description"],content:["modx-resource-content"]};for(const n of e.resourceFields||[])t[n]&&("content"!==n?t[n].forEach((e=>{J(e,`res.${n}`)})):Y())})(e),(e=>{const t=Ext.getCmp("modx-panel-resource").getForm();for(const[n,o]of e.tvs||[]){const e=Ext.get(`tv${n}-tr`);if(!e)continue;const a=t.findField(`tv${n}`),i=`tv.${o}`;if(a){if("textfield"===a.xtype||"textarea"===a.xtype){const t=MODx.config[`modai.tv.${o}.text.prompt`],n=e.dom.querySelector("label");if(!n)return;t?n.appendChild(W(a,i)):n.appendChild(V(i))}if("modx-panel-tv-image"===a.xtype){const t=z(a.source,i,(function(e){const t={relativeUrl:e.ctx.url,url:e.ctx.url};a.items.items[1].fireEvent("select",t),a.fireEvent("select",t)})),n=e.dom.querySelector("label");if(!n)return;n.appendChild(t)}}else{const t=e.dom.querySelector(".imageplus-panel-input");t&&X(t,i)}}})(e)},G=e=>(s.config=e,{chatHistory:i,history:u,executor:m,ui:U,initOnResource:K});ModAI=t.default})();