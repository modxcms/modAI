"use strict";var ModAI=(()=>{var le=Object.defineProperty;var Qe=Object.getOwnPropertyDescriptor;var Ze=Object.getOwnPropertyNames;var et=Object.prototype.hasOwnProperty;var tt=(e,t)=>{for(var o in t)le(e,o,{get:t[o],enumerable:!0})},ot=(e,t,o,n)=>{if(t&&typeof t=="object"||typeof t=="function")for(let a of Ze(t))!et.call(e,a)&&a!==o&&le(e,a,{get:()=>t[a],enumerable:!(n=Qe(t,a))||n.enumerable});return e};var nt=e=>ot(le({},"__esModule",{value:!0}),e);var Mt={};tt(Mt,{init:()=>Tt});var k={},at=(e,t,o,n=!1)=>{let a=k[e];if(!a)return;let i=typeof o=="string",r={__type:"UserMessage",content:i?o:o.content,contexts:i?void 0:o.contexts,attachments:i?void 0:o.attachments,role:"user",id:t,hidden:n,ctx:{}},l=a.history.push(r)-1;t&&(a.idRef[t]=a.history[l]),r.el=a.onAddMessage(r)},st=(e,t,o,n=!1)=>{let a=k[e];if(!a)return;let i={__type:"ToolResponseMessage",content:o,role:"tool",id:t,hidden:n,ctx:{}},r=a.history.push(i)-1;t&&(a.idRef[t]=a.history[r]),i.el=a.onAddMessage(i)},ue=(e,t,o,n,a,i=!1)=>{let r=k[e];if(!r)return;let l={__type:"AssistantMessage",content:o,toolCalls:n,contentType:a,role:"assistant",id:t,hidden:i,ctx:{}},d=r.history.push(l)-1;t&&(r.idRef[t]=r.history[d]),l.el=r.onAddMessage(l)},rt=(e,t,o)=>{let n=k[e];if(!n)return;if(!n.idRef[t]){ue(e,t,o,void 0,"text",!1);return}let a=n.idRef[t];a.content=o,a.__type==="AssistantMessage"&&a.el&&a.el.update&&a.el.update(a)},it=(e,t)=>{let o=k[e];if(o)return o.idRef[t]},O={init:(e,t)=>(k[e]||(k[e]={history:[],idRef:{},onAddMessage:t}),k[e].onAddMessage=t,{addUserMessage:(o,n=!1)=>{let a="user-msg-"+Date.now()+Math.round(Math.random()*1e3);at(e,a,o,n)},addAssistantMessage:(o,n,a,i,r=!1)=>{ue(e,o,n,a,i,r)},addToolResponseMessage:(o,n,a=!1)=>{st(e,o,n,a)},updateAssistantMessage:(o,n)=>{rt(e,o,n)},getAssistantMessage:o=>it(e,o),getMessages:()=>k[e].history,getMessagesHistory:()=>k[e].history.map(o=>({role:o.role,content:o.content,toolCalls:o.toolCalls,contexts:o.contexts,attachments:o.attachments})),clearHistory:()=>{k[e].history.forEach(o=>{o.el?.remove()}),k[e].history=[]},clearHistoryFrom:o=>{let n=k[e].history.findIndex(a=>a.id===o);if(n!==-1){for(let a=n;a<k[e].history.length;a++)k[e].history[a].el?.remove();k[e].history.splice(n)}}})};var s={modalOpen:!1,config:{},modal:{}};var p=(e,t)=>(s.config.translateFn||_)(e,t);var ee=(e,t)=>{if(!e||!t)throw new Error(p("modai.error.service_required"));let o=e,n=t;if(!W[o]?.[n])throw new Error(p("modai.error.service_unsupported"));return{service:o,parser:n}},W={openai:{content:e=>{let t=e?.choices?.[0]?.message?.content,o=e?.choices?.[0]?.message?.tool_calls;if(!t&&!o)throw new Error(p("modai.error.failed_request"));let n=e.id;return o?t?{__type:"TextDataMaybeTools",id:n,content:t,toolCalls:o.map(a=>({id:a.id,name:a.function.name,arguments:a.function.arguments})),usage:{completionTokens:e?.usage.completion_tokens,promptTokens:e?.usage.prompt_tokens}}:{__type:"ToolsData",id:n,toolCalls:o.map(a=>({id:a.id,name:a.function.name,arguments:a.function.arguments})),usage:{completionTokens:e?.usage.completion_tokens,promptTokens:e?.usage.prompt_tokens}}:{__type:"TextDataNoTools",id:n,content:t,usage:{completionTokens:e?.usage.completion_tokens,promptTokens:e?.usage.prompt_tokens}}},image:e=>{let t=e?.data?.[0]?.url;if(!t){if(t=e?.data?.[0]?.b64_json,!t)throw new Error(p("modai.error.failed_request"));t=`data:image/png;base64,${t}`}return{__type:"ImageData",id:crypto.randomUUID(),url:t}}},anthropic:{content:e=>{let t,o=[];if(e?.content?.map(a=>{a.type==="text"&&(t=a.text),a.type==="tool_use"&&o.push({id:a.id,name:a.name,arguments:JSON.stringify(a.input)})}),!t&&o.length===0)throw new Error(p("modai.error.failed_request"));let n=e.id;return o.length===0?{__type:"TextDataNoTools",id:n,content:t,usage:{completionTokens:e?.usage.output_tokens,promptTokens:e?.usage.input_tokens}}:t?{__type:"TextDataMaybeTools",id:n,toolCalls:o,content:t,usage:{completionTokens:e?.usage.output_tokens,promptTokens:e?.usage.input_tokens}}:{__type:"ToolsData",id:n,toolCalls:o,usage:{completionTokens:e?.usage.output_tokens,promptTokens:e?.usage.input_tokens}}}},google:{content:e=>{let t="",o;if(!e?.candidates?.[0]?.content?.parts)throw new Error(p("modai.error.failed_request"));for(let n of e.candidates[0].content.parts){if(n.text){t+=n.text;continue}n.functionCall&&(o||(o=[]),o.push({id:crypto.randomUUID(),name:n.functionCall.name,arguments:JSON.stringify(n.functionCall.args)}))}if(!t&&!o)throw new Error(p("modai.error.failed_request"));return o?t?{__type:"TextDataMaybeTools",id:crypto.randomUUID(),content:t,toolCalls:o,usage:{completionTokens:e?.usageMetadata.candidatesTokenCount,promptTokens:e?.usageMetadata.promptTokenCount}}:{__type:"ToolsData",id:crypto.randomUUID(),toolCalls:o,usage:{completionTokens:e?.usageMetadata.candidatesTokenCount,promptTokens:e?.usageMetadata.promptTokenCount}}:{__type:"TextDataNoTools",id:crypto.randomUUID(),content:t,usage:{completionTokens:e?.usageMetadata.candidatesTokenCount,promptTokens:e?.usageMetadata.promptTokenCount}}},image:e=>{let t=e?.predictions?.[0]?.bytesBase64Encoded;if(!t)throw new Error(p("modai.error.failed_request"));return{__type:"ImageData",id:crypto.randomUUID(),url:`data:image/png;base64,${t}`}}}};var ge=(e,t,o,n)=>{t+=e;let a=0,i;for(;(i=t.indexOf(`
`,a))!==-1;){let r=t.slice(a,i).trim();if(a=i+1,r.startsWith("data: ")){let l=r.slice(6);try{let d=JSON.parse(l);if(d.type==="message_start"){o.id=d.message.id,o.usage={promptTokens:d.message.usage.input_tokens,completionTokens:0};continue}if(d.type==="message_delta"){o.usage.completionTokens=d.usage.output_tokens;continue}if(d.type!=="content_block_delta"&&d.type!=="content_block_start")continue;let u="",c=o.toolCalls||void 0;d.type==="content_block_start"&&d.content_block.type==="tool_use"&&(c||(c=[]),c[d.index]={id:d.content_block.id,name:d.content_block.name,arguments:""}),d.type==="content_block_delta"&&d.delta.type==="text_delta"&&(u=d.delta.text||""),d.type==="content_block_delta"&&d.delta.type==="input_json_delta"&&(c||(c=[]),c[d.index].arguments=c[d.index].arguments+d.delta.partial_json),o={__type:"TextDataMaybeTools",id:o.id,content:(o.content??"")+u,toolCalls:c,usage:{completionTokens:o.usage.completionTokens||0,promptTokens:o.usage.promptTokens||0}},n&&o.content&&n(o)}catch{}}}return{buffer:t.slice(a),currentData:o}};var he=(e,t,o,n)=>{let a=e.trim().split(`,\r
`).map(i=>i.replace(/^\[|]$/g,"")).filter(i=>i.trim()!=="");for(let i of a)try{let r=JSON.parse(i),l="",d=o.toolCalls||void 0;if(r?.candidates?.[0]?.content?.parts)for(let u of r.candidates[0].content.parts){if(u.text){l+=u.text;continue}u.functionCall&&(d||(d=[]),d.push({id:crypto.randomUUID(),name:u.functionCall.name,arguments:JSON.stringify(u.functionCall.args)}))}o={__type:"TextDataMaybeTools",id:o.id,content:(o.content||"")+l,toolCalls:d,usage:{completionTokens:r?.usageMetadata.candidatesTokenCount,promptTokens:r?.usageMetadata.promptTokenCount}},n&&o.content&&n(o)}catch{}return{buffer:t,currentData:o}};var fe=(e,t,o,n)=>{t+=e;let a=0,i;for(;(i=t.indexOf(`
`,a))!==-1;){let r=t.slice(a,i).trim();if(a=i+1,r.startsWith("data: ")){let l=r.slice(6);if(l==="[DONE]")continue;try{let d=JSON.parse(l);if(d?.usage&&(o.usage={completionTokens:d?.usage?.completion_tokens||0,promptTokens:d?.usage?.prompt_tokens||0}),!d?.choices?.[0]?.delta?.tool_calls&&!d?.choices?.[0]?.delta?.content){n&&o?.content&&n(o);continue}let u="",c=o.toolCalls||void 0;if(d?.choices?.[0]?.delta?.tool_calls?.[0]){c||(c=[]);let h=d.choices[0].delta.tool_calls[0];c[h.index]||(c[h.index]={id:"",name:"",arguments:""}),h.id&&(c[h.index].id=h.id),h.function.name&&(c[h.index].name=h.function.name),h.function.arguments&&(c[h.index].arguments+=h.function.arguments)}d?.choices?.[0]?.delta?.content&&(u=d?.choices?.[0]?.delta?.content),o={__type:"TextDataMaybeTools",id:o.id,content:(o.content??"")+u,toolCalls:c,usage:{completionTokens:o.usage.completionTokens??0,promptTokens:o.usage.promptTokens??0}},n&&o?.content&&n(o)}catch{}}}return{buffer:t.slice(a),currentData:o}};var ye={openai:fe,google:he,anthropic:ge},te=(e,t)=>{if(!e||!t)throw new Error(p("modai.error.service_required"));if(t!=="content")throw new Error(p("modai.error.service_unsupported"));if(!ye[e])throw new Error(p("modai.error.service_unsupported"));return{service:e,parser:t}},oe=async(e,t,o,n)=>{if(!e.body)throw new Error("Response body is empty");let a=e.body.getReader(),i=new TextDecoder("utf-8"),r="",l={id:`${t}-${Date.now()}-${Math.round(Math.random()*1e3)}`,usage:{completionTokens:0,promptTokens:0}},d=ye[t];if(!d)throw new Error(p("modai.error.service_unsupported"));for(;!n?.aborted;){let{done:u,value:c}=await a.read();if(u)break;let h=i.decode(c,{stream:!0}),g=d(h,r,l,o);r=g.buffer,l=g.currentData}return l.toolCalls&&(l.toolCalls=l.toolCalls.filter(Boolean)),l};var xe=async e=>{if(!e.ok){let t=await e.json();throw t?.error?new Error(t.error.message):new Error(`${e.status} ${e.statusText}`)}},ve=async(e,t,o)=>{o=o||new AbortController;let n=o.signal;if(typeof e=="string")return e;let{forExecutor:a}=e,i=async c=>{let h=await fetch(c.url,{signal:n,method:"POST",body:c.body,headers:c.headers});await xe(h);let g=await h.json();if(g.error)throw new Error(g.error.message);return g},r=async c=>{let h=await fetch(c.url,{signal:n,method:"POST",body:c.body,headers:c.headers});return await xe(h),oe(h,a.service,t,n)};if(a.stream)return te(a.service,a.parser),await r(a);let{service:l,parser:d}=ee(a.service,a.parser),u=await i(a);return W[l][d](u)};var ne=async(e,t,o)=>{o=o||new AbortController;let n=o.signal,a=await fetch(`${s.config.apiURL}?action=${e}`,{signal:n,method:"POST",body:JSON.stringify(t),headers:{"Content-Type":"application/json"}});if(!a.ok){let i=await a.json();throw i.error?new Error(i.error.message):new Error(i.detail)}return await a.json()},N=async(e,t,o,n)=>{n=n||new AbortController;let a=n.signal,i=await fetch(`${s.config.apiURL}?action=${e}`,{signal:a,method:"POST",body:JSON.stringify(t),headers:{"Content-Type":"application/json"}});if(!i.ok){let c=await i.json();throw c.error?new Error(c.error.message):new Error(c.detail)}let r=parseInt(i.headers.get("x-modai-stream")??"0")===1;if(!(parseInt(i.headers.get("x-modai-proxy")??"0")===1)){let c=await i.json();return ve(c,o,n)}let d=i.headers.get("x-modai-service")??"openai",u=i.headers.get("x-modai-parser")??"content";try{if(r){let{service:T}=te(d,u);return await oe(i,T,o,a)}let{service:c,parser:h}=ee(d,u),g=await i.json();return W[c][h](g)}catch(c){throw n.abort(),c}};var S={mgr:{download:{image:async e=>await ne("Download\\Image",e)},tools:{run:async(e,t)=>await ne("Tools\\Run",e,t)},context:{get:async(e,t)=>await ne("Context\\Get",e,t)},prompt:{freeText:async(e,t,o)=>N("Prompt\\Chat",e,t,o),chat:async(e,t,o)=>N("Prompt\\Chat",e,t,o),text:async(e,t,o)=>N("Prompt\\Text",e,t,o),vision:async(e,t,o)=>N("Prompt\\Vision",e,t,o),image:async(e,t)=>N("Prompt\\Image",e,void 0,t)}}};var A={},ae={_formatOutput(e,t){let o=A[e],n=o.visible>0,a=o.visible!==o.values.length-1;return{value:t!==void 0?t:o.values[o.visible]??null,nextStatus:a,prevStatus:n,current:o.visible+1,total:o.values.length,context:o.context}},insert(e,t,o=!1){let n=A[e];o||(n.visible=n.values.push(t)-1);let a=this._formatOutput(e,t);return typeof n.syncUI=="function"&&n.syncUI(a,o),a},next(e){let t=A[e];if(t.visible===t.values.length-1)return this._formatOutput(e);t.visible++;let o=this._formatOutput(e);return typeof t.syncUI=="function"&&t.syncUI(o),o},prev(e){let t=A[e];if(t.visible<=0)return this._formatOutput(e);t.visible--;let o=this._formatOutput(e);return typeof t.syncUI=="function"&&t.syncUI(o),o},init(e,t,o,n){return A[e]||(A[e]={visible:-1,values:[],context:n}),A[e].syncUI=t,o&&(A[e].values=[o],A[e].visible=0),{cachedItem:A[e],getData:()=>this._formatOutput(e),getAll:()=>A[e].values,syncUI:()=>{typeof A[e].syncUI=="function"&&A[e].syncUI(this._formatOutput(e),!1)},insert:(a,i=!1)=>this.insert(e,a,i),next:()=>this.next(e),prev:()=>this.prev(e)}}};var b=(e,t)=>{e.className=t},m=(e,t,o,n)=>{let a=typeof o=="string"?o:"";o&&typeof o!="string"&&!Array.isArray(o)&&(o=[o]);let i=document.createElement(e);if(n&&Object.assign(i,n),t&&(i.className=t),a)i.textContent=a;else if(o&&Array.isArray(o)){for(let r of o)if(r){if(typeof r=="string"){i.append(document.createTextNode(r));continue}i.append(r)}}return i},U=e=>/<[^>]*>/g.test(e)?e:e.replace(/\r\n|\n|\r/g,"<br>");var w=(e,t,o,n)=>{let a=typeof e=="string"?e:"";typeof e!="string"&&!Array.isArray(e)&&(e=[e]);let i=m("button",o,a);return i.type="button",Array.isArray(e)&&e.forEach(r=>{typeof r=="string"?i.append(document.createTextNode(r)):i.append(r)}),i.addEventListener("click",t),i.enable=()=>{i.disabled=!1},i.disable=()=>{i.disabled=!0},n&&Object.assign(i,n),i};var j=(e,t)=>{let o=m("div"),n=o.attachShadow({mode:"open"});o.style.display="none";let a=m("link",void 0,"",{rel:"stylesheet",type:"text/css",href:s.config.cssURL});return n.appendChild(a),a.onload=()=>{e?o.style.display="inline-block":o.style.display="",t&&t()},{shadow:o,shadowRoot:n}};var q=e=>{e={showConfirm:!0,showCancel:!0,...e};let{shadow:t,shadowRoot:o}=j(!1,()=>{e.showConfirm&&a.focus(),!e.showConfirm&&e.showCancel&&n.focus()}),n=w(e.cancelText??p("modai.ui.cancel"),()=>{l()},"cancelBtn",{tabIndex:-1}),a=w(e.confirmText,()=>{r(),e.onConfirm()},"confirmBtn",{tabIndex:-1}),i=m("div","modai--root overlay",[m("div","dialog",[m("h3","title",e.title),m("p","message",e.content),m("div","buttons",[e.showCancel&&n,e.showConfirm&&a])],{tabIndex:-1})],{ariaModal:"true",role:"dialog",ariaLabel:e.title}),r=()=>{document.removeEventListener("keydown",u),i.remove(),t.remove()},l=()=>{r(),e.onCancel?.()},d=[];e.showCancel&&d.push(n),e.showConfirm&&d.push(a);let u=c=>{if(c.key==="Escape"&&(c.stopImmediatePropagation(),c.preventDefault(),c.stopPropagation(),l()),c.key==="Tab"){let h=o.activeElement,g=h?d.indexOf(h):-1;c.shiftKey?g=(g-1+d.length)%d.length:g=(g+1)%d.length,d.length>0&&d[g].focus(),c.preventDefault()}};i.addEventListener("keydown",u),o.appendChild(i),document.body.append(t)};var v=(e,t)=>{let o=m("div","icon");return o.style.width=`${e}px`,o.style.height=`${e}px`,o.innerHTML=t.trim(),o};var be='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-check"><path d="M20 6 9 17l-5-5"></path></svg>',we='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-chevron-down"><path d="m6 9 6 6 6-6"></path></svg>',se='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-copy"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"></rect><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path></svg>',Ce='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-pencil"><path d="M21.174 6.812a1 1 0 0 0-3.986-3.987L3.842 16.174a2 2 0 0 0-.5.83l-1.321 4.352a.5.5 0 0 0 .623.622l4.353-1.32a2 2 0 0 0 .83-.497z"></path><path d="m15 5 4 4"></path></svg>',Te='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-image"><rect width="18" height="18" x="3" y="3" rx="2" ry="2"></rect><circle cx="9" cy="9" r="2"></circle><path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"></path></svg>',de='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-circle-plus"><circle cx="12" cy="12" r="10"></circle><path d="M8 12h8"></path><path d="M12 8v8"></path></svg>',Me='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-refresh-cw"><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"></path><path d="M21 3v5h-5"></path><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"></path><path d="M8 16H3v5"></path></svg>',_e='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-arrow-up"><path d="m5 12 7-7 7 7"></path><path d="M12 19V5"></path></svg>',ke='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-square"><rect width="18" height="18" x="3" y="3" rx="2"></rect></svg>',Ee='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-text"><path d="M17 6.1H3"></path><path d="M21 12.1H3"></path><path d="M15.1 18H3"></path></svg>',De='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-trash"><path d="M3 6h18"></path><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"></path><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"></path></svg>',Se='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-triangle-alert"><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3"></path><path d="M12 9v4"></path><path d="M12 17h.01"></path></svg>',Le='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-x"><path d="M18 6 6 18"></path><path d="m6 6 12 12"></path></svg>',Ae='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-sparkle"><path d="M9.937 15.5A2 2 0 0 0 8.5 14.063l-6.135-1.582a.5.5 0 0 1 0-.962L8.5 9.936A2 2 0 0 0 9.937 8.5l1.582-6.135a.5.5 0 0 1 .963 0L14.063 8.5A2 2 0 0 0 15.5 9.937l6.135 1.581a.5.5 0 0 1 0 .964L15.5 14.063a2 2 0 0 0-1.437 1.437l-1.582 6.135a.5.5 0 0 1-.963 0z"></path></svg>',He='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="4" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-arrow-left"><path d="m12 19-7-7 7-7"></path><path d="M19 12H5"></path></svg>',Ie='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="4" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-arrow-right"><path d="M5 12h14"></path><path d="m12 5 7 7-7 7"></path></svg>',Be='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-bot"><path d="M12 8V4H8"></path><rect width="16" height="12" x="4" y="8" rx="2"></rect><path d="M2 14h2"></path><path d="M20 14h2"></path><path d="M15 13v2"></path><path d="M9 13v2"></path></svg>';var K=(e,t={})=>{let o={indicatorType:t.indicatorType||"spinner",overlayColor:t.overlayColor||"rgba(255, 255, 255, 0.7)",indicatorColor:t.indicatorColor||"#3498db"},n=document.createElement("div"),a=document.createElement("div"),i=window.getComputedStyle(e),r=e.getBoundingClientRect();t.indicatorColor||(o.indicatorType=r.height<=50?"dots":"spinner"),n.style.position="absolute",n.style.top="0",n.style.left="0",n.style.width="100%",n.style.height="100%",n.style.backgroundColor=o.overlayColor,n.style.display="flex",n.style.justifyContent="center",n.style.alignItems="center",n.style.zIndex="10000",n.style.borderRadius=i.borderRadius;let l="";if(o.indicatorType==="spinner")a.style.border="4px solid #f3f3f3",a.style.borderTop=`4px solid ${o.indicatorColor}`,a.style.borderRadius="50%",a.style.width="30px",a.style.height="30px",a.style.animation="modai--loading-overlay_spin 1s linear infinite",l=`
      @keyframes modai--loading-overlay_spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }
    `;else if(o.indicatorType==="dots"){a.style.display="flex",a.style.alignItems="center",a.style.justifyContent="center",a.style.height="20px";for(let g=0;g<3;g++){let T=document.createElement("div");T.style.width="8px",T.style.height="8px",T.style.borderRadius="50%",T.style.backgroundColor=o.indicatorColor,T.style.margin="0 4px",T.style.animation="modai--loading-overlay_dot-pulse 1.4s infinite ease-in-out",T.style.animationDelay=`${g*.2}s`,a.appendChild(T)}l=`
      @keyframes modai--loading-overlay_dot-pulse {
        0%, 80%, 100% { transform: scale(0); opacity: 0.5; }
        40% { transform: scale(1); opacity: 1; }
      }
    `}let d=document.createElement("style");d.textContent=l,document.head.appendChild(d),n.appendChild(a);let u=window.getComputedStyle(e.parentElement),c;["relative","absolute","fixed"].indexOf(u.position)===-1?(c=document.createElement("div"),c.style.position="relative",c.style.width=`${r.width}px`,c.style.height=`${r.height}px`,c.style.display="inline-block",e.parentNode?.insertBefore(c,e),c.appendChild(e)):c=e.parentElement,n.style.display="none",c.appendChild(n);let h=e.getBoundingClientRect();return c!==e.parentElement&&(c.style.width=`${h.width}px`,c.style.height=`${h.height}px`),n.style.display="flex",e.setAttribute("disabled","disabled"),()=>{n.style.display="none",e.removeAttribute("disabled"),n.remove(),d.remove(),c!==e.parentElement&&(c.parentNode?.insertBefore(e,c),c.remove())}};var ce=e=>{let{shadow:t,shadowRoot:o}=j(!0),n=m("div","modai--root generate",w(v(14,Ae),e,"btn",{type:"button",title:p("modai.ui.generate_using_ai")}));return o.appendChild(n),{shadow:t,shadowRoot:o,generate:n}},lt=e=>{let t=w(v(14,He),()=>{e.prev()},"history--prev",{type:"button",title:p("modai.ui.previous_version"),role:"navigation"}),o=w(v(14,Ie),()=>{e.next()},"history--next",{type:"button",title:p("modai.ui.next_version"),role:"navigation"}),n=m("div");n.update=(i,r)=>{n.innerText=`${i}/${r}`};let a=m("div","history--wrapper");return a.show=()=>{a.style.display="inline-flex"},a.hide=()=>{a.style.display="none"},a.prevButton=t,a.nextButton=o,a.info=n,a.appendChild(t),a.appendChild(o),a.appendChild(n),a.hide(),t.disable(),o.disable(),a},dt=e=>{let{shadow:t}=ce(()=>{H.localChat(e)});return e.targetEl.appendChild(t),t},ct=({targetEl:e,input:t,onChange:o,initialValue:n,field:a,...i})=>{let{shadow:r,generate:l}=ce(async()=>{let c=K(t);try{let h=await S.mgr.prompt.text({field:a,...i},g=>{d.insert(g.content,!0)});d.insert(h.content),c()}catch(h){c(),q({title:"Failed",content:p("modai.error.failed_try_again",{msg:h instanceof Error?h.message:""}),confirmText:"Close",showCancel:!1,onConfirm:()=>{}})}}),d=ae.init(a,(c,h)=>{c.context.els.forEach(({wrapper:g,onFieldChange:T})=>{T(c,h),c.total>0&&g.historyNav.show(),g.historyNav.info.update(c.current,c.total);let f=g.shadowRoot||g.ownerDocument,x=!c.prevStatus&&f.activeElement===g.historyNav.prevButton,M=!c.nextStatus&&f.activeElement===g.historyNav.nextButton;c.prevStatus?g.historyNav.prevButton.enable():g.historyNav.prevButton.disable(),c.nextStatus?g.historyNav.nextButton.enable():g.historyNav.nextButton.disable(),x&&g.historyNav.nextButton.focus(),M&&g.historyNav.prevButton.focus()})},n,{});d.cachedItem.context.els||(d.cachedItem.context.els=[]),d.cachedItem.context.els.push({onFieldChange:o,wrapper:r});let u=lt(d);return l.appendChild(u),r.historyNav=u,e.appendChild(r),r},pt=e=>{let{shadow:t}=ce(async()=>{let o=document.createElement("canvas"),n=o.getContext("2d");if(!n)return;o.width=e.image.width,o.height=e.image.height,n.drawImage(e.image,0,0);let a=o.toDataURL("image/png"),i=K(e.input);try{let r=await S.mgr.prompt.vision({image:a,field:e.field,namespace:e.namespace},l=>{e.onUpdate(l)});e.onUpdate(r),i()}catch(r){i(),q({title:p("modai.error.failed"),content:p("modai.error.failed_try_again",{msg:r instanceof Error?r.message:""}),confirmText:p("modai.ui.close"),showCancel:!1,onConfirm:()=>{}})}});return e.targetEl.appendChild(t),t},Ue={localChat:dt,forcedText:ct,vision:pt};var Re=e=>{s.modal.isDragging=!0;let o=s.modal.modal.getBoundingClientRect();s.modal.offsetX=e.clientX-o.left,s.modal.offsetY=e.clientY-o.top,document.body.style.userSelect="none"},z=e=>{if(!s.modal.isDragging)return;let t=s.modal.modal,o=e.clientX-s.modal.offsetX,n=e.clientY-s.modal.offsetY;t.style.left=o+"px",t.style.top=n+"px",t.style.transform="none"},G=()=>{s.modal.isDragging=!1,document.body.style.userSelect=""};var mt={loadingText:"Loading...",completedText:"Completed!",completedTextDuration:2e3,disabled:!1,disableCompletedState:!1},R=e=>{e={...mt,...e};let t=async()=>{let i=a.innerHTML,r=e.onClick(e.message,s.modal);if(r instanceof Promise){let l=m("span","spinner",[m("span","dot top"),m("span","dot right"),m("span","dot bottom"),m("span","dot left")]);o.innerHTML="",o.appendChild(l),n.innerHTML=e.loadingText||"",await r}e.disableCompletedState||(o.innerHTML=be,n.innerHTML=e.completedText||p("modai.ui.completed"),await new Promise(l=>setTimeout(l,2e3))),a.innerHTML=i},o=e.icon;o.ariaHidden="true";let n=m("div",void 0,e.label),a=w([o,n],t,"action-button",{ariaLabel:e.label,tabIndex:0});return e.disabled&&a.disable(),a};var Pe=()=>{let e=m("div","scrollToBottomContainer",[w([m("div",void 0,p("modai.ui.scroll_to_bottom")),v(14,we)],()=>{X(),J()})]);return s.modal.chatContainer.addEventListener("scroll",()=>{J()}),new MutationObserver(()=>{J()}).observe(s.modal.chatContainer,{childList:!0,subtree:!0}),s.modal.scrollWrapper=e,e},J=()=>{let t=s.modal.chatContainer.scrollHeight-s.modal.chatContainer.scrollTop-s.modal.chatContainer.clientHeight<10;s.modal.chatContainer.scrollHeight>s.modal.chatContainer.clientHeight&&!t?s.modal.scrollWrapper.style.display="flex":s.modal.scrollWrapper.style.display="none"};var ut=`
    html {
        width: 100%;
        max-width: 100%;
        padding: 0;
        margin: 0;
    }
    body {
        background-color: #F1F1F2;
        margin: 0;
        padding: 0;
        font-family: Arial, sans-serif;
        overflow-x: hidden;
        width: 100%;
        max-width: 100%;
        box-sizing: border-box;
    }
    * {
        box-sizing: border-box;
        max-width: 100%;
    }
    pre {
        white-space: pre-wrap;
        word-wrap: break-word;
        overflow-wrap: break-word;
        max-width: 100%;
        padding: 12px;
        margin: 0;
        background-color: #f5f7fa;
        border-radius: 5px;
        font-size: 14px;
    }
    img {
        max-width: 100%;
        height: auto;
        display: block;
    }
    code {
        white-space: pre-wrap;
        word-wrap: break-word;
        max-width: 100%;
        display: block;
        overflow-x: hidden;
        font-size: 14px;
    }
    table {
        width: 100%;
        max-width: 100%;
        overflow-x: hidden;
        display: block;
        border-collapse: collapse;
    }
    div {
        max-width: 100%;
        overflow-wrap: break-word;
        word-wrap: break-word;
        box-sizing: border-box;
    }
    p {
        margin: 0 0 0.5em 0;
        max-width: 100%;
    }
    h1, h2, h3, h4, h5, h6 {
        margin: 0 0 0.1em 0;
        max-width: 100%;
    }
`,Oe=(e,t=[])=>{let o=m("div");o.updateContent=r=>{n.innerHTML=U(r),J()};let n=m("div");n.innerHTML=U(e);let a=o.attachShadow({mode:"open"}),i=m("style");return i.textContent=ut,a.appendChild(i),t.forEach(r=>{a.appendChild(m("link",void 0,"",{rel:"stylesheet",type:"text/css",href:r}))}),a.append(n),o};var gt=e=>{let t=m("div","message user"),o=e.content,n=[];for(let r of e.attachments??[])r.__type==="image"&&n.push(r.value);let a=m("div");if(a.innerHTML=U(o),t.appendChild(a),n){let r=m("div","imageRow");for(let l of n){let d=m("div"),u=m("img");u.src=l,d.appendChild(u),r.appendChild(d)}t.appendChild(r)}let i=m("div","actions");return i.appendChild(R({message:e,disabled:s.modal.isLoading,icon:v(14,se),label:p("modai.ui.copy"),completedText:p("modai.ui.copied"),onClick:pe})),i.appendChild(R({message:e,disabled:s.modal.isLoading,disableCompletedState:!0,icon:v(14,Ce),label:p("modai.ui.edit"),onClick:r=>{q({title:p("modai.ui.confirm_edit"),content:p("modai.ui.confirm_edit_content"),confirmText:p("modai.ui.edit_message"),onConfirm:()=>{s.modal.messageInput.setValue(r.content),r.contexts&&r.contexts.forEach(l=>{s.modal.context.addContext(l)}),r.attachments&&r.attachments.forEach(l=>{l.__type==="image"&&s.modal.attachments.addImageAttachment(l.value)}),s.modal.history.clearHistoryFrom(r.id),s.modal.history.getMessages().length===0&&(s.modal.welcomeMessage.style.display="block")}})}})),t.appendChild(i),t.update=r=>{let l=Array.isArray(r.content)?r.content[0].value:r.content;a.innerHTML=U(l)},s.modal.chatMessages.appendChild(t),t},I=e=>{s.modal.welcomeMessage.style.display="none";let t=m("div","message error");t.appendChild(v(14,Se));let o=m("span");return o.textContent=e,t.appendChild(o),s.modal.chatMessages.appendChild(t),t},ht=(e,t)=>{let o=m("div","message ai");o.dataset.id=e.id;let n=Array.isArray(e.content)?e.content[0].value:e.content;e.contentType==="image"&&(n=`<img src="${n}" />`);let a=Oe(n,t.customCSS??[]);o.appendChild(a);let i=m("div","actions");if(t.type==="text"&&(t.textActions?.copy!==!1&&i.appendChild(R({message:e,disabled:s.modal.isLoading,icon:v(14,se),label:p("modai.ui.copy"),completedText:p("modai.ui.copied"),onClick:typeof t.textActions?.copy=="function"?t.textActions.copy:pe})),typeof t.textActions?.insert=="function"&&i.append(R({message:e,disabled:s.modal.isLoading,icon:v(14,de),label:p("modai.ui.insert"),completedText:p("modai.ui.inserted"),onClick:t.textActions.insert}))),t.type==="image"){t.imageActions?.copy!==!1&&i.append(R({message:e,disabled:s.modal.isLoading,icon:v(14,se),label:p("modai.ui.copy"),loadingText:p("modai.ui.downloading"),completedText:p("modai.ui.copied"),onClick:async(l,d)=>{let u=typeof t.textActions?.copy=="function"?t.textActions.copy:pe;if(l.ctx.downloaded===!0){u(l,d);return}let c=await S.mgr.download.image({url:l.content,field:t.field,namespace:t.namespace,resource:t.resource,mediaSource:t.image?.mediaSource});l.content=c.fullUrl,l.ctx.downloaded=!0,l.ctx.url=c.url,l.ctx.fullUrl=c.fullUrl,u(l,d)}}));let r=t.imageActions?.insert;typeof r=="function"&&i.append(R({message:e,disabled:s.modal.isLoading,icon:v(14,de),label:p("modai.ui.insert"),completedText:p("modai.ui.inserted"),loadingText:p("modai.ui.downloading"),onClick:async(l,d)=>{if(l.ctx.downloaded===!0){r(l,d);return}let u=await S.mgr.download.image({url:l.content,field:t.field,namespace:t.namespace,resource:t.resource,mediaSource:t.image?.mediaSource});l.content=u.fullUrl,l.ctx.downloaded=!0,l.ctx.url=u.url,l.ctx.fullUrl=u.fullUrl,r(l,d)}}))}return o.appendChild(i),s.modal.chatMessages.appendChild(o),o.update=r=>{let l=Array.isArray(r.content)?r.content[0].value:r.content,d=r.contentType==="image"?`<img src="${l}" />`:U(l);a.updateContent(d)},o},re=(e,t)=>{if(!e.hidden){if(e.__type==="UserMessage"){let o=gt(e);return o.scrollIntoView({behavior:"smooth",block:"start"}),o}if(e.__type==="AssistantMessage")return ht(e,t)}},pe=async e=>{if(e.content)if(navigator.clipboard&&navigator.clipboard.writeText)try{await navigator.clipboard.writeText(e.content)}catch{I(p("modai.error.failed_copy"))}else try{let t=m("textarea");t.value=e.content,document.body.appendChild(t),t.select(),document.execCommand("copy"),document.body.removeChild(t)}catch{I(p("modai.error.failed_copy"))}};var Y=e=>{s.modal.isLoading=e,e?s.modal.loadingIndicator.style.display="flex":s.modal.loadingIndicator.style.display="none",s.modal.messageInput.disabled=e,e?(s.modal.sendBtn.disable(),s.modal.stopBtn.enable(),s.modal.closeModalBtn.disable()):(s.modal.sendBtn.disable(),s.modal.stopBtn.disable(),s.modal.closeModalBtn.enable()),s.modal.modeButtons.forEach(n=>{e?n.disable():n.enable()});let t=s.modal.history.getMessages().length>0;s.modal.actionButtons.forEach(n=>{e||!t?n.disable():n.enable()}),s.modal.chatMessages.querySelectorAll(".action-button").forEach(n=>{e?n.disable?.():n?.enable?.()})};var Q=()=>{s.modal.isLoading||(document.removeEventListener("mousemove",e=>z(e)),document.removeEventListener("mouseup",()=>G()),s.modal&&s.modal.remove(),s.modalOpen=!1)},Ne=async(e,t,o,n)=>{s.modal.history.addAssistantMessage(crypto.randomUUID(),void 0,t,"text",!0);let a=await S.mgr.tools.run({toolCalls:t,agent:o},n);s.modal.history.addToolResponseMessage(a.id,a.content,!0);let i=await S.mgr.prompt.chat({namespace:e.namespace,agent:o,field:e.field||"",prompt:"",messages:s.modal.history.getMessagesHistory()},r=>{(r.__type==="TextDataNoTools"||r.__type==="TextDataMaybeTools")&&s.modal.history.updateAssistantMessage(r.id,r.content)},n);i.content&&s.modal.history.updateAssistantMessage(i.id,i.content),i.toolCalls&&await Ne(e,i.toolCalls,o,s.modal.abortController)},P=async(e,t,o)=>{let n=t?t.trim():s.modal.messageInput.value.trim();if(!n||s.modal.isLoading)return;Y(!0),s.modal.messageInput.value="",s.modal.messageInput.style.height="auto",s.modal.abortController=new AbortController,s.modal.welcomeMessage.style.display="none";let a=s.modal.attachments.attachments.length>0?s.modal.attachments.attachments.map(l=>({__type:l.__type,value:l.value})):void 0,i=s.modal.context.contexts.length>0?s.modal.context.contexts.map(l=>({__type:l.__type,name:l.name,renderer:l.renderer,value:l.value})):[];s.modal.attachments.removeAttachments(),s.modal.context.removeContexts();let r=s.modal.history.getMessagesHistory();s.modal.history.addUserMessage({content:n,attachments:a,contexts:i},o),s.modal.selectedAgent&&s.modal.selectedAgent.contextProviders&&s.modal.selectedAgent.contextProviders.length>0&&(await S.mgr.context.get({prompt:n,agent:s.modal.selectedAgent.name})).contexts.map(d=>{i.push({__type:"ContextProvider",name:"ContextProvider",renderer:void 0,value:d})});try{if(e.type==="text"){let l=await S.mgr.prompt.chat({agent:s.modal.selectedAgent?.name,namespace:e.namespace,contexts:i,attachments:a,prompt:n,field:e.field||"",messages:r},d=>{d.content&&s.modal.history.updateAssistantMessage(d.id,d.content)},s.modal.abortController);l.content&&s.modal.history.updateAssistantMessage(l.id,l.content),l.toolCalls&&await Ne(e,l.toolCalls,s.modal.selectedAgent?.name,s.modal.abortController)}if(e.type==="image"){let l=await S.mgr.prompt.image({prompt:n},s.modal.abortController);s.modal.history.addAssistantMessage(l.id,l.url,void 0,"image")}s.modal.abortController=void 0}catch(l){if(l instanceof Error){if(l.name==="AbortError")return;Y(!1),I(l.message);return}I(p("modai.error.unknown_error"))}Y(!1),s.modal.messageInput.focus()},je=()=>{!s.modal.isLoading||!s.modal.abortController||(s.modal.abortController.abort(),s.modal.abortController=void 0,Y(!1))},Fe=e=>{if(s.modal.history.getMessages().length!==0){if(e.type==="text"){P(e,"Try again");return}if(e.type==="image"){let t=s.modal.history.getMessages().reverse().find(o=>o.role==="user");t&&P(e,t.content)}}},me=(e,t)=>{for(t.type=e,s.modal.history=O.init(`${t.key}/${t.type}`,n=>re(n,t));s.modal.chatMessages.firstChild;)s.modal.chatMessages.removeChild(s.modal.chatMessages.firstChild);let o=s.modal.history.getMessages().filter(n=>!n.hidden);o.length>0?(s.modal.welcomeMessage.style.display="none",o.forEach(n=>{n.el&&s.modal.chatMessages.appendChild(n.el)}),s.modal.actionButtons.forEach(n=>{n.enable()})):(s.modal.welcomeMessage.style.display="block",s.modal.actionButtons.forEach(n=>{n.disable()})),X()},$e=()=>{s.modal.history.clearHistory(),s.modal.chatMessages.innerHTML="",s.modal.welcomeMessage.style.display="block",s.modal.actionButtons.forEach(e=>{e.disable()})},Z=async(e,t=!1)=>{if(!t&&e instanceof File&&!e.type.startsWith("image/")){I(p("modai.error.only_image_files_are_allowed"));return}if(t){s.modal.attachments.addImageAttachment(e);return}let o=await new Promise((n,a)=>{let i=new FileReader;i.onload=function(r){n(r.target?.result)},i.onerror=function(r){a(r)},i.readAsDataURL(e)});s.modal.attachments.addImageAttachment(o)},X=()=>{s.modal.chatContainer.scrollTop=s.modal.chatContainer.scrollHeight};var Ve=()=>{let e=m("div","chatContainer","",{ariaLive:"polite"}),t=m("div","welcome",[m("p","greeting",s.config.name?p("modai.ui.greeting_with_name",{name:s.config.name}):p("modai.ui.greeting")),m("p","msg",p("modai.ui.welcome_msg"))]);e.append(t);let o=m("div","history","",{ariaLabel:p("modai.ui.conversation_history")});return e.append(o),s.modal.welcomeMessage=t,s.modal.chatMessages=o,s.modal.chatContainer=e,e};var We=()=>{let e=w(v(24,Le),()=>{Q()},"closeBtn",{ariaLabel:p("modai.ui.close_dialog")}),t=m("header","header",[m("h1","",p("modai.ui.modai_assistant")),e]);return t.addEventListener("mousedown",o=>{Re(o),document.addEventListener("mousemove",z),document.addEventListener("mouseup",()=>{G(),document.removeEventListener("mousemove",z),document.removeEventListener("mouseup",G)})}),document.addEventListener("keydown",o=>{o.key==="Escape"&&(o.preventDefault(),Q())}),s.modal.closeModalBtn=e,t};var qe=()=>{let e=m("div","attachmentsWrapper");return e.visible=!1,e.attachments=[],e.show=()=>{e.visible||(e.visible=!0,b(e,"attachmentsWrapper visible"))},e.hide=()=>{e.visible&&(e.visible=!1,b(e,"attachmentsWrapper"))},e.addImageAttachment=t=>{ft(t)},e.removeAttachments=()=>{s.modal.attachments.attachments.forEach(t=>{s.modal.attachments.removeAttachment(t)})},e.addAttachment=t=>{e.show(),e.appendChild(t),e.attachments.push(t)},e.removeAttachment=t=>{let o=e.attachments.indexOf(t);o!==-1&&(t.remove(),e.attachments.splice(o,1),e.attachments.length===0&&e.hide())},s.modal.attachments=e,e},ft=e=>{s.modal.attachments.attachments.length>0&&s.modal.attachments.removeAttachments();let t=m("div","imagePreview");t.__type="image",t.value=e;let o=m("img",void 0,"",{src:e}),n=m("button",void 0,"\xD7");n.addEventListener("click",a=>{a.stopPropagation(),s.modal.attachments.removeAttachment(t)}),t.append(o,n),s.modal.attachments.addAttachment(t)};var yt={selection:void 0},Ke=()=>{let e=m("div","contextsWrapper");return e.visible=!1,e.contexts=[],e.show=()=>{e.visible||(e.visible=!0,b(e,"contextsWrapper visible"))},e.hide=()=>{e.visible&&(e.visible=!1,b(e,"contextsWrapper"))},e.removeContexts=()=>{s.modal.context.contexts.forEach(t=>{s.modal.context.removeContext(t)})},e.addContexts=t=>{t.forEach(o=>{s.modal.context.addContext(o)})},e.addContext=t=>{let o=e.contexts.push(t),n=yt[t?.renderer||""];if(n){e.show();let a=n();e.contexts[o].el=a,e.appendChild(a)}},e.removeContext=t=>{let o=e.contexts.indexOf(t);o!==-1&&(t.el?.remove(),e.contexts.splice(o,1),(e.contexts.length===0||e.contexts.every(n=>n.el===void 0))&&e.hide())},s.modal.context=e,e};var ze=(e,t,o,n)=>{let a=n?.idProperty??"id",i=n?.displayProperty??"name",r={idProperty:a,displayProperty:i,noSelectionText:n?.noSelectionText??"",selectText:n?.selectText??p("modai.ui.select_item"),icon:n?.icon,iconSize:n?.iconSize??24,nullOptionDisplayText:n?.nullOptionDisplayText},l=m("div","selectContainer"),d=null;t!=null&&(d=e[t]||null);let u=!1,c=-1,h=[null,...Object.values(e)],g=m("button","selectButton",[],{type:"button",ariaHasPopup:"listbox",ariaExpanded:"false",ariaLabel:r.selectText}),T=()=>{let y=[],C;if(r.icon&&y.push(v(r.iconSize,r.icon)),d){let L=String(d[r.displayProperty]);y.push(m("span","selectedItemName",L)),C=L}else C=r.noSelectionText||p("modai.ui.no_selection");g.innerHTML="",g.append(...y),g.setAttribute("aria-label",C)},f=m("ul","selectDropdown",[],{role:"listbox",tabIndex:-1,ariaHidden:"true"});f.classList.add("hidden");let x=h.map((y,C)=>{let L;y===null?L=r.nullOptionDisplayText??r.noSelectionText:L=String(y[r.displayProperty]);let $=y&&d&&y[r.idProperty]===d[r.idProperty]||!y&&!d,V=m("li","selectOption",L,{role:"option",id:`select-option-${C}`,ariaSelected:$?"true":"false",tabIndex:-1});return V.addEventListener("click",()=>{F(y),E()}),V.addEventListener("keydown",B=>{if(u)switch(B.key){case"ArrowDown":B.preventDefault(),D((C+1)%x.length);break;case"ArrowUp":B.preventDefault(),D((C-1+x.length)%x.length);break;case"Enter":case" ":B.preventDefault(),F(y),E();break;case"Escape":B.preventDefault(),B.stopPropagation(),E();break;case"Tab":E();break;case"Home":B.preventDefault(),D(0);break;case"End":B.preventDefault(),D(x.length-1);break;default:break}}),V});f.append(...x);let M=()=>{u||(u=!0,f.classList.remove("hidden"),f.setAttribute("aria-hidden","false"),g.setAttribute("aria-expanded","true"),c=h.findIndex(y=>y&&d&&y[r.idProperty]===d[r.idProperty]||!y&&!d),c===-1&&(c=0),D(c),document.addEventListener("click",ie,!0))},E=()=>{u&&(u=!1,f.classList.add("hidden"),f.setAttribute("aria-hidden","true"),g.setAttribute("aria-expanded","false"),g.focus(),c=-1,document.removeEventListener("click",ie,!0))},F=y=>{d=y,T(),x.forEach((C,L)=>{let $=h[L],V=$&&d&&$[r.idProperty]===d[r.idProperty]||!$&&!d;C.setAttribute("aria-selected",V?"true":"false")}),o(d)},D=y=>{if(y<0||y>=x.length)return;x.forEach(L=>{L.classList.remove("focused"),L.tabIndex=-1});let C=x[y];C.tabIndex=0,C.classList.add("focused"),C.scrollIntoView({block:"nearest"}),C.focus(),f.setAttribute("aria-activedescendant",C.id),c=y},ie=y=>{l.contains(y.target)||E()};return g.addEventListener("click",y=>{if(y.stopPropagation(),u){E();return}M()}),g.addEventListener("keydown",y=>{switch(y.key){case"Enter":case" ":case"ArrowDown":y.preventDefault(),M();break;case"ArrowUp":y.preventDefault(),M(),D(x.length-1);break;case"Escape":u&&(y.stopImmediatePropagation(),y.stopPropagation(),y.preventDefault(),E());break}}),T(),l.append(g,f),l};var Ge=e=>{let t=m("div","inputContainer"),o=m("div","inputSection"),n=m("div","inputWrapper"),a=m("textarea","","",{placeholder:p("modai.ui.prompt_placeholder"),rows:1,ariaLabel:p("modai.ui.prompt_label")});a.setValue=f=>{a.value=f,a.focus(),f.trim()!==""?(r.disabled=!1,b(r,"active")):(r.disabled=!0,b(r,""))};let i=m("div","loadingDots",[m("div","loadingDot"),m("div","loadingDot"),m("div","loadingDot")],{ariaLabel:p("modai.ui.loading_response")}),r=w(v(20,_e),()=>P(e),"",{ariaLabel:p("modai.ui.send_message")});r.disable(),r.enable=()=>{r.disabled=!1,b(r,"active")},r.disable=()=>{r.disabled=!0,b(r,"")};let l=w(v(20,ke),()=>je(),"",{ariaLabel:p("modai.ui.stop_generating_response")});l.disable(),l.enable=()=>{l.disabled=!1,b(l,"active sending")},l.disable=()=>{l.disabled=!0,b(l,"")},n.append(a,i,r,l),o.append(qe(),n),o.append(Ke(),n);let d=[];if(e.availableTypes?.includes("text")){let f=w([v(24,Ee),m("span","tooltip",p("modai.ui.text_mode"))],()=>{e.type!=="text"&&(me("text",e),d.forEach(x=>{b(x,"")}),b(f,"active"))},"",{ariaLabel:p("modai.ui.text_mode")});e.type==="text"&&b(f,"active"),d.push(f)}if(e.availableTypes?.includes("image")){let f=w([v(24,Te),m("span","tooltip",p("modai.ui.image_mode"))],()=>{e.type!=="image"&&(me("image",e),d.forEach(x=>{b(x,"")}),b(f,"active"))},"",{ariaLabel:p("modai.ui.image_mode")});e.type==="image"&&b(f,"active"),d.push(f)}let u=w([v(24,Me),m("span","tooltip",p("modai.ui.retry_last_message"))],()=>{Fe(e)},"",{ariaLabel:p("modai.ui.retry_last_message")});u.disable();let c=w([v(24,De),m("span","tooltip",p("modai.ui.clear_chat"))],()=>{$e()},"",{ariaLabel:p("modai.ui.clear_chat")});c.disable();let h=ze(s.config.availableAgents,s.modal.selectedAgent?.id,f=>{s.modal.selectedAgent=f??void 0},{idProperty:"id",displayProperty:"name",noSelectionText:"",selectText:p("modai.ui.select_agent"),nullOptionDisplayText:p("modai.ui.no_agent"),icon:Be}),g=m("div","options",[...d,u,c,h],{ariaLabel:p("modai.ui.options_toolbar"),role:"toolbar"}),T=Pe();return t.append(T),t.append(o,g),a.addEventListener("keydown",f=>{if(f.key==="Enter"){if(f.shiftKey)return;f.preventDefault(),P(e)}}),a.addEventListener("input",function(){this.style.height="auto",this.style.height=this.scrollHeight+"px",this.value.trim()!==""?(r.disabled=!1,b(r,"active")):(r.disabled=!0,b(r,""))}),o.addEventListener("dragover",f=>{f.preventDefault(),f.stopPropagation(),b(o,"inputSection dragOver")}),o.addEventListener("dragleave",f=>{f.preventDefault(),f.stopPropagation(),b(o,"inputSection")}),o.addEventListener("drop",async f=>{f.preventDefault(),f.stopPropagation(),b(o,"inputSection");let x=null,M=null,E=f.dataTransfer;if(!E)return;let F=E.files;if(F?.length>0){let D=F[0];D.type.startsWith("image/")&&(x=D)}if(!x){let D=E.getData("text/uri-list");D&&(M=D)}if(x){await Z(x);return}if(M){let D=new URL(window.location.href);if(!M.startsWith(D.origin)){await Z(M,!0);return}try{let y=await fetch(M);if(y.ok){let C=await y.blob();if(C.type.startsWith("image/")){let L=new File([C],"image.png",{type:C.type});await Z(L)}}}catch{I(p("modai.error.failed_to_fetch_image"))}return}I(p("modai.error.only_image_files_are_allowed"))}),a.addEventListener("paste",async f=>{let x=f.clipboardData?.items;if(x){for(let M=0;M<x.length;M++)if(x[M].type.indexOf("image")!==-1){let E=x[M].getAsFile();if(E){f.preventDefault(),await Z(E);break}}}}),s.modal.loadingIndicator=i,s.modal.messageInput=a,s.modal.sendBtn=r,s.modal.stopBtn=l,s.modal.modeButtons=d,s.modal.actionButtons=[u,c],t};var Je=e=>{let{shadow:t,shadowRoot:o}=j(!0,()=>{X(),t.messageInput.focus()}),n=m("div","modai--root chat-modal","",{ariaLabel:p("modai.ui.modai_assistant_chat_dialog")});t.modal=n,s.modal=t,t.history=O.init(`${e.key}/${e.type}`,r=>re(r,e)),n.append(We()),n.append(Ve()),n.append(Ge(e));let a=m("div","disclaimer",p("modai.ui.disclaimer"));n.append(a),o.appendChild(n),document.body.append(t),t.isDragging=!1,t.isLoading=!1,t.abortController=void 0,t.offsetX=0,t.offsetY=0;let i=t.history.getMessages().filter(r=>!r.hidden);return i.length>0&&(t.welcomeMessage.style.display="none",t.actionButtons.forEach(r=>{r.enable()}),i.forEach(r=>{r.el&&t.chatMessages.appendChild(r.el)})),t};var xt=["text","image"],Xe=e=>{if(s.modalOpen)return;if(e.context&&(e.withContexts||(e.withContexts=[]),e.withContexts.push({__type:"selection",name:"Selection",renderer:"selection",value:e.context}),e.context=void 0),!e.key){alert(p("modai.error.key_required"));return}e.type||(e.type="text"),e.availableTypes||(e.availableTypes=[e.type]),e.availableTypes=e.availableTypes.filter(o=>xt.includes(o)),e.availableTypes.length>0&&!e.availableTypes.includes(e.type)&&e.availableTypes.unshift(e.type);let t=Je(e);return t.api={sendMessage:async(o,n)=>{await P(e,o,n)},closeModal:()=>{Q()}},e.withContexts&&s.modal.context.addContexts(e.withContexts),s.modalOpen=!0,t};var H={createLoadingOverlay:K,localChat:Xe,generateButton:Ue};var vt=(e,t)=>{let o=Ext.getCmp(e.firstElementChild?.id),n=o.el.dom.parentElement?.parentElement?.parentElement?.querySelector("label");if(!n)return;H.generateButton.localChat({targetEl:n,key:t,field:t,type:"image",resource:MODx.request.id,image:{mediaSource:o.imageBrowser.source},imageActions:{insert:(i,r)=>{o.imageBrowser.setValue(i.ctx.url),o.onImageChange(i.ctx.url),r.api.closeModal()}}});let a=H.generateButton.vision({targetEl:o.altTextField.el.dom,input:o.altTextField.items.items[0].el.dom,field:t,image:o.imagePreview.el.dom,onUpdate:i=>{o.altTextField.items.items[0].setValue(i.content),o.image.altTag=i.content,o.updateValue()}});a.style.marginTop="6px",o.altTextField.el.dom.style.display="flex",o.altTextField.el.dom.style.justifyItems="center",o.altTextField.el.dom.style.alignItems="center"},bt=()=>{let t=Ext.getCmp("modx-resource-content").el.dom.querySelector("label");t&&H.generateButton.localChat({targetEl:t,key:"res.content",field:"res.content",type:"text",availableTypes:["text","image"],resource:MODx.request.id})},wt=e=>{let t=Ext.getCmp("modx-panel-resource").getForm();for(let[o,n]of e.tvs||[]){let a=Ext.get(`tv${o}-tr`);if(!a)continue;let i=t.findField(`tv${o}`),r=`tv.${n}`;if(!i){let l=a.dom.querySelector(".imageplus-panel-input");l&&vt(l,r);continue}if(i.xtype==="textfield"||i.xtype==="textarea"){let l=MODx.config[`modai.tv.${n}.text.prompt`],d=a.dom.querySelector("label");if(!d)return;l?H.generateButton.forcedText({targetEl:d,input:i.el.dom,resourceId:MODx.request.id,field:r,initialValue:i.getValue(),onChange:(u,c)=>{let h=i.getValue();i.setValue(u.value),i.fireEvent("change",i,u.value,h),c&&(i.el.dom.scrollTop=i.el.dom.scrollHeight)}}):H.generateButton.localChat({targetEl:d,key:r,field:r,type:"text",availableTypes:["text","image"],resource:MODx.request.id})}if(i.xtype==="modx-panel-tv-image"){let l=a.dom.querySelector("label");if(!l)return;H.generateButton.localChat({targetEl:l,key:r,field:r,type:"image",resource:MODx.request.id,image:{mediaSource:i.source},imageActions:{insert:(d,u)=>{let c={relativeUrl:d.ctx.url,url:d.ctx.url};i.items.items[1].fireEvent("select",c),i.fireEvent("select",c),u.api.closeModal()}}})}}},Ct=e=>{let t={pagetitle:["modx-resource-pagetitle"],longtitle:["modx-resource-longtitle","seosuite-longtitle"],introtext:["modx-resource-introtext"],description:["modx-resource-description","seosuite-description"],content:["modx-resource-content"]};for(let o of e.resourceFields||[])if(t[o]){if(o==="content"){bt();continue}t[o].forEach(n=>{let a=Ext.getCmp(n);a&&H.generateButton.forcedText({targetEl:a.label,resourceId:MODx.request.id,field:`res.${o}`,input:a.el.dom,initialValue:a.getValue(),onChange:(i,r)=>{let l=a.getValue();a.setValue(i.value),a.fireEvent("change",a,i.value,l),r&&(a.el.dom.scrollTop=a.el.dom.scrollHeight)}})})}},Ye=e=>{Ct(e),wt(e)};var Tt=e=>(s.config=e,{chatHistory:O,history:ae,executor:S,ui:H,lng:p,initOnResource:Ye});return nt(Mt);})();
